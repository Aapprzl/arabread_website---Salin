rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
  
  
  
     // ğŸ“š E-BOOK PUBLIK (READ ONLY)
    match /ebooks/{ebookId} {
      allow read: if true;
      allow write: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";
    }
  
 

    /* =========================
       USERS
    ========================== */
    match /users/{userId} {

  // =========================
  // READ
  // =========================

  // ğŸ‘¨â€ğŸ« Guru boleh baca semua
  allow read: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

  // ğŸ‘¨â€ğŸ“ Siswa boleh:
  // - baca data sendiri
  // - baca data siswa lain (UNTUK RANKING SAJA)
  allow read: if request.auth != null
    && (
      request.auth.uid == userId
      || resource.data.role == "student"
    );

  // =========================
  // WRITE
  // =========================

  // CREATE (login pertama)
  allow create: if request.auth != null;

  // ğŸ‘¨â€ğŸ« Guru update bebas (reset poin)
  allow update: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

 // ğŸ‘¨â€ğŸ“ Siswa update TERBATAS
	allow update: if request.auth != null
  	&& request.auth.uid == userId
  	&& request.resource.data.diff(resource.data).changedKeys()
     .hasOnly([
  		"poin",
  		"poinTotal",
  		"jumlahMain",
  		"skorTerbaik",
  		"mustChangePassword"
			]);


  // âŒ Delete hanya guru
  allow delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

}

// â¬‡ï¸ IZINKAN QUERY USERS UNTUK RANKING
match /users {
  allow list, read: if request.auth != null;
}



    /* =========================
       SUBMISSIONS (TUGAS)
    ========================== */
    match /submissions/{docId} {

      // ğŸ§‘ Siswa kirim tugas
      allow create: if request.auth != null;

      // ğŸ‘¨â€ğŸ« Guru baca & hapus
      allow read, delete: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

      // âŒ Tidak boleh edit
      allow update: if false;
    }
    
 /* ===============================
   QUIZ RESULTS (FINAL)
================================ */
match /quizResults/{docId} {

  // ğŸ§‘â€ğŸ“ Siswa: simpan hasil kuis sendiri
  allow create: if request.auth != null
    && request.resource.data.uid == request.auth.uid;

  // ğŸ§‘â€ğŸ“ Siswa: baca hasil miliknya (DOC READ)
  allow read: if request.auth != null
    && resource.data.uid == request.auth.uid;

  // ğŸ§‘â€ğŸ“ Siswa: IZINKAN QUERY hasil miliknya
  allow list: if request.auth != null;

  // ğŸ‘¨â€ğŸ« Guru: baca SEMUA hasil
  allow read: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

  // ğŸ‘¨â€ğŸ« Guru: hapus
  allow delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";

  allow update: if false;
}

// ================================
// LEADERBOARD (FINAL & AMAN)
// ================================
match /leaderboard/{userId} {

  // semua user login boleh baca ranking
  allow read, list: if request.auth != null;

  // siswa update leaderboard miliknya
  allow create, update: if request.auth != null
    && request.auth.uid == userId;

  // guru boleh update & delete leaderboard
  allow update, delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "guru";
}


match /ebooks/{ebookId} {

  // semua user login boleh membaca ebook
  allow read: if request.auth != null;

  // hanya guru boleh upload / edit / hapus ebook
  allow write: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid))
         .data.role == "guru";
}


// ===============================
// LEARNING SESSIONS (MODUL AJAR)
// ===============================
match /learningSessions/{sessionId} {

  // ğŸ‘¨â€ğŸ« Guru: full akses
  allow read, create, update, delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid))
       .data.role == "guru";

  // ğŸ‘¨â€ğŸ“ Siswa: READ ONLY
  allow read: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid))
       .data.role == "student";
}


// =========================
// DISCUSSIONS (CHAT GLOBAL)
// =========================
match /discussions/{discussionId} {

  // ğŸ”¥ WAJIB untuk onSnapshot(query)
  allow get, list: if request.auth != null;

  // Kirim pesan
  allow create: if request.auth != null
    && request.resource.data.authorUid == request.auth.uid
    && request.resource.data.keys().hasAll([
      "authorUid",
      "authorName",
      "authorRole",
      "content",
      "createdAt"
    ]);

  // Tidak boleh edit
  allow update: if false;

  // Hanya guru boleh hapus
  allow delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid))
         .data.role == "guru";
}




// COMMENTS (BALASAN / THREAD)

match /discussions/{discussionId}/comments/{commentId} {

  allow get, list: if request.auth != null;

  allow create: if request.auth != null
    && request.resource.data.uid == request.auth.uid
    && request.resource.data.keys().hasAll([
      "uid",
      "name",
      "role",
      "text",
      "createdAt"
    ]);

  allow update: if false;

  allow delete: if request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid))
         .data.role == "guru";
}


    // =====================
    // USERS
    // =====================
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }


		// =========================
  // UNTUK KOTAL SURAT
  // =========================
  match /announcements/{announcementId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null; // Idealnya hanya guru
}

match /users/{userId}/readAnnouncements/{announcementId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}

    
  }
}
