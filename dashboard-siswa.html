<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Siswa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {}
  }
}
</script>


</head>

<body class="bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100">

<!-- ================= HEADER ================= -->
<header class="bg-blue-600 text-white shadow">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="font-bold text-lg">ğŸ“ Dashboard Siswa</h1>
    <a href="index.html"
       class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
      â¬… Beranda
    </a>
      <button
  id="darkToggle"
  class="ml-3 px-3 py-2 rounded-lg bg-white/20 text-white hover:bg-white/30 transition"
  title="Toggle Dark Mode"
>
  ğŸŒ™
</button>
  </div>

</header>


<main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">

<!-- ================= LOGIN SISWA ================= -->
<section id="login-section" class="max-w-md mx-auto">
  <article class="bg-white rounded-2xl shadow-lg overflow-hidden dark:bg-slate-600">

    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-6 text-center">
      <h2 class="text-2xl font-bold">ğŸ” Login Siswa</h2>
      <p class="text-sm text-blue-100 mt-1">
        Masuk ke Dashboard Siswa
      </p>
    </div>

    <div class="p-6 space-y-4">
      <input id="email"
             type="email"
             placeholder="Email Siswa"
             class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100
         border-slate-300 dark:border-slate-600
         focus:outline-none focus:ring-2 focus:ring-blue-500">

      <input id="password"
             type="password"
             placeholder="Password"
             class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100
         border-slate-300 dark:border-slate-600
         focus:outline-none focus:ring-2 focus:ring-blue-500">

      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
        ğŸ”“ Masuk
      </button>

      <p id="error"
         class="text-sm text-center text-red-500 hidden">
        Login gagal
      </p>
    </div>

  </article>
</section>

<!-- ================= DASHBOARD SISWA ================= -->
<section id="dashboard-section" class="hidden">

  <div class="grid grid-cols-1 md:grid-cols-10 gap-6">

    <!-- ===== IDENTITAS ===== -->
    <aside class="md:col-span-3 space-y-4">

      <div class="bg-white rounded-xl shadow p-5 dark:bg-slate-700">
        <h2 class="font-bold text-lg mb-3">ğŸ‘¤ Identitas Siswa</h2>

        <div class="space-y-2 text-sm">
          <p><b>Nama:</b> <span id="nama">-</span></p>
          <p><b>NISN:</b> <span id="nisn">-</span></p>
          <p><b>Kelas:</b> <span id="kelas">-</span></p>
          <p><b>Gender:</b> <span id="gender">-</span></p>
          <p>
            <b>Status:</b>
            <span class="inline-flex items-center gap-2 text-green-600 font-semibold">
              <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
              Online
            </span>
          </p>
        </div>
      </div>

      <button id="btnLogout"
              class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-semibold">
        ğŸšª Logout
      </button>


      <!-- ================= RANKING SISWA (SIDEBAR) ================= -->
<div class="mt-4 bg-slate-700 rounded-xl p-4 text-sm">
  <h3 class="font-bold mb-3 flex items-center gap-2">
    ğŸ† Ranking Siswa
  </h3>

  <!-- TOP 3 -->
  <div id="top3Ranking" class="space-y-1 mb-3 max-h-28 overflow-y-auto">
    <span class="text-xs text-slate-300">Memuat ranking...</span>
  </div>

  <hr class="my-3 border-slate-600">

  <!-- POSISI PRIBADI -->
  <div id="myRanking" class="text-slate-300">
    Memuat peringkat kamu...
  </div>
</div>


    </aside>


    <!-- ===== KONTEN ===== -->
    <section class="md:col-span-7">
      <div class="bg-white rounded-xl shadow p-6 dark:bg-slate-700">
        <h2 class="font-bold text-lg mb-3">ğŸ® Area Game & Kuis</h2>

        <!-- ================= KUIS TA'ARUF ================= -->
<section class="mt-6">
  <div class="bg-white dark:bg-slate-600 rounded-xl shadow p-6">
    <h2 class="font-bold text-lg mb-3">ğŸ“ Kuis</h2>

    <div class="mt-4">
  <p class="text-sm font-semibold mb-2 text-slate-600 dark:text-slate-300">
    Pilih Tema:
  </p>

  <div class="flex flex-wrap gap-3">

    <button
      id="btnThemeTaaruf"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
  â–¶     Taâ€™aruf
    </button>

    <button
      id="btnThemeSekolah"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
         â–¶ Mulai Tema Sekolah
      </button>
  </div>
</div>



    <p id="quizBestScore" class="text-sm text-blue-400 mt-1">
      Skor terbaik: -
    </p>

    <p id="quizAttempts" class="text-xs text-slate-400">
      Sudah mengerjakan: -
    </p>


    <div id="quizBox" class="mt-6 hidden">
      <p id="quizQuestion" class="font-semibold mb-4"></p>

      <div id="quizOptions" class="space-y-2"></div>

      <p id="quizFeedback" class="mt-4 font-semibold"></p>

      <button
        id="nextQuestion"
        class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg hidden"
      >
        Soal Berikutnya
      </button>
    </div>
  </div>
</section>



</div>
</section>


  </div>

      <!-- ================= KIRIM TUGAS ================= -->
<section class="mt-6">
  <div class="bg-white rounded-xl shadow p-6 dark:bg-slate-600">
    <h2 class="font-bold text-lg mb-4">ğŸ“¤ Kirim Tugas</h2>

    <div class="space-y-4">
      <textarea id="catatanTugas"
        class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100
         border-slate-300 dark:border-slate-600
         focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Catatan tugas (opsional)"></textarea>

      <input type="url"
        id="driveLink"
        class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100
         border-slate-300 dark:border-slate-600
         focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Tempelkan link Google Drive tugas di sini"
        required />

      <button id="btnKirimTugas"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
        ğŸš€ Kirim Tugas
      </button>

      <p id="uploadStatus"
        class="text-sm text-center hidden"></p>
    </div>
  </div>
</section>


</section>
</main>

<footer class="bg-blue-700 text-white text-center py-4 text-sm">
  Â© 2025 Tarbiyyat al-Lughah
</footer>

<!-- DATA SOAL -->
<script src="assets/data/vocabs.js"></script>

<script type="module">
/* ================= FIREBASE IMPORT ================= */
import { initializeApp, getApps } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getDatabase,
  ref,
  set,
  onValue,
  onDisconnect,
  serverTimestamp
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

import {
  addDoc,
  collection,
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";




/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
  authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
  projectId: "tarbiyyat-lughah-presence",
  databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
};


const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);


/* ================= DOM ================= */
const loginSection = document.getElementById("login-section");
const dashSection  = document.getElementById("dashboard-section");

const emailInput = document.getElementById("email");
const passInput  = document.getElementById("password");
const btnLogin   = document.getElementById("btnLogin");
const btnLogout  = document.getElementById("btnLogout");
const errorBox   = document.getElementById("error");

const elNama   = document.getElementById("nama");
const elNisn   = document.getElementById("nisn");
const elKelas  = document.getElementById("kelas");
const elGender = document.getElementById("gender");

let currentUser = null;
let presenceInitialized = false;

let unsubscribeUserSnapshot = null;
let unsubscribeRanking = null;
let statusRefGlobal = null;


/* ================= UI ================= */
function showLogin() {
  loginSection.classList.remove("hidden");
  dashSection.classList.add("hidden");
}

function showDashboard() {
  loginSection.classList.add("hidden");
  dashSection.classList.remove("hidden");
}

function setText(el, val) {
  el.textContent = val || "-";
}

/* ================= LOGIN ================= */
btnLogin.addEventListener("click", async () => {
  errorBox.classList.add("hidden");
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passInput.value.trim()
    );
  } catch {
    errorBox.textContent = "Email atau password salah";
    errorBox.classList.remove("hidden");
  }
});

/* ================= AUTH (FINAL) ================= */
onAuthStateChanged(auth, async (user) => {

  // ================= BELUM LOGIN =================
  if (!user) {
    unsubscribeUserSnapshot?.();
    unsubscribeUserSnapshot = null;

    showLogin();
    return;
  }

  // ================= LOGIN =================
  currentUser = user;

  // ğŸ”¥ PASANG PRESENCE SEKALI SAJA
setupStudentPresence(user.uid);

  // â›” pastikan tidak dobel listener
  unsubscribeUserSnapshot?.();
  unsubscribeUserSnapshot = null;

  const userRef = doc(db, "users", user.uid);

  unsubscribeUserSnapshot = onSnapshot(userRef, async (snap) => {

    // âŒ user dihapus
    if (!snap.exists()) {
      await signOut(auth);
      showLogin();
      return;
    }

    const data = snap.data();

    // âŒ bukan student
    if (data.role !== "student") {
      await signOut(auth);
      showLogin();
      return;
    }

    // ================= RENDER IDENTITAS =================
    renderIdentitas(data);

    // ================= STATUS KUIS (REALTIME) =================
    const elBestScore = document.getElementById("quizBestScore");
    const elAttempts  = document.getElementById("quizAttempts");

    if (elBestScore) {
      elBestScore.textContent =
        `Skor terbaik: ${data.skorTerbaik ?? 0}`;
    }

    if (elAttempts) {
      elAttempts.textContent =
        `Sudah mengerjakan: ${data.jumlahMain ?? 0} kali`;
    }

    // ================= TAMPILKAN DASHBOARD =================
    showDashboard();

    // âš ï¸ aman dipanggil berulang karena hanya read
    loadRankingForStudent();
  });

  // ================= CONTEXT GLOBAL (WAJIB UNTUK KUIS) =================
  window.__APP_CONTEXT__ = {
    db,
    auth,
    getCurrentUser: () => auth.currentUser
  };

  // ================= LOAD KUIS SETELAH AUTH SIAP =================
  const quizModule = await import("./assets/js/quiz-taaruf.js");

  if (quizModule?.initQuiz) {
    quizModule.initQuiz();
  }
});

// ===============================
// PRESENCE SISWA (ANTI FALSE OFFLINE)
// ===============================
function setupStudentPresence(uid) {
  if (presenceInitialized) return; // â›” hanya sekali
  presenceInitialized = true;

  const rtdb = getDatabase();
  const statusRef = ref(rtdb, `status/${uid}`);
  const connectedRef = ref(rtdb, ".info/connected");

  statusRefGlobal = statusRef;

  onValue(connectedRef, (snap) => {
    if (snap.val() === false) return;

    // ğŸ”´ auto-offline saat tab ditutup / koneksi mati
    onDisconnect(statusRef).set({
      state: "offline",
      lastChanged: serverTimestamp()
    });

    // ğŸŸ¢ online
    set(statusRef, {
      state: "online",
      lastChanged: serverTimestamp()
    });
  });
}




/* ================= RENDER ================= */
function renderIdentitas(data) {
  setText(elNama, data.nama);
  setText(elNisn, data.nisn);
  setText(elKelas, data.kelas);
  setText(elGender, data.gender);
}



// /* ================= LOGOUT ================= */
// btnLogout.addEventListener("click", async () => {
//   try {
//     // 1ï¸âƒ£ STOP LISTENER FIRESTORE
//     unsubscribeUserSnapshot?.();
//     unsubscribeRanking?.();

//     unsubscribeUserSnapshot = null;
//     unsubscribeRanking = null;

//     // 2ï¸âƒ£ HENTIKAN QUIZ (kalau ada)
//     window.stopActiveQuiz?.();

//     // ğŸ”´ 3ï¸âƒ£ PAKSA STATUS OFFLINE
//     if (statusRefGlobal) {
//       await set(statusRefGlobal, {
//         state: "offline",
//         lastChanged: Date.now()
//       });
//     }

//     // 4ï¸âƒ£ SIGN OUT AUTH
//     await signOut(auth);

//     showLogin();

//   } catch (err) {
//     console.error("Logout error:", err);
//   }
// });

/* ================= LOGOUT SISWA ================= */
btnLogout.addEventListener("click", async () => {
  try {
    // 1ï¸âƒ£ STOP LISTENER FIRESTORE
    unsubscribeUserSnapshot?.();
    unsubscribeRanking?.();

    unsubscribeUserSnapshot = null;
    unsubscribeRanking = null;

    // 2ï¸âƒ£ HENTIKAN QUIZ (kalau ada)
    window.stopActiveQuiz?.();

    // ğŸ”´ 3ï¸âƒ£ PAKSA OFFLINE (REALTIME DATABASE)
    const user = auth.currentUser;
    if (user) {
      const rtdb = getDatabase();
      const statusRef = ref(rtdb, `status/${user.uid}`);

      await set(statusRef, {
        state: "offline",
        lastChanged: serverTimestamp()
      });
    }

    // ğŸ”‘ RESET STATE PRESENCE (INI TAMBAHAN)
    presenceInitialized = false;
    statusRefGlobal = null;

    // 4ï¸âƒ£ SIGN OUT AUTH
    await signOut(auth);

    showLogin();

  } catch (err) {
    console.error("Logout error:", err);
  }
});






// JS TEMPAT KIRIM TUGAS
const btnKirim = document.getElementById("btnKirimTugas");
const inputCatatan = document.getElementById("catatanTugas");
const inputLink = document.getElementById("driveLink");
const statusBox = document.getElementById("uploadStatus");

btnKirim.addEventListener("click", async () => {
  if (!currentUser) return;

  const link = inputLink.value.trim();
  if (!link.startsWith("http")) {
    alert("Masukkan link Google Drive yang valid");
    return;
  }

  btnKirim.disabled = true;
  statusBox.className = "text-sm text-center text-blue-600";
  statusBox.textContent = "Mengirim tugas...";
  statusBox.classList.remove("hidden");

  try {
    const snapUser = await getDoc(doc(db, "users", currentUser.uid));
    const user = snapUser.data();

    await addDoc(collection(db, "submissions"), {
      uid: currentUser.uid,
      nama: user.nama,
      nisn: user.nisn,
      kelas: user.kelas,
      catatan: inputCatatan.value || "-",
      driveLink: link,
      
      // ğŸ”‘ DUA WAKTU
  createdAt: serverTimestamp(),     // waktu server (utama)
  createdAtClient: Date.now()        // cadangan
    });

    statusBox.className = "text-sm text-center text-green-600";
    statusBox.textContent = "âœ… Tugas berhasil dikirim";

    inputCatatan.value = "";
    inputLink.value = "";
  } catch (err) {
    console.error(err);
    statusBox.className = "text-sm text-center text-red-600";
    statusBox.textContent = "âŒ Gagal mengirim tugas";
  }

  btnKirim.disabled = false;
});


// ================= RANKING SISWA (TOP 3 + POSISI PRIBADI) =================
import {
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

async function loadRankingForStudent() {
  const top3Box = document.getElementById("top3Ranking");
  const myBox   = document.getElementById("myRanking");

  if (!currentUser) {
    myBox.innerHTML = "User belum login";
    return;
  }

  const q = query(
    collection(db, "leaderboard"),
    orderBy("poinTotal", "desc")
  );

  unsubscribeRanking = onSnapshot(q, (snapshot) => {

    const list = [];

    snapshot.forEach(docSnap => {
      list.push({
        uid: docSnap.id,
        ...docSnap.data()
      });
    });

    // ===== TOP 3 =====
    top3Box.innerHTML = "";
    list.slice(0, 3).forEach((s, i) => {
      const medal = ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i];
      top3Box.innerHTML += `
        <div class="flex justify-between">
          <span>${medal} ${s.nama} (${s.kelas})</span>
          <b>${s.poinTotal}</b>
        </div>
      `;
    });

    // ===== POSISI PRIBADI =====
    const myIndex = list.findIndex(s => s.uid === currentUser.uid);

    if (myIndex !== -1) {
      myBox.innerHTML = `
        ğŸ“ <b>Peringkat kamu:</b><br>
        #${myIndex + 1} dari ${list.length} siswa<br>
        Total poin: <b>${list[myIndex].poinTotal}</b>
      `;
    } else {
      myBox.innerHTML = "Kamu belum masuk ranking";
    }
  });
}


// ================= GLOBAL QUIZ CONTROLLER =================
window.stopActiveQuiz = () => {
  if (window.__ACTIVE_QUIZ__?.stop) {
    window.__ACTIVE_QUIZ__.stop();
  }
  window.__ACTIVE_QUIZ__ = null;
};



</script>

<!-- JS DARK MODE -->
<script>
const html = document.documentElement;
const toggle = document.getElementById("darkToggle");

// cek preferensi awal
if (localStorage.theme === "dark") {
  html.classList.add("dark");
  toggle.textContent = "â˜€ï¸";
}

// toggle klik
toggle.addEventListener("click", () => {
  html.classList.toggle("dark");

  if (html.classList.contains("dark")) {
    localStorage.theme = "dark";
    toggle.textContent = "â˜€ï¸";
  } else {
    localStorage.theme = "light";
    toggle.textContent = "ğŸŒ™";
  }
});
</script>


  <!-- Aktifkan mode global (1 angka untuk seluruh situs) -->
<!-- <script>
  window.PRESENCE_OPTIONS = { mode: "global" };
</script>


<script type="module" src="./assets/presence.js"></script> -->








</body>
</html>
