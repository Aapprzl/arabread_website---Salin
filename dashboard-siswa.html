<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Siswa</title>

  <!-- Tailwind -->
  <link href="assets/css/styles.css" rel="stylesheet">


  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    .arabic-question {
      font-family: 'Amiri', serif;
      font-size: 1.4rem;
      /* bisa dinaikkan */
      line-height: 1.9;
      text-align: center;
      direction: rtl;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>

<body id="dashboard-siswa"
  class="bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100 flex flex-col min-h-screen">


  <!-- ================= HEADER ================= -->
  <header
    class="sticky top-0 z-50 w-full bg-blue-700/95 dark:bg-slate-900/95 backdrop-blur-md text-white shadow-lg border-b border-white/10 transition-all">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-3.5 flex items-center justify-between">

      <div class="flex items-center gap-2 md:gap-4">
        <div class="p-2 bg-white/10 rounded-xl">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 md:w-7 md:h-7 text-blue-100" fill="none"
            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 14l9-5-9-5-9 5 9 5zm0 0l9-5-9-5-9 5 9 5zm0 0v6m0 0l4-2.222M12 20l-4-2.222" />
          </svg>
        </div>
        <div class="flex flex-col">
          <span class="text-lg md:text-xl font-black tracking-tight leading-none italic uppercase">Tarbiyyat</span>
          <span
            class="text-[9px] md:text-[10px] font-bold tracking-[0.2em] text-blue-200 uppercase leading-none mt-1">al-Lughah</span>
        </div>
      </div>

      <div class="flex items-center gap-3 md:gap-6">

        <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/10 rounded-lg border border-white/10">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-cyan-300"></span>
          </span>
          <span class="text-[10px] font-black uppercase tracking-widest text-teal-50">Portal Siswa</span>
        </div>

        <a href="index.html"
          class="text-xs md:text-sm font-bold bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl border border-white/20 transition-all active:scale-95">
          Beranda
        </a>

        <button id="darkToggle" class="flex items-center justify-center w-9 h-9 md:w-10 md:h-10 rounded-xl 
               bg-white text-blue-700 dark:bg-slate-800 dark:text-yellow-400
               transition-all active:scale-90 text-base shadow-sm hover:shadow-md" title="Ganti Tema">
          üåô
        </button>
      </div>

    </div>
  </header>


  <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">

    <!-- ================= LOGIN SISWA ================= -->
    <section id="login-section" class="w-full max-w-2xl mx-auto px-0 sm:px-4 py-6 md:py-20">
      <article
        class="bg-white dark:bg-slate-800 border-x-0 sm:border border-slate-200 dark:border-slate-700 rounded-none sm:rounded-[2rem] shadow-xl overflow-hidden transition-all">

        <div
          class="bg-gradient-to-br from-blue-600 to-blue-800 text-white py-12 px-6 text-center relative overflow-hidden">
          <div class="absolute -top-6 -left-6 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
          <div class="absolute -bottom-6 -right-6 w-32 h-32 bg-cyan-400/10 rounded-full blur-xl"></div>

          <div class="relative z-10">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl backdrop-blur-md mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
            </div>
            <h3 class="text-2xl md:text-3xl font-black tracking-tight italic uppercase">Masuk Siswa</h3>
            <p class="text-blue-100 text-[10px] md:text-xs mt-1 font-bold uppercase tracking-[0.3em] opacity-80">Akses
              Pembelajaran Digital</p>
          </div>
        </div>

        <div class="p-8 md:p-12 space-y-7">

          <div class="grid grid-cols-1 gap-5">
            <div class="space-y-2">
              <label
                class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">Email
                Siswa</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-slate-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.206" />
                  </svg>
                </span>
                <input id="email" type="email" placeholder="Masukkan email anda..."
                  class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 focus:outline-none transition-all appearance-none">
              </div>
            </div>

            <div class="space-y-2">
              <label
                class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">Kata
                Sandi</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-slate-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </span>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  class="w-full pl-12 pr-12 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 focus:outline-none transition-all appearance-none">
                <button type="button" id="togglePassword" class="absolute inset-y-0 right-4 flex items-center text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                  <i data-feather="eye" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="pt-4">
            <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 md:py-5 rounded-2xl font-black uppercase tracking-widest 
                       shadow-xl shadow-blue-500/40 transition-all active:scale-[0.97] flex items-center justify-center gap-3 text-sm md:text-base">
              <span>Masuk ke Portal</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>

          <div id="error" class="hidden">
            <div
              class="flex items-center gap-3 p-4 rounded-2xl bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800/50">
              <div class="bg-red-500 text-white rounded-full p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <p class="text-xs font-bold text-red-700 dark:text-red-400">Email atau kata sandi tidak sesuai.</p>
            </div>
          </div>

        </div>

        <div
          class="px-8 py-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 text-center">
          <a href="#"
            class="text-[11px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest hover:underline">
            Lupa kata sandi? Hubungi guru pengampu
          </a>
        </div>

      </article>
    </section>

    <!-- ================= DASHBOARD SISWA ================= -->
    <section id="dashboard-section" class="hidden">

      <div class="grid grid-cols-1 md:grid-cols-10 gap-6">

        <!-- ===== IDENTITAS ===== -->
        <aside class="md:col-span-3 space-y-6">

          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden relative">

            <div class="h-24 bg-gradient-to-r from-blue-600 to-indigo-600"></div>

            <div class="px-6 relative">
              <div class="absolute -top-12 left-1/2 transform -translate-x-1/2">
                <div class="relative">
                  <div
                    class="w-24 h-24 rounded-full border-4 border-white dark:border-slate-800 bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-4xl shadow-md">
                    üéì
                  </div>
                  <div
                    class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full animate-pulse"
                    title="Online"></div>
                </div>
              </div>
            </div>

            <div class="mt-14 px-6 pb-6 text-center">

              <h2 id="nama" class="text-xl font-bold text-slate-800 dark:text-white mb-1">
                -
              </h2>
              <p
                class="text-xs text-green-600 font-semibold bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full inline-block mb-6">
                ‚óè Online
              </p>

              <div class="grid grid-cols-2 gap-3 text-left">

                <div
                  class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                  <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">NISN</p>
                  <p id="nisn" class="font-mono font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
                </div>

                <div
                  class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                  <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Kelas</p>
                  <p id="kelas" class="font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
                </div>

                <div
                  class="col-span-2 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700 flex items-center gap-3">
                  <div class="p-1.5 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="5" r="3" />
                      <path
                        d="M6.5 8a2 2 0 0 0-1.8 1.2l-3.3 11.6a1.5 1.5 0 0 0 1.5 1.7h18a1.5 1.5 0 0 0 1.5-1.7l-3.3-11.6A2 2 0 0 0 17.5 8h-11z" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-[10px] uppercase font-bold text-slate-400">Jenis Kelamin</p>
                    <p id="gender" class="font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
                  </div>
                </div>

              </div>

              <button id="btnLogout" class="w-full mt-6 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 
               dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400 dark:border-red-900/50
               py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Keluar / Logout
              </button>

            </div>
          </div>


          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div
              class="px-5 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2 bg-slate-50/50 dark:bg-slate-900/50">
              <div class="p-1.5 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                  <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                  <path d="M4 22h16" />
                  <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                  <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                  <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                </svg>
              </div>
              <h3 class="font-bold text-slate-800 dark:text-white">Top 3 Siswa</h3>
            </div>

            <div class="p-5">
              <div id="top3Ranking" class="space-y-3 font-medium text-sm text-slate-600 dark:text-slate-300">
                <div class="animate-pulse flex space-x-4">
                  <div class="flex-1 space-y-2 py-1">
                    <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded"></div>
                    <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-blue-50 dark:bg-slate-900/50 p-5 border-t border-slate-100 dark:border-slate-700">
              <div id="myRanking" class="text-sm text-slate-700 dark:text-slate-300">
                <span class="text-xs text-slate-400">Memuat peringkat kamu...</span>
              </div>
            </div>

          </div>

        </aside>




        <!-- ===== KONTEN ===== -->
        <section class="md:col-span-7 space-y-8">

          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden relative">

            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
              
              <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl text-indigo-600 dark:text-indigo-400 shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="6" y1="12" x2="10" y2="12" />
                    <line x1="8" y1="10" x2="8" y2="14" />
                    <line x1="15" y1="13" x2="15.01" y2="13" />
                    <line x1="18" y1="11" x2="18.01" y2="11" />
                    <rect x="2" y="6" width="20" height="12" rx="2" />
                  </svg>
                </div>
                <div>
                  <h2 class="text-xl font-black text-slate-800 dark:text-white tracking-tight">Area Kuis & Game</h2>
                  <p class="text-xs font-medium text-slate-400 dark:text-slate-500">Pilih topik untuk mulai bermain!</p>
                </div>
              </div>

              <!-- STATS BUTTON/CARD -->
              <div class="w-full md:w-auto flex items-center gap-6 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-3 rounded-xl shadow-sm md:border-0 md:bg-transparent md:shadow-none md:p-0 md:justify-end">
                 
                 <div class="flex-1 md:flex-none">
                    <p class="text-[9px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">Total Poin</p>
                    <p id="quizBestScore" class="text-lg font-black text-emerald-500 leading-none">-</p>
                 </div>

                 <div class="w-px h-8 bg-slate-100 dark:bg-slate-700"></div>

                 <div class="flex-1 md:flex-none text-right md:text-left">
                    <p class="text-[9px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">Total Bermain</p>
                    <p id="quizAttempts" class="text-sm font-bold text-slate-600 dark:text-slate-300 leading-none">-</p>
                 </div>

              </div>

            </div>

            <div class="p-6">
              


              <div class="mb-2">
                <p class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3 ml-1">Pilih Tema Tantangan:</p>

                <div id="quizThemeList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[500px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-indigo-200 dark:scrollbar-thumb-slate-600 scrollbar-track-transparent">
                  <!-- Dynamic content loaded by JS -->
                  <div class="col-span-full py-8 text-center text-slate-400 italic">
                      Memuat daftar kuis...
                  </div>
                </div>
              </div>


              <div id="quizBox"
                class="mt-6 mb-8 hidden bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 text-center relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-cyan-400"></div>
                
                <p id="quizQuestion"
                  class="text-3xl md:text-4xl font-bold mb-8 text-slate-800 dark:text-slate-100 arabic-question leading-loose py-4"></p>

                <div id="quizOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-3xl mx-auto">
                </div>

                <div class="mt-8">
                  <p id="quizFeedback" class="text-xl font-bold min-h-[32px] animate-fade-in"></p>
                  <button id="nextQuestion"
                    class="hidden mt-4 bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold uppercase tracking-widest transition-all shadow-lg active:scale-95">
                    Soal Berikutnya ‚ûî
                  </button>
                </div>
              </div>

              <!-- COLLAPSIBLE GAMES SECTION -->
              <div class="mt-8 border-t border-slate-100 dark:border-slate-700 pt-6">
                <button onclick="const el = document.getElementById('embedded-games'); el.classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180');" 
                        class="w-full relative overflow-hidden flex items-center justify-between p-6 rounded-3xl transition-all group shadow-xl shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:-translate-y-1">
                   
                   <!-- Gradient Background -->
                   <div class="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 dark:from-violet-700 dark:to-indigo-800 transition-all group-hover:scale-105"></div>
                   
                   <!-- Content -->
                   <div class="relative z-10 flex items-center gap-5">
                     <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-3xl shadow-inner">
                        üéÆ
                     </div>
                     <div class="text-left">
                       <h3 class="font-black text-white text-xl tracking-tight">Mini Games Seru</h3>
                       <p class="text-xs text-indigo-100 font-medium opacity-90 uppercase tracking-widest mt-1">Main & Kumpulkan Poin +</p>
                     </div>
                   </div>

                   <!-- Icon -->
                   <div class="relative z-10 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-all">
                       <svg class="w-6 h-6 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
                       </svg>
                   </div>
                </button>

                <div id="embedded-games" class="hidden mt-8 space-y-8">
                    
                    <!-- 1. GRAMMAR QUIZ -->
                    <div class="bg-gradient-to-br from-purple-50 via-white to-purple-50 dark:from-slate-800 dark:to-purple-900/10 rounded-3xl p-1 border border-purple-100 dark:border-purple-900/50 shadow-lg hover:shadow-purple-200/50 dark:hover:shadow-purple-900/30 transition-all duration-300 transform hover:-translate-y-1">
                      <div class="bg-white/60 dark:bg-slate-900/60 backdrop-blur-sm rounded-[1.3rem] p-6">
                      <div class="text-center mb-6">
                        <span class="text-[10px] font-black uppercase tracking-widest text-purple-600 bg-purple-100 dark:bg-purple-900/50 px-3 py-1 rounded-full ring-1 ring-purple-200 dark:ring-purple-800">Grammar</span>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mt-3">Tebak Jenis Kata</h3>
                      </div>

                      <div class="flex flex-col gap-6">
                        <div class="h-40 bg-white dark:bg-slate-950 rounded-2xl border-2 border-dashed border-purple-200 dark:border-purple-800/50 flex items-center justify-center relative shadow-inner">
                            <div id="sg-grammar-word" class="font-arab text-5xl font-bold text-slate-800 dark:text-white transition-all drop-shadow-sm">...</div>
                            <div id="sg-grammar-feedback" class="absolute inset-0 flex items-center justify-center text-6xl opacity-0 transition-all scale-50 filter drop-shadow-md">‚úÖ</div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <button data-type="isim" class="sg-grammar-btn px-2 py-4 rounded-xl bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-black text-sm transition shadow-sm border-b-4 border-blue-200 dark:border-blue-800 active:border-b-0 active:translate-y-1">ISIM</button>
                            <button data-type="fiil" class="sg-grammar-btn px-2 py-4 rounded-xl bg-rose-100 hover:bg-rose-200 dark:bg-rose-900/30 text-rose-700 dark:text-rose-300 font-black text-sm transition shadow-sm border-b-4 border-rose-200 dark:border-rose-800 active:border-b-0 active:translate-y-1">FI'IL</button>
                            <button data-type="harf" class="sg-grammar-btn px-2 py-4 rounded-xl bg-emerald-100 hover:bg-emerald-200 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 font-black text-sm transition shadow-sm border-b-4 border-emerald-200 dark:border-emerald-800 active:border-b-0 active:translate-y-1">HARF</button>
                        </div>
                        
                        <button onclick="window.startGrammarGame()" class="w-full py-3 rounded-xl bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 text-white font-bold text-xs uppercase tracking-widest transition shadow-lg">
                          Mulai Game Baru
                        </button>
                      </div>
                      </div>
                    </div>

                    <!-- 2. SENTENCE GAME -->
                    <div class="bg-gradient-to-br from-blue-50 via-white to-cyan-50 dark:from-slate-800 dark:to-blue-900/10 rounded-3xl p-1 border border-blue-100 dark:border-blue-900/50 shadow-lg hover:shadow-blue-200/50 dark:hover:shadow-blue-900/30 transition-all duration-300 transform hover:-translate-y-1">
                      <div class="bg-white/60 dark:bg-slate-900/60 backdrop-blur-sm rounded-[1.3rem] p-6">
                      <div class="text-center mb-6">
                          <span class="text-[10px] font-black uppercase tracking-widest text-blue-600 bg-blue-100 dark:bg-blue-900/50 px-3 py-1 rounded-full ring-1 ring-blue-200 dark:ring-blue-800">Susun Kalimat</span>
                          <p id="sg-sentence-title" class="font-bold text-lg mt-3 text-slate-800 dark:text-white">-</p>
                          <p id="sg-sentence-desc" class="text-xs text-slate-400 italic mt-1">-</p>
                      </div>

                      <div class="space-y-4">
                          <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border-dashed border-2 border-slate-300 dark:border-slate-600 min-h-[100px] flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-slate-400 mb-3 text-center uppercase tracking-widest">Bank Kata</p>
                            <div id="sg-sentence-bank" class="flex flex-wrap gap-2 justify-center"></div>
                          </div>
                          <div class="bg-blue-50/50 dark:bg-blue-900/20 p-4 rounded-xl border-2 border-blue-100 dark:border-blue-800/50 min-h-[100px] flex flex-col justify-center shadow-inner">
                            <p class="text-[10px] font-bold text-blue-400 mb-3 text-center uppercase tracking-widest">Area Jawaban (Klik Kata)</p>
                            <div id="sg-sentence-drop" class="flex flex-wrap gap-2 justify-center" dir="rtl"></div>
                          </div>
                      </div>

                      <div class="mt-6 flex gap-3">
                          <button onclick="window.loadSentenceGame()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 font-bold text-slate-600 dark:text-slate-300 text-xs uppercase tracking-wide transition">Ganti Soal</button>
                          <button id="sg-sentence-check" class="flex-[2] py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs uppercase tracking-wide shadow-lg shadow-blue-500/30 transition active:scale-95">periksa Jawaban</button>
                      </div>
                      </div>
                    </div>

                    <!-- 3. HARAKAT GAME -->
                    <div class="w-[88vw] md:w-full mx-auto max-w-full overflow-hidden bg-gradient-to-br from-amber-50 via-white to-orange-50 dark:from-slate-800 dark:to-amber-900/10 rounded-3xl p-0 md:p-1 border border-amber-100 dark:border-amber-900/50 shadow-lg hover:shadow-amber-200/50 dark:hover:shadow-amber-900/30 transition-all duration-300 transform hover:-translate-y-1">
                      <div class="bg-white/60 dark:bg-slate-900/60 backdrop-blur-sm rounded-[1.3rem] p-3 md:p-6 flex flex-col gap-3 md:gap-4 w-full">
                      
                      <!-- Header -->
                      <div class="text-center">
                          <span class="text-[10px] font-black uppercase tracking-widest text-amber-600 bg-amber-100 dark:bg-amber-900/50 px-3 py-1 rounded-full ring-1 ring-amber-200 dark:ring-amber-800">Harakat</span>
                          <p class="text-slate-400 text-[10px] md:text-xs mt-2 font-medium">Lengkapi harakat yang hilang</p>
                      </div>

                      <div class="space-y-3 md:space-y-5 w-full">
                          <!-- Question Box -->
                          <div class="w-full bg-slate-50 dark:bg-slate-900/50 p-2 md:p-6 rounded-2xl border border-slate-200 dark:border-slate-700 text-center shadow-sm min-h-[70px] md:min-h-[80px] flex items-center justify-center overflow-hidden">
                            <div id="sg-harakat-question" class="font-arab text-2xl md:text-5xl font-bold text-slate-800 dark:text-white leading-relaxed tracking-wide transition-all break-words w-full px-2">...</div>
                          </div>
                          
                          <!-- Answer Input -->
                          <div class="relative group w-full"> 
                            <input id="sg-harakat-input" type="text" dir="rtl" class="w-full min-w-0 py-2 md:py-4 px-3 md:px-6 text-center font-arab text-2xl md:text-3xl rounded-2xl border-2 border-slate-200 focus:border-amber-500 outline-none bg-white dark:bg-slate-950 dark:text-white dark:border-slate-700 transition shadow-sm focus:shadow-md placeholder-slate-300" placeholder="..." inputmode="none" autocomplete="off">
                            <div class="absolute inset-y-0 right-3 md:right-4 flex items-center pointer-events-none">
                               <span class="text-[9px] md:text-xs font-bold text-slate-300 uppercase">Input</span>
                            </div>
                          </div>
                      </div>

                      <!-- Control Buttons -->
                      <div class="flex gap-2 w-full">
                          <button id="sg-harakat-shuffle" class="flex-1 py-2 md:py-3 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 font-bold text-slate-600 dark:text-slate-300 text-[9px] md:text-xs uppercase tracking-wide transition">Acak</button>
                          <button id="sg-harakat-keyboard-toggle" class="px-3 md:px-4 py-2 md:py-3 rounded-xl bg-amber-100 hover:bg-amber-200 text-amber-700 font-bold border border-amber-200 text-sm md:text-lg transition shadow-sm">‚å®Ô∏è</button>
                          <button id="sg-harakat-check" class="flex-[2] py-2 md:py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-bold text-[9px] md:text-xs uppercase tracking-wide shadow-lg shadow-amber-500/30 transition active:scale-95">Periksa</button>
                      </div>
                      </div>
                    </div>

                </div>
              </div>



            </div>
          </div>


          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div
              class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center gap-3">
              <div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Sesi Belajar</h3>
                <p class="text-xs text-slate-400 dark:text-slate-500">Materi dan tugas harianmu.</p>
              </div>
            </div>

            <div class="p-4 sm:p-8 bg-white dark:bg-slate-800 rounded-b-[2rem]">

              <div class="flex items-center justify-between mb-6 px-2">
                <h4 class="text-[11px] font-black uppercase tracking-[0.2em] text-slate-400">Tahapan dalam Belajar</h4>
              </div>

              <div id="sessionList" class="space-y-4">
                <div class="animate-pulse space-y-4" id="skeletonLoading">
                  <div
                    class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                  </div>
                  <div
                    class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                  </div>
                  <div
                    class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                  </div>
                </div>

                <div class="hidden flex flex-col items-center py-10" id="loadingIndicator">
                  <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3">
                  </div>
                  <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Menyusun Materi...</p>
                </div>
              </div>
            </div>

          </div>


          <div id="discussionContainer"
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col h-[75vh] md:h-[600px]">

            <div onclick="toggleDiscussion()"
              class="cursor-pointer px-5 py-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center select-none hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors">
              <div class="flex items-center gap-3">
                <div class="relative">
                  <div class="w-3 h-3 rounded-full bg-green-500 animate-ping absolute inset-0 opacity-75"></div>
                  <div class="w-3 h-3 rounded-full bg-green-500 relative"></div>
                </div>
                <div>
                  <h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">Ruang Diskusi</h3>
                  <p class="text-xs text-slate-400">Tanya jawab dengan guru & teman</p>
                </div>
              </div>

              <svg id="chevronIcon" class="w-5 h-5 text-slate-400 transition-transform duration-300" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>

            <div id="discussionContent" class="flex flex-col flex-1 min-h-0 relative">

              <div id="discussionFeed"
                class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#eef1f5] dark:bg-[#0b141a] scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600 relative">

                <div class="flex h-full items-center justify-center opacity-60">
                  <p
                    class="text-slate-400 text-sm italic bg-slate-200/50 dark:bg-slate-800/50 px-4 py-1.5 rounded-full shadow-sm">
                    Memuat percakapan...
                  </p>
                </div>
              </div>

              <div
                class="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex-shrink-0 z-10">
                <div class="flex items-end gap-2">

                  <textarea id="discussionInput" rows="1" placeholder="Ketik pesan..." class="flex-1 max-h-32 min-h-[50px] py-3 px-5 rounded-3xl resize-none
                   bg-slate-100 dark:bg-slate-700 
                   text-slate-800 dark:text-white placeholder-slate-400
                   border-0 focus:ring-2 focus:ring-blue-500/50 outline-none
                   scrollbar-hide transition-all shadow-inner" style="field-sizing: content;"></textarea>

                  <button id="btnPostDiscussion" type="button" class="flex-shrink-0 w-[50px] h-[50px] flex items-center justify-center rounded-full
                   bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/30
                   transform active:scale-95 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                  </button>
                </div>
                <div class="text-[10px] text-slate-400 mt-1 ml-4 dark:text-slate-500">
                  Enter untuk mengirim
                </div>
              </div>

            </div>
          </div>

        </section>


      </div>

      <!-- ===============================
           üì¨ KOTAK SURAT DARI GURU
      =============================== -->
      <section class="mt-8 mb-6">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

          <!-- Header dengan Badge -->
          <div onclick="toggleStudentAnnouncements()"
            class="cursor-pointer px-5 py-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-slate-900/50 dark:to-slate-800/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center hover:from-amber-100 hover:to-orange-100 dark:hover:from-slate-900 dark:hover:to-slate-800 transition-colors">
            <div class="flex items-center gap-3">
              <div class="relative p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-amber-600 dark:text-amber-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                <!-- Unread Badge -->
                <span id="unreadBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-pulse shadow-lg">
                  0
                </span>
              </div>
              <div>
                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">Kotak Surat dari Guru</h3>
                <p class="text-xs text-slate-400">Pengumuman resmi dari guru pengampu.</p>
              </div>
            </div>

            <svg id="studentAnnouncementChevron" class="w-5 h-5 text-slate-400 transition-transform duration-300" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- Daftar Pengumuman -->
          <div id="studentAnnouncementContent" class="hidden">
            <div id="studentAnnouncementList" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- Placeholder -->
              <div class="p-6 text-center text-slate-400 dark:text-slate-500 italic">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-2 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Belum ada pengumuman dari guru.
              </div>
            </div>
          </div>

        </div>
      </section>

      <script>
        function toggleStudentAnnouncements() {
          const content = document.getElementById('studentAnnouncementContent');
          const chevron = document.getElementById('studentAnnouncementChevron');
          content.classList.toggle('hidden');
          chevron.classList.toggle('rotate-180');
        }
      </script>

      <!-- ================= KIRIM TUGAS ================= -->
      <section class="mt-8 mb-20">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

          <!-- Header Clickable -->
          <div onclick="toggleAssignment()" 
               class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors">
            
            <div class="flex items-center gap-3">
              <div class="p-2 bg-violet-100 dark:bg-violet-900/30 rounded-lg text-violet-600 dark:text-violet-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="17 8 12 3 7 8" />
                  <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                  Kirim Tugas
                </h2>
                <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                  Upload hasil pengerjaan tugasmu di sini.
                </p>
              </div>
            </div>

            <!-- Chevron Icon -->
            <svg id="assignmentChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke-width="2.5" stroke="currentColor"
              class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>

          </div>

          <!-- Content Hidden by Default -->
          <div id="assignmentContent" class="hidden p-6 space-y-5">

            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 ml-1">
                Catatan Tambahan (Opsional)
              </label>
              <textarea id="catatanTugas" rows="3" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 
                 placeholder-slate-400 focus:ring-2 focus:ring-violet-500 focus:border-transparent 
                 outline-none transition-all resize-none shadow-sm"
                placeholder="Contoh: Pak, ini tugas pertemuan ke-2 saya..."></textarea>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 ml-1">
                File Tugas
              </label>
              <div class="relative group">
                <input type="file" id="fileTugas" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                  class="block w-full text-sm text-slate-500 dark:text-slate-400
                   file:mr-4 file:py-2.5 file:px-4
                   file:rounded-xl file:border-0
                   file:text-sm file:font-bold
                   file:bg-violet-50 file:text-violet-700
                   dark:file:bg-violet-900/30 dark:file:text-violet-300
                   hover:file:bg-violet-100 dark:hover:file:bg-violet-900/50
                   cursor-pointer border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-900 transition-all" />
              </div>
              <p class="text-[10px] text-slate-400 mt-2 ml-1">
                * Format didukung: PDF, Word, atau Foto (JPG/PNG).
              </p>
            </div>

            <div class="pt-2">
              <button id="btnKirimTugas"
                class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-violet-500/30 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                <span>üöÄ</span> Kirim Tugas Sekarang
              </button>

              <div id="uploadStatus"
                class="hidden mt-4 p-3 rounded-lg text-sm text-center font-medium animate-fade-in border">
              </div>
            </div>

          </div>
        </div>
      </section>

      <script>
        function toggleAssignment() {
          const content = document.getElementById('assignmentContent');
          const chevron = document.getElementById('assignmentChevron');
          content.classList.toggle('hidden');
          
          if (content.classList.contains('hidden')) {
            chevron.classList.add('-rotate-90');
          } else {
            chevron.classList.remove('-rotate-90');
          }
        }
      </script>


    </section>
  </main>

  <!-- ===== FOOTER (PASTI NEMPEL) ===== -->
  <footer
    class="bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 transition-colors mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-10">
      <div class="flex flex-col items-center text-center space-y-4">

        <div class="flex flex-col items-center gap-1 group">
          <span class="text-lg font-black tracking-tighter text-slate-800 dark:text-white uppercase italic">
            Tarbiyyat <span class="text-blue-600 dark:text-blue-400">al-Lughah</span>
          </span>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Portal Edukasi Digital</span>
          </div>
        </div>

        <div class="flex items-center gap-1.5">
          <div class="h-1 w-1 bg-blue-500/40 rounded-full"></div>
          <div class="h-1 w-24 bg-gradient-to-r from-transparent via-blue-500 to-transparent rounded-full"></div>
          <div class="h-1 w-1 bg-blue-500/40 rounded-full"></div>
        </div>

        <div class="pt-2 space-y-2">
          <p class="text-[11px] md:text-sm text-slate-600 dark:text-slate-400 font-medium leading-relaxed">
            &copy; 2026 <strong>Tarbiyyat al-Lughah</strong> ‚Äî Media Pembelajaran Bahasa Arab MTs
          </p>

          <div class="flex flex-col items-center gap-1">
            <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Developed By</span>
            <p class="text-xs md:text-sm text-slate-500 dark:text-slate-500 font-semibold italic">
              Muh. Aprizal ‚Äî <span class="text-blue-600/80 dark:text-blue-400/80">Mahasiswa PBA IAIN Bone</span>
            </p>
          </div>
        </div>

        <div
          class="mt-4 inline-flex items-center gap-2 px-3 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-full border border-blue-100 dark:border-blue-800/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-blue-500" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          <span class="text-[9px] font-black text-blue-700 dark:text-blue-400 uppercase tracking-tighter">Akses
            Terenkripsi & Aman</span>
        </div>

      </div>
    </div>
  </footer>


  <!-- MAIN LOGIC -->
  <script type="module">
    /* ================= FIREBASE IMPORT ================= */
    import { initializeApp, getApps } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      addDoc,
      collection,
      setDoc,
      onSnapshot,
      orderBy,
      getDocs,
      query,
      where,
      serverTimestamp as firestoreServerTimestamp
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    import {
      getDatabase,
      ref as dbRef,
      set,
      onValue,
      onDisconnect,
      serverTimestamp
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    import { startStudentQuiz } from "./assets/js/student-quiz-engine.js";






    /* ================= FIREBASE INIT ================= */
    const firebaseConfig = {
      apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
      authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
      projectId: "tarbiyyat-lughah-presence",
      databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
      storageBucket: "tarbiyyat-lughah-presence.firebasestorage.app",
    };


    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const storage = getStorage(app);



    /* ================= DOM ================= */
    const loginSection = document.getElementById("login-section");
    const dashSection = document.getElementById("dashboard-section");

    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const togglePasswordBtn = document.getElementById("togglePassword");
    const errorBox = document.getElementById("error");

    const elNama = document.getElementById("nama");
    const elNisn = document.getElementById("nisn");
    const elKelas = document.getElementById("kelas");
    const elGender = document.getElementById("gender");

    let currentUser = null;
    let presenceInitialized = false;

    let unsubscribeUserSnapshot = null;
    let unsubscribeRanking = null;
    let statusRefGlobal = null;


    /* ================= UI ================= */
    function showLogin() {
      loginSection.classList.remove("hidden");
      dashSection.classList.add("hidden");
    }

    function showDashboard() {
      loginSection.classList.add("hidden");
      dashSection.classList.remove("hidden");
    }

    function setText(el, val) {
      el.textContent = val || "-";
    }

    /* ================= LOGIN ================= */
    if (typeof feather !== 'undefined') feather.replace();

    if (togglePasswordBtn) {
      togglePasswordBtn.addEventListener("click", () => {
        const type = passInput.getAttribute("type") === "password" ? "text" : "password";
        passInput.setAttribute("type", type);
        
        // Toggle Icon
        const icon = togglePasswordBtn.querySelector('i');
        if (type === "password") {
          icon.setAttribute('data-feather', 'eye');
        } else {
          icon.setAttribute('data-feather', 'eye-off');
        }
        feather.replace();
      });
    }

    btnLogin.addEventListener("click", async () => {
      errorBox.classList.add("hidden");
      try {
        await signInWithEmailAndPassword(
          auth,
          emailInput.value.trim(),
          passInput.value.trim()
        );
      } catch {
        errorBox.textContent = "Email atau password salah";
        errorBox.classList.remove("hidden");
      }
    });

    /* ================= AUTH (FINAL) ================= */
    onAuthStateChanged(auth, async (user) => {

      // ================= BELUM LOGIN =================
      if (!user) {
        unsubscribeUserSnapshot?.();
        unsubscribeUserSnapshot = null;

        showLogin();
        return;
      }

      // ================= LOGIN =================
      currentUser = user;


      // üî• PASANG PRESENCE SEKALI SAJA
      setupStudentPresence(user.uid);

      // ‚õî pastikan tidak dobel listener
      unsubscribeUserSnapshot?.();
      unsubscribeUserSnapshot = null;

      const userRef = doc(db, "users", user.uid);

      unsubscribeUserSnapshot = onSnapshot(userRef, async (snap) => {

        // ‚ùå user dihapus
        if (!snap.exists()) {
          await signOut(auth);
          showLogin();
          return;
        }

        const data = snap.data();

        // ‚ùå bukan student
        if (data.role !== "student") {
          await signOut(auth);
          showLogin();
          return;
        }

        currentUser = {
          uid: user.uid,                 // üî• INI WAJIB
          email: user.email || "",
          nama: data.nama || "Siswa",
          role: data.role || "student",
          kelas: data.kelas || ""
        };

        // üîë untuk discussion.js (WAJIB)
        window.currentUser = currentUser;
        window.db = db;


        // ================= RENDER IDENTITAS =================
        renderIdentitas(data);

        // ================= STATUS KUIS (REALTIME) =================
        const elBestScore = document.getElementById("quizBestScore");
        const elAttempts = document.getElementById("quizAttempts");

        if (elBestScore) {
          elBestScore.textContent =
            `Skor terbaik: ${data.skorTerbaik ?? 0}`;
        }

        if (elAttempts) {
          elAttempts.textContent =
            `Sudah mengerjakan: ${data.jumlahMain ?? 0} kali`;
        }

        // ================= TAMPILKAN DASHBOARD =================
        showDashboard();
        // AKTIFKAN REALTIME
        listenLearningSessionsRealtime();

        // ‚ö†Ô∏è aman dipanggil berulang karena hanya read
        loadRankingForStudent();
      });

      // ================= CONTEXT GLOBAL (WAJIB UNTUK KUIS) =================
      window.__APP_CONTEXT__ = {
        db,
        auth,
        getCurrentUser: () => auth.currentUser
      };

      // ================= LOAD DYNAMIC QUIZ THEMES =================

      function loadQuizThemes() {
        const listContainer = document.getElementById("quizThemeList");
        if(!listContainer) return;

        // Listen to themes collection
        const q = query(collection(db, "themes"), where("isVisible", "==", true));

        onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
            listContainer.innerHTML = '<div class="col-span-full py-8 text-center text-slate-400 italic">Belum ada tema kuis tersedia.</div>';
            return;
          }

          listContainer.innerHTML = "";
          
          snapshot.forEach(docSnap => {
            const theme = { id: docSnap.id, ...docSnap.data() };

            const btn = document.createElement("button");
            
            // Map colors to gradients
            let gradientClass = "from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700";
            if (theme.color === "emerald") gradientClass = "from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700";
            else if (theme.color === "indigo") gradientClass = "from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700";
            else if (theme.color === "orange") gradientClass = "from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700";
            else if (theme.color === "rose") gradientClass = "from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700";
            else if (theme.color === "amber") gradientClass = "from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700";

            btn.className = `group relative overflow-hidden bg-gradient-to-br ${gradientClass} text-white p-4 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-left`;

            btn.innerHTML = `
              <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
                 <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
              </div>
              <span class="text-2xl block mb-1">üéØ</span>
              <span class="font-bold text-sm md:text-base">${theme.title}</span>
              <span class="text-[10px] block opacity-80">${theme.arabicTitle || 'Kuis'}</span>
            `;

            btn.onclick = () => {
               startStudentQuiz(theme);
            };

            listContainer.appendChild(btn);
          });
        });
      }

      loadQuizThemes();
    });

    // ===============================
    // PRESENCE SISWA (ANTI FALSE OFFLINE)
    // ===============================
    function setupStudentPresence(uid) {
      if (presenceInitialized) return; // ‚õî hanya sekali
      presenceInitialized = true;

      const rtdb = getDatabase();
      const statusRef = dbRef(rtdb, `status/${uid}`);
      const connectedRef = dbRef(rtdb, ".info/connected");

      statusRefGlobal = statusRef;

      onValue(connectedRef, (snap) => {
        if (snap.val() === false) return;

        // üî¥ auto-offline saat tab ditutup / koneksi mati
        onDisconnect(statusRef).set({
          state: "offline",
          lastChanged: serverTimestamp()
        });

        // üü¢ online
        set(statusRef, {
          state: "online",
          lastChanged: serverTimestamp()
        });
      });
    }




    /* ================= RENDER ================= */
    function renderIdentitas(data) {
      setText(elNama, data.nama);
      setText(elNisn, data.nisn);
      setText(elKelas, data.kelas);
      setText(elGender, data.gender);
    }


    /* ================= LOGOUT SISWA ================= */
    btnLogout.addEventListener("click", async () => {
      try {
        // 1Ô∏è‚É£ STOP LISTENER FIRESTORE
        unsubscribeUserSnapshot?.();
        unsubscribeRanking?.();

        unsubscribeUserSnapshot = null;
        unsubscribeRanking = null;

        // 2Ô∏è‚É£ HENTIKAN QUIZ (kalau ada)
        window.stopActiveQuiz?.();

        // üî¥ 3Ô∏è‚É£ PAKSA OFFLINE (REALTIME DATABASE)
        const user = auth.currentUser;
        if (user) {
          const rtdb = getDatabase();
          const statusRef = dbRef(rtdb, `status/${user.uid}`);

          await set(statusRef, {
            state: "offline",
            lastChanged: serverTimestamp()
          });
        }

        // üîë RESET STATE PRESENCE (INI TAMBAHAN)
        presenceInitialized = false;
        statusRefGlobal = null;

        // 4Ô∏è‚É£ SIGN OUT AUTH
        await signOut(auth);

        showLogin();

      } catch (err) {
        console.error("Logout error:", err);
      }
    });


    // FUNGSI ACAK KOSAKATA untuk sesi belajar siswa 
    function getRandomVocabsByTema(tema, limit = 5) {
      if (!tema) return [];
      
      let source = [];
      const t = tema.toLowerCase().trim();

      // Fallback ke window.VOCABS (format: array of objects {ar, id, tema})
      if (window.VOCABS && Array.isArray(window.VOCABS)) {
        source = window.VOCABS.filter(v => (v.tema || "").toLowerCase() === t).map(v => ({
          ar: v.ar,
          id: v.id
        }));
      }

      if (source.length === 0) return [];

      // Acak (Shuffle)
      const shuffled = [...source];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }

      return shuffled.slice(0, limit);
    }


    // REALTIME SESI BELAJAR SISWA
    const sessionList = document.getElementById("sessionList");

    function listenLearningSessionsRealtime() {
      sessionList.innerHTML =
        `<p class="text-sm text-slate-400">Memuat sesi belajar...</p>`;

      const q = query(
        collection(db, "learningSessions"),
        where("isActive", "==", true),
        orderBy("order", "asc")
      );

      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
          sessionList.innerHTML =
            `<p class="text-sm text-slate-400">Belum ada sesi belajar.</p>`;
          return;
        }

        sessionList.innerHTML = "";

        snapshot.forEach(docSnap => {
          const s = docSnap.data();

          const wrapper = document.createElement("div");
          wrapper.className =
            "bg-slate-200 dark:bg-slate-700 rounded-xl overflow-hidden";

          // HEADER
          // HEADER - Diperbarui dengan Glassmorphism & Hover Effect yang lebih halus
          const header = document.createElement("button");
          header.type = "button";
          header.className = `
  w-full flex justify-between items-center px-5 py-4 text-left transition-all duration-300
  bg-white dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700
  border-b border-slate-100 dark:border-slate-700/50 last:border-0
`;

          header.innerHTML = `
  <div class="flex items-center gap-3">
    <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs font-bold">
      ${s.order}
    </div>
    <div class="flex flex-col">
      <span class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Pertemuan</span>
      <span class="font-bold text-slate-700 dark:text-slate-200">${s.title}</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <span class="arrow transition-transform duration-300 text-slate-300 dark:text-slate-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </span>
  </div>
`;

          // DETAIL - Menggunakan background yang sedikit berbeda untuk membedakan dengan header
          const detail = document.createElement("div");
          detail.className = "hidden px-6 py-6 text-sm bg-slate-50/50 dark:bg-slate-900/20 session-detail animate-fade-in";

          // üîπ Kosakata wajib (Prioritas: yang disimpan guru, Fallback: Acak dari tema)
          let rawVocabs = s.mandatoryVocabs;
          
          if (!rawVocabs || !Array.isArray(rawVocabs) || rawVocabs.length === 0) {
             rawVocabs = getRandomVocabsByTema(s.theme, 5);
          }

          const vocabs = rawVocabs.map(v => ({
              ar: v.ar || v.arabic || "",
              id: v.id || v.meaning || v.arti || v.mean || v.idn || ""
          })).filter(v => v.ar && v.id);

          const vocabHTML = vocabs.map(v => `
  <div class="flex justify-between items-center bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl px-4 py-3 shadow-sm group hover:border-blue-500/50 transition-colors">
    <div class="flex flex-col">
      <span class="text-[9px] uppercase font-bold text-slate-400 mb-0.5">Arti</span>
      <span class="font-semibold text-slate-600 dark:text-slate-300">${v.id}</span>
    </div>
    <span class="font-arab text-2xl text-blue-600 dark:text-blue-400 leading-relaxed">${v.ar}</span>
  </div>
`).join("");

          detail.innerHTML = `
  <div class="space-y-6">
    <div>
      <div class="flex items-center gap-2 mb-4">
        <span class="p-1.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
        </span>
        <h5 class="font-black uppercase tracking-widest text-[11px] text-slate-500 dark:text-slate-400">Target Kosakata Hari Ini</h5>
      </div>
      <div class="grid grid-cols-1 gap-3">
          ${vocabHTML || `<div class="p-4 text-center border border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-400 text-xs italic">Belum ada kosakata yang ditargetkan untuk sesi ini.</div>`}
      </div>
    </div>

    ${s.dailyTaskText ? `
      <div class="relative bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/20 overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
        
        <div class="relative z-10">
          <div class="flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            <h5 class="font-black uppercase tracking-widest text-[10px] text-blue-100">Tugas Mandiri</h5>
          </div>
          <p class="text-sm leading-relaxed font-medium text-blue-50">${s.dailyTaskText}</p>
        </div>
      </div>
    ` : ""}
  </div>
`;

          // TOGGLE (accordion)
          header.addEventListener("click", () => {
            const isOpen = !detail.classList.contains("hidden");

            sessionList.querySelectorAll(".session-detail").forEach(d => {
              d.classList.add("hidden");
              d.previousSibling
                ?.querySelector(".arrow")
                ?.style.setProperty("transform", "rotate(0deg)");
            });

            if (!isOpen) {
              detail.classList.remove("hidden");
              header.querySelector(".arrow").style.transform = "rotate(90deg)";
            }
          });

          wrapper.appendChild(header);
          wrapper.appendChild(detail);
          sessionList.appendChild(wrapper);
        });
      }, (err) => {
        console.error(err);
        sessionList.innerHTML =
          `<p class="text-sm text-red-500">Gagal memuat sesi belajar</p>`;
      });
    }










    // ================================
    // JS TEMPAT KIRIM TUGAS (FINAL)
    // ================================
    btnKirimTugas.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const fileInput = document.getElementById("fileTugas");
      const catatan = catatanTugas.value.trim();

      if (!fileInput.files.length) {
        Swal.fire({
          icon: 'warning',
          title: 'File Belum Dipilih',
          text: 'Silakan pilih file tugas terlebih dahulu.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#f59e0b',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
        return;
      }

      const file = fileInput.files[0];

      try {
        uploadStatus.classList.remove("hidden");
        uploadStatus.textContent = "‚è≥ Mengunggah tugas...";

        const userSnap = await getDoc(doc(db, "users", user.uid));
        if (!userSnap.exists()) {
          throw new Error("Data siswa tidak ditemukan");
        }

        const siswa = userSnap.data();

        // üìÅ STRUKTUR FILE STORAGE
        const filePath = `tugas/${user.uid}/${Date.now()}_${file.name}`;

        // üî• STORAGE REF (BENAR)
        const storageRefFile = storageRef(storage, filePath);

        // ‚¨ÜÔ∏è UPLOAD FILE
        await uploadBytes(storageRefFile, file);

        // üîó AMBIL URL
        const downloadURL = await getDownloadURL(storageRefFile);

        // üßæ SIMPAN KE FIRESTORE
        await addDoc(collection(db, "submissions"), {
          uid: user.uid,
          nama: siswa.nama,
          nisn: siswa.nisn,
          kelas: siswa.kelas,
          catatan: catatan || "-",

          fileUrl: downloadURL,
          filePath: filePath,        // ‚¨ÖÔ∏è PENTING UNTUK DELETE
          fileName: file.name,
          fileType: file.type,

          createdAt: serverTimestamp(),
          createdAtClient: Date.now()
        });

        // ‚úÖ SUCCESS UI
        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Tugas Anda telah berhasil dikirim.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#2563eb', // Warna biru sesuai tema
          confirmButtonText: 'Mantap!',
          customClass: {
            popup: 'rounded-[2rem]', // Membuat sudut membulat premium
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });

        fileInput.value = "";
        catatanTugas.value = "";
        uploadStatus.innerHTML = ""; // Bersihkan status teks lama jika ada


      } catch (err) {
        console.error("UPLOAD ERROR:", err);

        // ‚ùå ERROR UI (SweetAlert2)
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: 'Terjadi kesalahan saat mengirim tugas.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }

    };






    // ================= RANKING SISWA (TOP 3 + POSISI PRIBADI) =================
    // Note: orderBy and onSnapshot already imported at top of file

    async function loadRankingForStudent() {
      const top3Box = document.getElementById("top3Ranking");
      const myBox = document.getElementById("myRanking");

      if (!currentUser) {
        myBox.innerHTML = "User belum login";
        return;
      }

      const q = query(
        collection(db, "leaderboard"),
        orderBy("poinTotal", "desc")
      );

      unsubscribeRanking = onSnapshot(q, (snapshot) => {

        const list = [];

        snapshot.forEach(docSnap => {
          list.push({
            uid: docSnap.id,
            ...docSnap.data()
          });
        });

        // ===== TOP 3 (MATCHING NEW UI) =====
        top3Box.innerHTML = "";
        list.slice(0, 3).forEach((s, i) => {
          const isMe = s.uid === currentUser.uid;
           top3Box.innerHTML += `
              <div class="flex items-center justify-between p-2 rounded-lg ${isMe ? 'bg-blue-100 dark:bg-blue-900/40' : 'bg-slate-50 dark:bg-slate-700/30'}">
                 <div class="flex items-center gap-2">
                    <span class="font-bold text-slate-400 w-4">${i+1}</span>
                    <span class="font-bold text-slate-700 dark:text-slate-200 text-xs truncate max-w-[100px]">${s.nama || 'Siswa'}</span>
                 </div>
                 <span class="font-bold text-blue-600 dark:text-blue-400 text-xs">${s.poinTotal || 0} Poin</span>
              </div>
          `;
        });

        // ===== POSISI PRIBADI (MATCHING NEW UI) =====
        const myIndex = list.findIndex(s => s.uid === currentUser.uid);

        if (myIndex !== -1) {
          myBox.innerHTML = `
            <div class="flex justify-between items-center font-bold">
                <span>Peringkat Kamu:</span>
                <span class="text-blue-600 dark:text-blue-400 text-lg">#${myIndex + 1}</span>
            </div>
            <div class="flex justify-between items-center text-xs mt-1 text-slate-500">
                <span>Total Poin:</span>
                <span>${list[myIndex].poinTotal} Poin</span>
            </div>
          `;
        } else {
           myBox.innerHTML = `
            <div class="text-center text-xs text-slate-400 p-2">
              Kamu belum masuk ranking. Ayo main game!
            </div>
           `;
        }
      });
    }


    // ================= GLOBAL QUIZ CONTROLLER =================
    window.stopActiveQuiz = () => {
      if (window.__ACTIVE_QUIZ__?.stop) {
        window.__ACTIVE_QUIZ__.stop();
      }
      window.__ACTIVE_QUIZ__ = null;
    };


    // ===============================
    // üì¨ KOTAK SURAT DARI GURU - LOGIC
    // ===============================

    const studentAnnouncementList = document.getElementById("studentAnnouncementList");
    const unreadBadge = document.getElementById("unreadBadge");

    // Load announcements for student
    async function loadStudentAnnouncements() {
      if (!currentUser) return;

      const q = query(collection(db, "announcements"));

      // Get read announcements for this student
      const readSnap = await getDocs(collection(db, `users/${currentUser.uid}/readAnnouncements`));
      const readIds = new Set(readSnap.docs.map(d => d.id));

      onSnapshot(q, async (snap) => {
        if (snap.empty) {
          studentAnnouncementList.innerHTML = `
            <div class="p-6 text-center text-slate-400 dark:text-slate-500 italic">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-2 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Belum ada pengumuman dari guru.
            </div>
          `;
          unreadBadge.classList.add("hidden");
          return;
        }

        // Re-fetch read IDs in case they changed
        const freshReadSnap = await getDocs(collection(db, `users/${currentUser.uid}/readAnnouncements`));
        const freshReadIds = new Set(freshReadSnap.docs.map(d => d.id));

        let unreadCount = 0;
        studentAnnouncementList.innerHTML = "";

        // Client-side sort to avoid Missing Index error
        const docs = [];
        snap.forEach(d => docs.push(d));
        docs.sort((a, b) => {
             const tA = a.data().createdAt?.seconds || 0;
             const tB = b.data().createdAt?.seconds || 0;
             return tB - tA;
        });

        docs.forEach(docSnap => {
          const a = docSnap.data();
          const isRead = freshReadIds.has(docSnap.id);
          if (!isRead) unreadCount++;

          const date = a.createdAt?.toDate?.()
            ? a.createdAt.toDate().toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" })
            : "-";

          const card = document.createElement("div");
          card.className = `announcement-item p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors ${!isRead ? 'bg-amber-50/50 dark:bg-amber-900/10' : ''}`;
          card.dataset.id = docSnap.id;
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  ${!isRead ? '<span class="w-2 h-2 bg-amber-500 rounded-full flex-shrink-0"></span>' : ''}
                  <h4 class="font-bold text-slate-800 dark:text-white text-sm ${!isRead ? '' : 'text-slate-600 dark:text-slate-300'}">${a.title}</h4>
                </div>
                <p class="text-xs text-slate-400">${date} ‚Ä¢ Dari ${a.createdBy || 'Guru'}</p>
              </div>
              <svg class="chevron-icon w-4 h-4 text-slate-400 transition-transform flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <div class="announcement-body hidden mt-3 pt-3 border-t border-slate-100 dark:border-slate-700">
              <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap">${a.body}</p>
            </div>
          `;

          // Toggle expand and mark as read
          card.addEventListener("click", async () => {
            const body = card.querySelector(".announcement-body");
            const chevron = card.querySelector(".chevron-icon");
            body.classList.toggle("hidden");
            chevron.classList.toggle("rotate-180");

            // Mark as read if not already
            if (!freshReadIds.has(docSnap.id)) {
              freshReadIds.add(docSnap.id);
              try {
                await setDoc(doc(db, `users/${currentUser.uid}/readAnnouncements`, docSnap.id), {
                  readAt: firestoreServerTimestamp()
                });
                // Update UI
                card.classList.remove("bg-amber-50/50", "dark:bg-amber-900/10");
                card.querySelector(".w-2.h-2")?.remove();
                updateUnreadBadge();
              } catch (err) {
                console.error("Failed to mark as read:", err);
              }
            }
          });

          studentAnnouncementList.appendChild(card);
        });

        // Update badge
        if (unreadCount > 0) {
          unreadBadge.textContent = unreadCount;
          unreadBadge.classList.remove("hidden");
        } else {
          unreadBadge.classList.add("hidden");
        }
      });
    }

    async function updateUnreadBadge() {
      if (!currentUser) return;
      const announcementsSnap = await getDocs(collection(db, "announcements"));
      const readSnap = await getDocs(collection(db, `users/${currentUser.uid}/readAnnouncements`));
      const unread = announcementsSnap.size - readSnap.size;
      if (unread > 0) {
        unreadBadge.textContent = unread;
        unreadBadge.classList.remove("hidden");
      } else {
        unreadBadge.classList.add("hidden");
      }
    }

    // Load announcements when user logs in (hooked into onAuthStateChanged)
    // This will be called automatically when currentUser is set

    // Watch for dashboard visibility changes to load announcements
    const dashboardObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const targetDash = document.getElementById('dashboard-section');
          if (targetDash && !targetDash.classList.contains('hidden') && currentUser) {
            loadStudentAnnouncements();
            dashboardObserver.disconnect(); // Only run once
          }
        }
      });
    });

    const announcementDashSection = document.getElementById('dashboard-section');
    if (announcementDashSection) {
      dashboardObserver.observe(announcementDashSection, { attributes: true });
    }


  </script>



  <script type="module" src="assets/discussion.js"></script>
  <script type="module" src="assets/presence.js"></script>

  <!-- GAME ASSETS & ENGINE for STUDENT -->
  <script src="assets/js/arabic-keyboard.js"></script>
  <script type="module">
      import { db, auth } from "./assets/js/firebase-config.js";
      import { doc, updateDoc, increment, query, collection, orderBy, limit, getDocs, setDoc, getDoc, serverTimestamp, arrayUnion, addDoc, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // --- INLINE GAME ENGINE (Emergency Fix) ---
      
      let currentUserUid = null;
      let currentUserData = {}; // Store name/class for history

      // Global Scoring & History
      async function saveGameRecord(gameTitle, isCorrect) {
        if (!currentUserUid) return;
        
        try {
            // FIX: Use 'submissions' collection for History Logs
            // This bypasses permission issues on 'leaderboard' or 'users'
            // Teacher can DELETE submissions, Student can ADD submissions. Perfect match.

            // 1. Update Score in Leaderboard (Score Only)
            const lbRef = doc(db, "leaderboard", currentUserUid);
            const scorePayload = { 
                nama: currentUserData.nama || 'Siswa',
                kelas: currentUserData.kelas || '-',
                updatedAt: serverTimestamp()
            };
            if (isCorrect) scorePayload.poinTotal = increment(1);
            
            // 2. Add History Log to Submissions
            const historyPayload = {
                type: 'game_history', // Marker to filter later
                uid: currentUserUid,
                nama: currentUserData.nama || 'Siswa',
                kelas: currentUserData.kelas || '-',
                quizTitle: gameTitle,
                isCorrect: isCorrect,
                score: isCorrect ? 1 : 0,
                timestamp: Date.now(),
                createdAt: serverTimestamp() // needed for sorting
            };

            const promises = [
                setDoc(lbRef, scorePayload, { merge: true }),
                addDoc(collection(db, "submissions"), historyPayload),
                // 3. Update User Profile (Sync for Teacher Dashboard)
                updateDoc(doc(db, "users", currentUserUid), {
                    poin: increment(isCorrect ? 1 : 0), // Daily Point
                    poinTotal: increment(isCorrect ? 1 : 0), // All Time
                    jumlahMain: increment(1)
                })
            ];
            
            await Promise.all(promises);
            
            // Refresh Rank UI Locally
            if(window.loadLeaderboard) window.loadLeaderboard();
            
            console.log(`History saved to Submissions: ${gameTitle}`);

        } catch (e) { console.error("Score/History save error", e); }
      }

      // --- LEADERBOARD & RANK REFRESH ---
      window.loadLeaderboard = async function() {
          const top3Container = document.getElementById("top3Ranking");
          const myRankContainer = document.getElementById("myRanking");
          if(!top3Container) return;

          try {
              // CHANGE: Query 'leaderboard' instead of 'users' to avoid permission issues and stale data
              const q = query(collection(db, "leaderboard"), orderBy("poinTotal", "desc"), limit(10));
              const snap = await getDocs(q);
              
              let html = "";
              let myRank = "-";
              let myScore = 0;
              let position = 0;

              snap.docs.forEach((d, i) => {
                 const data = d.data();
                 const isMe = d.id === currentUserUid;
                 if(isMe) {
                    myRank = i + 1;
                    myScore = data.poinTotal || 0;
                 }
                 
                 if(i < 3) { // Top 3
                     html += `
                        <div class="flex items-center justify-between p-2 rounded-lg ${isMe ? 'bg-blue-100 dark:bg-blue-900/40' : 'bg-slate-50 dark:bg-slate-700/30'}">
                           <div class="flex items-center gap-2">
                              <span class="font-bold text-slate-400 w-4">${i+1}</span>
                              <span class="font-bold text-slate-700 dark:text-slate-200 text-xs truncate max-w-[100px]">${data.nama || 'Siswa'}</span>
                           </div>
                           <span class="font-bold text-blue-600 dark:text-blue-400 text-xs">${data.poinTotal || 0} Poin</span>
                        </div>
                     `;
                 }
              });
              
              top3Container.innerHTML = html;
              
              if(myRankContainer) {
                 myRankContainer.innerHTML = `
                    <div class="flex justify-between items-center font-bold">
                        <span>Peringkat Kamu:</span>
                        <span class="text-blue-600 dark:text-blue-400 text-lg">#${myRank}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1 text-slate-500">
                        <span>Total Poin:</span>
                        <span>${myScore}</span>
                    </div>
                 `;
              }
          } catch(e) {
              console.error("Leaderboard error", e);
          }
      }

      // --- DASHBOARD STATS (Unify Mini Games & Quiz) ---
      async function updateDashboardStats() {
          if (!currentUserUid) return;
          try {
             const attemptsEl = document.getElementById("quizAttempts");
             const bestEl = document.getElementById("quizBestScore");
             
             // Query ALL submissions for this user
             const q = query(collection(db, "submissions"), where("uid", "==", currentUserUid));
             const snap = await getDocs(q);
             
             let totalPlays = snap.size;
             let totalPoints = 0;
             
             snap.forEach(d => {
                 totalPoints += (parseInt(d.data().score) || 0);
             });
             
             if(attemptsEl) attemptsEl.innerText = `Total Bermain: ${totalPlays} kali`;
             if(bestEl) bestEl.innerText = `Total Poin: ${totalPoints}`;
             
          } catch(e) { console.error("Stats update error", e); }
      }

      // --- KEYBOARD LOGIC (Auto-Insert) ---
      document.addEventListener('click', (e) => {
        // Handle Key Press
        if(e.target.classList.contains('key-arab') || e.target.classList.contains('key-harakat')) {
            const char = e.target.dataset.char;
            if(window.activeArabicInput) {
                const input = window.activeArabicInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                input.value = text.substring(0, start) + char + text.substring(end);
                input.selectionStart = input.selectionEnd = start + char.length;
                input.focus();
            }
        }
        // Handle Backspace
        if(e.target.closest('#key-backspace') || e.target.classList.contains('backspace')) {
             if(window.activeArabicInput) {
                const input = window.activeArabicInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                
                if(start === end && start > 0) {
                    input.value = text.substring(0, start - 1) + text.substring(end);
                    input.selectionStart = input.selectionEnd = start - 1;
                } else {
                    input.value = text.substring(0, start) + text.substring(end);
                    input.selectionStart = input.selectionEnd = start;
                }
                input.focus();
             }
        }
        // Handle Space
        if(e.target.closest('#key-space')) {
            if(window.activeArabicInput) {
                const input = window.activeArabicInput;
                input.value += " ";
                input.focus();
            }
        }
        // Handle Enter (Virtual) - Trigger Check Button
        if(e.target.closest('#key-enter')) {
             if(window.activeArabicInput) {
                 // Try to find the check button associated with this inputs game.
                 // For now, specific for Harakat Game
                 const harakatCheck = document.getElementById("sg-harakat-check");
                 if(harakatCheck) harakatCheck.click();
             }
        }
      });

      // --- GAME 1: GRAMMAR ---
      // --- GAME 1: GRAMMAR (FIRESTORE) ---
      window.initGrammarGame = async function() {
        const wordEl = document.getElementById('sg-grammar-word');
        const feedbackEl = document.getElementById('sg-grammar-feedback');
        
        // Data Fallback (Hardcoded)
        const LOCAL_DATA = [
          { word: "ŸÉŸêÿ™Ÿéÿßÿ®Ÿå", type: "isim" }, { word: "ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸå", type: "isim" },
          { word: "ŸäŸéŸÉŸíÿ™Ÿèÿ®Ÿè", type: "fiil" }, { word: "ÿ∞ŸéŸáŸéÿ®Ÿé", type: "fiil" },
          { word: "ŸÖŸêŸÜŸí", type: "harf" }, { word: "ŸÅŸêŸä", type: "harf" }
        ];

        let questions = [];
        let currentQ = null;

        // Load Data from Firestore
        try {
            const snap = await getDocs(collection(db, "grammar_questions"));
            snap.forEach(d => questions.push(d.data()));
            console.log("Siswa Grammar Questions Loaded:", questions.length);
        } catch(e) {
            console.error("Err loading grammar questions for siswa:", e);
            questions = (window.GAME_DATA && window.GAME_DATA.length) ? window.GAME_DATA : LOCAL_DATA;
        }

        window.loadGrammarQuestion = function() {
           const allData = questions.length ? questions : ((window.GAME_DATA && window.GAME_DATA.length) ? window.GAME_DATA : LOCAL_DATA);
           if(!allData.length) return;
           currentQ = allData[Math.floor(Math.random() * allData.length)];
           if(wordEl) {
              wordEl.textContent = currentQ.word;
              wordEl.className = "font-arab text-5xl md:text-6xl font-black text-slate-800 dark:text-white leading-loose mb-2";
           }
           if(feedbackEl) feedbackEl.style.opacity = 0;
           
           // Ensure buttons work
           document.querySelectorAll('.sg-grammar-btn').forEach(btn => {
              btn.onclick = () => {
                 if(!currentQ) return;
                 if(btn.dataset.type === currentQ.type) {
                    if(feedbackEl) feedbackEl.textContent = '‚úÖ';
                    if(feedbackEl) feedbackEl.style.opacity = 1;
                    saveGameRecord("Game Grammar", true);
                    setTimeout(window.loadGrammarQuestion, 800);
                 } else {
                    if(feedbackEl) feedbackEl.textContent = '‚ùå';
                    if(feedbackEl) feedbackEl.style.opacity = 1;
                    saveGameRecord("Game Grammar", false);
                    setTimeout(() => { 
                        if(feedbackEl) feedbackEl.style.opacity = 0; 
                        window.loadGrammarQuestion(); 
                    }, 500);
                 }
              }
           });
        };
        
        const startBtn = document.querySelector('button[onclick="window.startGrammarGame()"]');
        if(startBtn) startBtn.remove();

        window.loadGrammarQuestion();
      }

      // --- GAME 2: SENTENCE ---
      window.initSentenceGame = async function() {
         const LOCAL_SENTENCE = [
           { title:"Kalimat 1", description:"Susun kalimat", correct:["ÿ£ŸéŸÜŸéÿß", "ÿ∑ŸéÿßŸÑŸêÿ®Ÿå"] },
           { title:"Kalimat 2", description:"Susun kalimat", correct:["ŸáŸèŸàŸé", "ÿ£Ÿèÿ≥Ÿíÿ™Ÿéÿßÿ∞Ÿå"] }
         ];
         const wordBank = document.getElementById("sg-sentence-bank");
         const dropZone = document.getElementById("sg-sentence-drop");
         const titleEl = document.getElementById("sg-sentence-title");
         const descEl = document.getElementById("sg-sentence-desc");
         let questions = [];
         let currentQ = null;

         // Load Data from Firestore
         try {
             const snap = await getDocs(collection(db, "sentence_questions"));
             snap.forEach(d => questions.push(d.data()));
             console.log("Siswa Sentence Questions Loaded:", questions.length);
         } catch(e) {
             console.error("Err loading sentence questions for siswa:", e);
             questions = (window.SENTENCE_GAME_DATA && window.SENTENCE_GAME_DATA.length) ? window.SENTENCE_GAME_DATA : LOCAL_SENTENCE;
         }

         window.loadSentenceGame = function() {
            const allData = questions.length ? questions : ((window.SENTENCE_GAME_DATA && window.SENTENCE_GAME_DATA.length) ? window.SENTENCE_GAME_DATA : LOCAL_SENTENCE);
            if(!allData.length) return;
            currentQ = allData[Math.floor(Math.random() * allData.length)];
            
            if(wordBank) wordBank.innerHTML = "";
            if(dropZone) dropZone.innerHTML = "";
            if((titleEl) && currentQ) titleEl.textContent = currentQ.title;
            if(descEl && currentQ) descEl.textContent = currentQ.description;

            const words = [...currentQ.correct].sort(() => Math.random() - 0.5);
            words.forEach(w => {
               const div = document.createElement("div");
               div.className = "px-3 py-2 bg-blue-100 dark:bg-blue-900 rounded cursor-pointer border hover:border-blue-500 font-arab text-lg";
               div.textContent = w;
               div.onclick = function() {
                  if(this.parentNode === wordBank) dropZone.appendChild(this);
                  else wordBank.appendChild(this);
               };
               if(wordBank) wordBank.appendChild(div);
            });
         };
         
         const checkBtn = document.getElementById("sg-sentence-check");
         if(checkBtn) {
            checkBtn.onclick = function() {
               if(!currentQ) return;
               const ans = [...dropZone.children].map(c => c.textContent);
               const correct = currentQ.correct;
               const isRight = ans.length === correct.length && ans.every((v, k) => v === correct[k]);
               if(isRight) {
                  Swal.fire({ title:'Benar!', icon:'success', timer:1000, showConfirmButton:false });
                  saveGameRecord("Game Kalimat", true);
                  setTimeout(window.loadSentenceGame, 1000);
               } else {
                  Swal.fire({ title:'Salah', icon:'error', timer:1000, showConfirmButton:false });
                  saveGameRecord("Game Kalimat", false);
               }
            };
         }
         // Init
         window.loadSentenceGame();
      }

      // --- GAME 3: HARAKAT (FIRESTORE) ---
      window.initHarakatGame = async function() {
         const qEl = document.getElementById("sg-harakat-question");
         const iEl = document.getElementById("sg-harakat-input");
         if(qEl) {
             qEl.classList.remove('text-3xl'); 
             qEl.classList.add('text-6xl', 'font-black', 'leading-loose', 'tracking-wider'); 
         }
         if(iEl) {
             iEl.classList.remove('text-2xl');
             iEl.classList.add('text-5xl', 'font-bold', 'py-4');
             iEl.setAttribute("inputmode", "none");
             iEl.setAttribute("autocomplete", "off");
             
             const showKeyboard = () => {
                 const kb = document.getElementById('arabic-keyboard');
                 if(kb) {
                     kb.classList.remove('hidden');
                     window.activeArabicInput = iEl;
                 }
             };
             iEl.addEventListener('focus', showKeyboard);
             iEl.addEventListener('click', showKeyboard);
         }

         let questions = [];
         let currentQ = null;

         // Load Data from Firestore
         try {
             const snap = await getDocs(collection(db, "harakat_questions"));
             snap.forEach(d => questions.push(d.data()));
             console.log("Siswa Harakat Questions Loaded:", questions.length);
         } catch(e) {
             console.error("Err loading harakat questions for siswa:", e);
             // Fallback
             questions = [ { plain: "ŸÉÿ™ÿ®", answer: "ŸÉŸéÿ™Ÿéÿ®Ÿé" }, { plain: "ÿπŸÑŸÖ", answer: "ÿπŸéŸÑŸêŸÖŸé" } ];
         }

         window.loadHarakatGame = function() {
            if(!questions.length) return;
            currentQ = questions[Math.floor(Math.random() * questions.length)];
            if(qEl) qEl.textContent = currentQ.plain || currentQ.word;
            if(iEl) {
                iEl.value = "";
                iEl.focus();
                window.activeArabicInput = iEl;
            }
         };
         
         const shuffleBtn = document.getElementById("sg-harakat-shuffle");
         if(shuffleBtn) shuffleBtn.onclick = window.loadHarakatGame;
         
         const kbdBtn = document.getElementById("sg-harakat-keyboard-toggle");
         if(kbdBtn) {
             kbdBtn.onclick = () => {
                 const kbd = document.getElementById("arabic-keyboard");
                 if(kbd) kbd.classList.toggle("hidden");
                 if(iEl) window.activeArabicInput = iEl;
             }
         }

         if(iEl) {
             iEl.addEventListener("keydown", (e) => {
                 if(e.key === "Enter") {
                     e.preventDefault();
                     document.getElementById("sg-harakat-check").click();
                 }
             });
         }

         const btn = document.getElementById("sg-harakat-check");
         if(btn) {
            btn.onclick = function() {
               if(!iEl.value || !currentQ) return;
               const user = iEl.value.trim(); 
               const ans = currentQ.answer.trim();
               if(user === ans) {
                  Swal.fire({ title:'Benar! (+1 Poin)', icon:'success', timer:1000, showConfirmButton:false });
                  saveGameRecord("Game Harakat", true);
                  setTimeout(window.loadHarakatGame, 1000);
               } else {
                  Swal.fire({ title:'Salah', icon:'error', text: `Jawaban benar: ${ans}` });
                  saveGameRecord("Game Harakat", false);
               }
            };
         }
         
         window.loadHarakatGame();
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUserUid = user.uid;
          
          // Get User Data for History
          try {
             const snap = await getDoc(doc(db, "users", user.uid));
             if(snap.exists()) {
                 currentUserData = snap.data();
             }
          } catch(e) { console.error("Err load user", e); }

          // Init All
          window.initGrammarGame();
          window.initSentenceGame();
          window.initHarakatGame();
          
          updateDashboardStats(); // Init Stats
        }
      });
  </script>


  <!-- JS DARK MODE -->
  <script>
    const html = document.documentElement;
    const toggle = document.getElementById("darkToggle");

    // cek preferensi awal
    if (localStorage.theme === "dark") {
      html.classList.add("dark");
      toggle.textContent = "‚òÄÔ∏è";
    }

    // toggle klik
    toggle.addEventListener("click", () => {
      html.classList.toggle("dark");

      if (html.classList.contains("dark")) {
        localStorage.theme = "dark";
        toggle.textContent = "‚òÄÔ∏è";
      } else {
        localStorage.theme = "light";
        toggle.textContent = "üåô";
      }
    });
  </script>



</body>

</html>