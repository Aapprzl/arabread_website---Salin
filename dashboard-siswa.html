<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Siswa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {}
  }
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<style>
  .arabic-question {
    font-family: 'Amiri', 'Scheherazade New', serif;
    font-size: 1.4rem; /* bisa dinaikkan */
    line-height: 1.9;
    text-align: center;
    direction: rtl;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>

<body id="dashboard-siswa"
  class="bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100 flex flex-col min-h-screen">


<!-- ================= HEADER ================= -->
<header class="sticky top-0 z-50 w-full bg-blue-700/95 dark:bg-slate-900/95 backdrop-blur-md text-white shadow-lg border-b border-white/10 transition-all">
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-3.5 flex items-center justify-between">
    
    <div class="flex items-center gap-2 md:gap-4">
      <div class="p-2 bg-white/10 rounded-xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 md:w-7 md:h-7 text-blue-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l9-5-9-5-9 5 9 5zm0 0v6m0 0l4-2.222M12 20l-4-2.222" />
        </svg>
      </div>
      <div class="flex flex-col">
        <span class="text-lg md:text-xl font-black tracking-tight leading-none italic uppercase">Tarbiyyat</span>
        <span class="text-[9px] md:text-[10px] font-bold tracking-[0.2em] text-blue-200 uppercase leading-none mt-1">al-Lughah</span>
      </div>
    </div>

    <div class="flex items-center gap-3 md:gap-6">
      
      <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/10 rounded-lg border border-white/10">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-cyan-300"></span>
        </span>
        <span class="text-[10px] font-black uppercase tracking-widest text-blue-50">Portal Siswa</span>
      </div>

      <a href="index.html" 
         class="text-xs md:text-sm font-bold bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl border border-white/20 transition-all active:scale-95">
        Beranda
      </a>

      <button id="darkToggle"
        class="flex items-center justify-center w-9 h-9 md:w-10 md:h-10 rounded-xl 
               bg-white text-blue-700 dark:bg-slate-800 dark:text-yellow-400
               transition-all active:scale-90 text-base shadow-sm hover:shadow-md"
        title="Ganti Tema">
        üåô
      </button>
    </div>

  </div>
</header>


<main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">

<!-- ================= LOGIN SISWA ================= -->
<section id="login-section" class="w-full max-w-2xl mx-auto px-0 sm:px-4 py-6 md:py-20">
  <article class="bg-white dark:bg-slate-800 border-x-0 sm:border border-slate-200 dark:border-slate-700 rounded-none sm:rounded-[2rem] shadow-xl overflow-hidden transition-all">
    
    <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white py-12 px-6 text-center relative overflow-hidden">
      <div class="absolute -top-6 -left-6 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
      <div class="absolute -bottom-6 -right-6 w-32 h-32 bg-cyan-400/10 rounded-full blur-xl"></div>
      
      <div class="relative z-10">
        <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl backdrop-blur-md mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
        </div>
        <h3 class="text-2xl md:text-3xl font-black tracking-tight italic uppercase">Masuk Siswa</h3>
        <p class="text-blue-100 text-[10px] md:text-xs mt-1 font-bold uppercase tracking-[0.3em] opacity-80">Akses Pembelajaran Digital</p>
      </div>
    </div>

    <div class="p-8 md:p-12 space-y-7">
      
      <div class="grid grid-cols-1 gap-5">
        <div class="space-y-2">
          <label class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">Email Siswa</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-4 flex items-center text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.206" /></svg>
            </span>
            <input id="email" type="email" placeholder="Masukkan email anda..." 
                   class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 focus:outline-none transition-all appearance-none">
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">Kata Sandi</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-4 flex items-center text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </span>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 focus:outline-none transition-all appearance-none">
          </div>
        </div>
      </div>

      <div class="pt-4">
        <button id="btnLogin" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 md:py-5 rounded-2xl font-black uppercase tracking-widest 
                       shadow-xl shadow-blue-500/40 transition-all active:scale-[0.97] flex items-center justify-center gap-3 text-sm md:text-base">
          <span>Masuk ke Portal</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <div id="error" class="hidden">
        <div class="flex items-center gap-3 p-4 rounded-2xl bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800/50">
          <div class="bg-red-500 text-white rounded-full p-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
          </div>
          <p class="text-xs font-bold text-red-700 dark:text-red-400">Email atau kata sandi tidak sesuai.</p>
        </div>
      </div>

    </div>

    <div class="px-8 py-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 text-center">
      <a href="#" class="text-[11px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest hover:underline">
        Lupa kata sandi? Hubungi guru pengampu
      </a>
    </div>

  </article>
</section>

<!-- ================= DASHBOARD SISWA ================= -->
<section id="dashboard-section" class="hidden">

  <div class="grid grid-cols-1 md:grid-cols-10 gap-6">

    <!-- ===== IDENTITAS ===== -->
    <aside class="md:col-span-3 space-y-6">

  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden relative">
    
    <div class="h-24 bg-gradient-to-r from-blue-600 to-indigo-600"></div>

    <div class="px-6 relative">
      <div class="absolute -top-12 left-1/2 transform -translate-x-1/2">
        <div class="relative">
          <div class="w-24 h-24 rounded-full border-4 border-white dark:border-slate-800 bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-4xl shadow-md">
            üéì
          </div>
          <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full animate-pulse" title="Online"></div>
        </div>
      </div>
    </div>

    <div class="mt-14 px-6 pb-6 text-center">
      
      <h2 id="nama" class="text-xl font-bold text-slate-800 dark:text-white mb-1">
        -
      </h2>
      <p class="text-xs text-green-600 font-semibold bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full inline-block mb-6">
        ‚óè Online
      </p>

      <div class="grid grid-cols-2 gap-3 text-left">
        
        <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
          <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">NISN</p>
          <p id="nisn" class="font-mono font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
        </div>

        <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
          <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Kelas</p>
          <p id="kelas" class="font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
        </div>

        <div class="col-span-2 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700 flex items-center gap-3">
          <div class="p-1.5 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><path d="M6.5 8a2 2 0 0 0-1.8 1.2l-3.3 11.6a1.5 1.5 0 0 0 1.5 1.7h18a1.5 1.5 0 0 0 1.5-1.7l-3.3-11.6A2 2 0 0 0 17.5 8h-11z"/></svg>
          </div>
          <div>
            <p class="text-[10px] uppercase font-bold text-slate-400">Jenis Kelamin</p>
            <p id="gender" class="font-semibold text-slate-700 dark:text-slate-200 text-sm">-</p>
          </div>
        </div>

      </div>

      <button id="btnLogout"
        class="w-full mt-6 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 
               dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400 dark:border-red-900/50
               py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Keluar / Logout
      </button>

    </div>
  </div>


  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
    
    <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2 bg-slate-50/50 dark:bg-slate-900/50">
      <div class="p-1.5 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
      </div>
      <h3 class="font-bold text-slate-800 dark:text-white">Top 3 Siswa</h3>
    </div>

    <div class="p-5">
      <div id="top3Ranking" class="space-y-3 font-medium text-sm text-slate-600 dark:text-slate-300">
        <div class="animate-pulse flex space-x-4">
          <div class="flex-1 space-y-2 py-1">
            <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded"></div>
            <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-blue-50 dark:bg-slate-900/50 p-5 border-t border-slate-100 dark:border-slate-700">
      <div id="myRanking" class="text-sm text-slate-700 dark:text-slate-300">
         <span class="text-xs text-slate-400">Memuat peringkat kamu...</span>
      </div>
    </div>

  </div>

</aside>

    


    <!-- ===== KONTEN ===== -->
    <section class="md:col-span-7 space-y-8">

  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden relative">
    
    <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-slate-800 dark:text-white">Area Kuis & Game</h2>
          <p class="text-xs text-slate-400 dark:text-slate-500">Pilih topik untuk mulai bermain!</p>
        </div>
      </div>
      
      <div class="text-right">
  <p id="quizBestScore" class="text-[10px] md:text-sm font-bold text-emerald-500 leading-tight">Skor Terbaik: -</p>
  <p id="quizAttempts" class="text-[9px] md:text-xs text-slate-400">Total Main: -</p>
</div>
    </div>

    <div class="p-6">
      
      <div class="mb-2">
        <p class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3 ml-1">Pilih Tema Tantangan:</p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          
          <button id="btnThemeTaaruf"
            class="group relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-left">
            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
              <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </div>
            <span class="text-2xl block mb-1">ü§ù</span>
            <span class="font-bold text-sm md:text-base">Ta‚Äôaruf</span>
            <span class="text-[10px] block opacity-80">Perkenalan</span>
          </button>

          <button id="btnThemeSekolah"
            class="group relative overflow-hidden bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white p-4 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-left">
            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
              <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>
            </div>
            <span class="text-2xl block mb-1">üè´</span>
            <span class="font-bold text-sm md:text-base">Sekolah</span>
            <span class="text-[10px] block opacity-80">Lingkungan</span>
          </button>

          <button id="btnThemeKeluarga"
            class="group relative overflow-hidden bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-4 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-left">
            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
              <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            </div>
            <span class="text-2xl block mb-1">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
            <span class="font-bold text-sm md:text-base">Keluarga</span>
            <span class="text-[10px] block opacity-80">Anggota</span>
          </button>

          <button id="btnThemeHewan"
            class="group relative overflow-hidden bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white p-4 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-left">
            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
              <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M19.98 12.83c.01-.1.02-.2.02-.31 0-1.76-1.44-3.2-3.22-3.2-.21 0-.42.02-.62.06C15.65 6.54 13.06 4.5 10 4.5c-3.08 0-5.68 2.06-6.17 4.91-.18-.03-.37-.05-.56-.05-1.92 0-3.48 1.56-3.48 3.48 0 1.25.68 2.36 1.69 2.98-.38.74-.61 1.58-.61 2.47 0 2.87 2.33 5.21 5.21 5.21 1.92 0 3.61-1.05 4.53-2.61.92 1.55 2.61 2.61 4.53 2.61 2.87 0 5.21-2.33 5.21-5.21 0-.91-.23-1.77-.63-2.52 1.05-.63 1.76-1.78 1.76-3.08 0-.31-.03-.61-.09-.9z"/></svg>
            </div>
            <span class="text-2xl block mb-1">üêà</span>
            <span class="font-bold text-sm md:text-base">Binatang</span>
            <span class="text-[10px] block opacity-80">Kosakata</span>
          </button>

        </div>
      </div>

      <div id="quizBox" class="mt-6 hidden bg-slate-50 dark:bg-slate-700/50 p-6 rounded-2xl border border-dashed border-slate-300 dark:border-slate-600 text-center">
        
        <p id="quizQuestion" class="text-2xl font-bold mb-6 text-slate-800 dark:text-slate-100 arabic-question leading-loose"></p>

        <div id="quizOptions" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto">
          </div>

        <div class="mt-6">
          <p id="quizFeedback" class="text-lg font-bold min-h-[28px]"></p>
          <button id="nextQuestion" class="hidden mt-3 bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-full font-semibold transition-all shadow-lg animate-bounce">
            Soal Berikutnya ‚ûî
          </button>
        </div>

      </div>

    </div>
  </div>


  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
    
    <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center gap-3">
      <div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Sesi Belajar</h3>
        <p class="text-xs text-slate-400 dark:text-slate-500">Materi dan tugas harianmu.</p>
      </div>
    </div>

    <div class="p-4 sm:p-8 bg-white dark:bg-slate-800 rounded-b-[2rem]">
  
  <div class="flex items-center justify-between mb-6 px-2">
    <h4 class="text-[11px] font-black uppercase tracking-[0.2em] text-slate-400">Tahapan dalam Belajar</h4>
  </div>

  <div id="sessionList" class="space-y-4">
    <div class="animate-pulse space-y-4" id="skeletonLoading">
      <div class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50"></div>
      <div class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50"></div>
      <div class="h-16 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-700/50"></div>
    </div>
    
    <div class="hidden flex flex-col items-center py-10" id="loadingIndicator">
      <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
      <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Menyusun Materi...</p>
    </div>
  </div>
</div>

  </div>


  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col h-[75vh] md:h-[600px]">

    <div 
      onclick="toggleDiscussion()"
      class="cursor-pointer px-5 py-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center select-none hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors"
    >
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-3 h-3 rounded-full bg-green-500 animate-ping absolute inset-0 opacity-75"></div>
          <div class="w-3 h-3 rounded-full bg-green-500 relative"></div>
        </div>
        <div>
          <h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">Ruang Diskusi</h3>
          <p class="text-xs text-slate-400">Tanya jawab dengan guru & teman</p>
        </div>
      </div>

      <svg id="chevronIcon" class="w-5 h-5 text-slate-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>

    <div id="discussionContent" class="flex flex-col flex-1 min-h-0 relative">

      <div id="discussionFeed" 
        class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#eef1f5] dark:bg-[#0b141a] scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600 relative">
        
        <div class="flex h-full items-center justify-center opacity-60">
          <p class="text-slate-400 text-sm italic bg-slate-200/50 dark:bg-slate-800/50 px-4 py-1.5 rounded-full shadow-sm">
             Memuat percakapan...
          </p>
        </div>
      </div>

      <div class="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex-shrink-0 z-10">
        <div class="flex items-end gap-2">
          
          <textarea id="discussionInput" rows="1" placeholder="Ketik pesan..."
            class="flex-1 max-h-32 min-h-[50px] py-3 px-5 rounded-3xl resize-none
                   bg-slate-100 dark:bg-slate-700 
                   text-slate-800 dark:text-white placeholder-slate-400
                   border-0 focus:ring-2 focus:ring-blue-500/50 outline-none
                   scrollbar-hide transition-all shadow-inner"
            style="field-sizing: content;"></textarea>

          <button id="btnPostDiscussion" type="button"
            class="flex-shrink-0 w-[50px] h-[50px] flex items-center justify-center rounded-full
                   bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/30
                   transform active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="text-[10px] text-slate-400 mt-1 ml-4 dark:text-slate-500">
          Enter untuk mengirim
        </div>
      </div>

    </div>
  </div>

</section>


  </div>

      <!-- ================= KIRIM TUGAS ================= -->
    <section class="mt-8 mb-20">
  
  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
    
    <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center gap-3">
      <div class="p-2 bg-violet-100 dark:bg-violet-900/30 rounded-lg text-violet-600 dark:text-violet-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div>
        <h2 class="text-xl font-bold text-slate-800 dark:text-white">
          Kirim Tugas
        </h2>
        <p class="text-xs text-slate-400 dark:text-slate-500">
          Upload hasil pengerjaan tugasmu di sini.
        </p>
      </div>
    </div>

    <div class="p-6 space-y-5">

      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 ml-1">
          Catatan Tambahan (Opsional)
        </label>
        <textarea id="catatanTugas" rows="3"
          class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 
                 placeholder-slate-400 focus:ring-2 focus:ring-violet-500 focus:border-transparent 
                 outline-none transition-all resize-none shadow-sm"
          placeholder="Contoh: Pak, ini tugas pertemuan ke-2 saya..."></textarea>
      </div>

      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 ml-1">
          File Tugas
        </label>
        <div class="relative group">
          <input 
            type="file" 
            id="fileTugas"
            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
            class="block w-full text-sm text-slate-500 dark:text-slate-400
                   file:mr-4 file:py-2.5 file:px-4
                   file:rounded-xl file:border-0
                   file:text-sm file:font-bold
                   file:bg-violet-50 file:text-violet-700
                   dark:file:bg-violet-900/30 dark:file:text-violet-300
                   hover:file:bg-violet-100 dark:hover:file:bg-violet-900/50
                   cursor-pointer border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-900 transition-all"
          />
        </div>
        <p class="text-[10px] text-slate-400 mt-2 ml-1">
          * Format didukung: PDF, Word, atau Foto (JPG/PNG).
        </p>
      </div>

      <div class="pt-2">
        <button id="btnKirimTugas"
          class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-violet-500/30 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
          <span>üöÄ</span> Kirim Tugas Sekarang
        </button>

        <div id="uploadStatus" 
             class="hidden mt-4 p-3 rounded-lg text-sm text-center font-medium animate-fade-in border">
             </div>
      </div>

    </div>
  </div>
</section>


</section>
</main>

 <!-- ===== FOOTER (PASTI NEMPEL) ===== -->
  <footer class="bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 transition-colors mt-auto">
  <div class="max-w-7xl mx-auto px-6 py-10">
    <div class="flex flex-col items-center text-center space-y-4">
      
      <div class="flex flex-col items-center gap-1 group">
        <span class="text-lg font-black tracking-tighter text-slate-800 dark:text-white uppercase italic">
          Tarbiyyat <span class="text-blue-600 dark:text-blue-400">al-Lughah</span>
        </span>
        <div class="flex items-center gap-2 mt-1">
          <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Portal Edukasi Digital</span>
        </div>
      </div>

      <div class="flex items-center gap-1.5">
        <div class="h-1 w-1 bg-blue-500/40 rounded-full"></div>
        <div class="h-1 w-24 bg-gradient-to-r from-transparent via-blue-500 to-transparent rounded-full"></div>
        <div class="h-1 w-1 bg-blue-500/40 rounded-full"></div>
      </div>

      <div class="pt-2 space-y-2">
        <p class="text-[11px] md:text-sm text-slate-600 dark:text-slate-400 font-medium leading-relaxed">
          &copy; 2026 <strong>Tarbiyyat al-Lughah</strong> ‚Äî Media Pembelajaran Bahasa Arab MTs
        </p>
        
        <div class="flex flex-col items-center gap-1">
          <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Developed By</span>
          <p class="text-xs md:text-sm text-slate-500 dark:text-slate-500 font-semibold italic">
            Muh. Aprizal ‚Äî <span class="text-blue-600/80 dark:text-blue-400/80">Mahasiswa PBA IAIN Bone</span>
          </p>
        </div>
      </div>

      <div class="mt-4 inline-flex items-center gap-2 px-3 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-full border border-blue-100 dark:border-blue-800/50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        <span class="text-[9px] font-black text-blue-700 dark:text-blue-400 uppercase tracking-tighter">Akses Terenkripsi & Aman</span>
      </div>

    </div>
  </div>
</footer>

<!-- DATA SOAL -->
<script src="assets/data/vocabs.js"></script>

<!-- MAIN LOGIC -->
<script type="module">
/* ================= FIREBASE IMPORT ================= */
import { initializeApp, getApps } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getDatabase,
  ref as dbRef,
  set,
  onValue,
  onDisconnect,
  serverTimestamp
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

import {
  addDoc,
  collection,
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";






/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
  authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
  projectId: "tarbiyyat-lughah-presence",
  databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
  storageBucket: "tarbiyyat-lughah-presence.firebasestorage.app",
};


const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);
const storage = getStorage(app);



/* ================= DOM ================= */
const loginSection = document.getElementById("login-section");
const dashSection  = document.getElementById("dashboard-section");

const emailInput = document.getElementById("email");
const passInput  = document.getElementById("password");
const btnLogin   = document.getElementById("btnLogin");
const btnLogout  = document.getElementById("btnLogout");
const errorBox   = document.getElementById("error");

const elNama   = document.getElementById("nama");
const elNisn   = document.getElementById("nisn");
const elKelas  = document.getElementById("kelas");
const elGender = document.getElementById("gender");

let currentUser = null;
let presenceInitialized = false;

let unsubscribeUserSnapshot = null;
let unsubscribeRanking = null;
let statusRefGlobal = null;


/* ================= UI ================= */
function showLogin() {
  loginSection.classList.remove("hidden");
  dashSection.classList.add("hidden");
}

function showDashboard() {
  loginSection.classList.add("hidden");
  dashSection.classList.remove("hidden");
}

function setText(el, val) {
  el.textContent = val || "-";
}

/* ================= LOGIN ================= */
btnLogin.addEventListener("click", async () => {
  errorBox.classList.add("hidden");
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passInput.value.trim()
    );
  } catch {
    errorBox.textContent = "Email atau password salah";
    errorBox.classList.remove("hidden");
  }
});

/* ================= AUTH (FINAL) ================= */
onAuthStateChanged(auth, async (user) => {

  // ================= BELUM LOGIN =================
  if (!user) {
    unsubscribeUserSnapshot?.();
    unsubscribeUserSnapshot = null;

    showLogin();
    return;
  }

  // ================= LOGIN =================
  currentUser = user;


  // üî• PASANG PRESENCE SEKALI SAJA
setupStudentPresence(user.uid);

  // ‚õî pastikan tidak dobel listener
  unsubscribeUserSnapshot?.();
  unsubscribeUserSnapshot = null;

  const userRef = doc(db, "users", user.uid);

  unsubscribeUserSnapshot = onSnapshot(userRef, async (snap) => {

    // ‚ùå user dihapus
    if (!snap.exists()) {
      await signOut(auth);
      showLogin();
      return;
    }

    const data = snap.data();

    // ‚ùå bukan student
    if (data.role !== "student") {
      await signOut(auth);
      showLogin();
      return;
    }

    currentUser = {
  uid: user.uid,                 // üî• INI WAJIB
  email: user.email || "",
  nama: data.nama || "Siswa",
  role: data.role || "student",
  kelas: data.kelas || ""
};

// üîë untuk discussion.js (WAJIB)
window.currentUser = currentUser;
window.db = db;


    // ================= RENDER IDENTITAS =================
    renderIdentitas(data);

    // ================= STATUS KUIS (REALTIME) =================
    const elBestScore = document.getElementById("quizBestScore");
    const elAttempts  = document.getElementById("quizAttempts");

    if (elBestScore) {
      elBestScore.textContent =
        `Skor terbaik: ${data.skorTerbaik ?? 0}`;
    }

    if (elAttempts) {
      elAttempts.textContent =
        `Sudah mengerjakan: ${data.jumlahMain ?? 0} kali`;
    }

    // ================= TAMPILKAN DASHBOARD =================
    showDashboard();
    // AKTIFKAN REALTIME
    listenLearningSessionsRealtime();

    // ‚ö†Ô∏è aman dipanggil berulang karena hanya read
    loadRankingForStudent();
  });

  // ================= CONTEXT GLOBAL (WAJIB UNTUK KUIS) =================
  window.__APP_CONTEXT__ = {
    db,
    auth,
    getCurrentUser: () => auth.currentUser
  };

  // ================= LOAD KUIS SETELAH AUTH SIAP =================
  const quizModule = await import("./assets/js/quiz-taaruf.js");

  if (quizModule?.initQuiz) {
    quizModule.initQuiz();
  }
});

// ===============================
// PRESENCE SISWA (ANTI FALSE OFFLINE)
// ===============================
function setupStudentPresence(uid) {
  if (presenceInitialized) return; // ‚õî hanya sekali
  presenceInitialized = true;

  const rtdb = getDatabase();
  const statusRef = dbRef(rtdb, `status/${uid}`);
  const connectedRef = dbRef(rtdb, ".info/connected");

  statusRefGlobal = statusRef;

  onValue(connectedRef, (snap) => {
    if (snap.val() === false) return;

    // üî¥ auto-offline saat tab ditutup / koneksi mati
    onDisconnect(statusRef).set({
      state: "offline",
      lastChanged: serverTimestamp()
    });

    // üü¢ online
    set(statusRef, {
      state: "online",
      lastChanged: serverTimestamp()
    });
  });
}




/* ================= RENDER ================= */
function renderIdentitas(data) {
  setText(elNama, data.nama);
  setText(elNisn, data.nisn);
  setText(elKelas, data.kelas);
  setText(elGender, data.gender);
}


/* ================= LOGOUT SISWA ================= */
btnLogout.addEventListener("click", async () => {
  try {
    // 1Ô∏è‚É£ STOP LISTENER FIRESTORE
    unsubscribeUserSnapshot?.();
    unsubscribeRanking?.();

    unsubscribeUserSnapshot = null;
    unsubscribeRanking = null;

    // 2Ô∏è‚É£ HENTIKAN QUIZ (kalau ada)
    window.stopActiveQuiz?.();

    // üî¥ 3Ô∏è‚É£ PAKSA OFFLINE (REALTIME DATABASE)
    const user = auth.currentUser;
    if (user) {
      const rtdb = getDatabase();
      const statusRef = dbRef(rtdb, `status/${user.uid}`);

      await set(statusRef, {
        state: "offline",
        lastChanged: serverTimestamp()
      });
    }

    // üîë RESET STATE PRESENCE (INI TAMBAHAN)
    presenceInitialized = false;
    statusRefGlobal = null;

    // 4Ô∏è‚É£ SIGN OUT AUTH
    await signOut(auth);

    showLogin();

  } catch (err) {
    console.error("Logout error:", err);
  }
});


// FUNGSI ACAK KOSAKATA untuk sesi belajar siswa 
function getRandomVocabsByTema(tema, limit = 5) {
  if (!window.VOCABS || !Array.isArray(window.VOCABS)) return [];

  const filtered = window.VOCABS.filter(v => v.tema === tema);
  if (filtered.length === 0) return [];

  const shuffled = [...filtered];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  return shuffled.slice(0, limit);
}


// REALTIME SESI BELAJAR SISWA
const sessionList = document.getElementById("sessionList");

function listenLearningSessionsRealtime() {
  sessionList.innerHTML =
    `<p class="text-sm text-slate-400">Memuat sesi belajar...</p>`;

  const q = query(
    collection(db, "learningSessions"),
    where("isActive", "==", true),
    orderBy("order", "asc")
  );

  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
      sessionList.innerHTML =
        `<p class="text-sm text-slate-400">Belum ada sesi belajar.</p>`;
      return;
    }

    sessionList.innerHTML = "";

    snapshot.forEach(docSnap => {
      const s = docSnap.data();

      const wrapper = document.createElement("div");
      wrapper.className =
        "bg-slate-200 dark:bg-slate-700 rounded-xl overflow-hidden";

      // HEADER
      // HEADER - Diperbarui dengan Glassmorphism & Hover Effect yang lebih halus
const header = document.createElement("button");
header.type = "button";
header.className = `
  w-full flex justify-between items-center px-5 py-4 text-left transition-all duration-300
  bg-white dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700
  border-b border-slate-100 dark:border-slate-700/50 last:border-0
`;

header.innerHTML = `
  <div class="flex items-center gap-3">
    <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs font-bold">
      ${s.order}
    </div>
    <div class="flex flex-col">
      <span class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Pertemuan</span>
      <span class="font-bold text-slate-700 dark:text-slate-200">${s.title}</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <span class="arrow transition-transform duration-300 text-slate-300 dark:text-slate-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </span>
  </div>
`;

// DETAIL - Menggunakan background yang sedikit berbeda untuk membedakan dengan header
const detail = document.createElement("div");
detail.className = "hidden px-6 py-6 text-sm bg-slate-50/50 dark:bg-slate-900/20 session-detail animate-fade-in";

// üîπ Kosakata wajib (UI Kartu List)
const vocabs = getRandomVocabsByTema(s.theme, 5);

const vocabHTML = vocabs.map(v => `
  <div class="flex justify-between items-center bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl px-4 py-3 shadow-sm group hover:border-blue-500/50 transition-colors">
    <div class="flex flex-col">
      <span class="text-[9px] uppercase font-bold text-slate-400 mb-0.5">Arti</span>
      <span class="font-semibold text-slate-600 dark:text-slate-300">${v.id}</span>
    </div>
    <span class="font-arab text-2xl text-blue-600 dark:text-blue-400 leading-relaxed">${v.ar}</span>
  </div>
`).join("");

detail.innerHTML = `
  <div class="space-y-6">
    <div>
      <div class="flex items-center gap-2 mb-4">
        <span class="p-1.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
        </span>
        <h5 class="font-black uppercase tracking-widest text-[11px] text-slate-500 dark:text-slate-400">Target Kosakata Hari Ini</h5>
      </div>
      <div class="grid grid-cols-1 gap-3">${vocabHTML}</div>
    </div>

    ${s.dailyTaskText ? `
      <div class="relative bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/20 overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
        
        <div class="relative z-10">
          <div class="flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            <h5 class="font-black uppercase tracking-widest text-[10px] text-blue-100">Tugas Mandiri</h5>
          </div>
          <p class="text-sm leading-relaxed font-medium text-blue-50">${s.dailyTaskText}</p>
        </div>
      </div>
    ` : ""}
  </div>
`;

      // TOGGLE (accordion)
      header.addEventListener("click", () => {
        const isOpen = !detail.classList.contains("hidden");

        sessionList.querySelectorAll(".session-detail").forEach(d => {
          d.classList.add("hidden");
          d.previousSibling
            ?.querySelector(".arrow")
            ?.style.setProperty("transform", "rotate(0deg)");
        });

        if (!isOpen) {
          detail.classList.remove("hidden");
          header.querySelector(".arrow").style.transform = "rotate(90deg)";
        }
      });

      wrapper.appendChild(header);
      wrapper.appendChild(detail);
      sessionList.appendChild(wrapper);
    });
  }, (err) => {
    console.error(err);
    sessionList.innerHTML =
      `<p class="text-sm text-red-500">Gagal memuat sesi belajar</p>`;
  });
}










// ================================
// JS TEMPAT KIRIM TUGAS (FINAL)
// ================================
btnKirimTugas.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  const fileInput = document.getElementById("fileTugas");
  const catatan = catatanTugas.value.trim();

  if (!fileInput.files.length) {
    alert("Silakan pilih file tugas");
    return;
  }

  const file = fileInput.files[0];

  try {
    uploadStatus.classList.remove("hidden");
    uploadStatus.textContent = "‚è≥ Mengunggah tugas...";

    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists()) {
      throw new Error("Data siswa tidak ditemukan");
    }

    const siswa = userSnap.data();

    // üìÅ STRUKTUR FILE STORAGE
    const filePath = `tugas/${user.uid}/${Date.now()}_${file.name}`;

    // üî• STORAGE REF (BENAR)
    const storageRefFile = storageRef(storage, filePath);

    // ‚¨ÜÔ∏è UPLOAD FILE
    await uploadBytes(storageRefFile, file);

    // üîó AMBIL URL
    const downloadURL = await getDownloadURL(storageRefFile);

    // üßæ SIMPAN KE FIRESTORE
    await addDoc(collection(db, "submissions"), {
      uid: user.uid,
      nama: siswa.nama,
      nisn: siswa.nisn,
      kelas: siswa.kelas,
      catatan: catatan || "-",

      fileUrl: downloadURL,
      filePath: filePath,        // ‚¨ÖÔ∏è PENTING UNTUK DELETE
      fileName: file.name,
      fileType: file.type,

      createdAt: serverTimestamp(),
      createdAtClient: Date.now()
    });

    // ‚úÖ SUCCESS UI
    Swal.fire({
  icon: 'success',
  title: 'Berhasil!',
  text: 'Tugas Anda telah berhasil dikirim.',
  background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
  color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
  confirmButtonColor: '#2563eb', // Warna biru sesuai tema
  confirmButtonText: 'Mantap!',
  customClass: {
    popup: 'rounded-[2rem]', // Membuat sudut membulat premium
    confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
  }
});

fileInput.value = "";
catatanTugas.value = "";
uploadStatus.innerHTML = ""; // Bersihkan status teks lama jika ada


  } catch (err) {
  console.error("UPLOAD ERROR:", err);
  
  // ‚ùå ERROR UI (SweetAlert2)
  Swal.fire({
    icon: 'error',
    title: 'Gagal!',
    text: 'Terjadi kesalahan saat mengirim tugas.',
    background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
    color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
    confirmButtonColor: '#ef4444',
    customClass: {
      popup: 'rounded-[2rem]',
      confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
    }
  });
}

};






// ================= RANKING SISWA (TOP 3 + POSISI PRIBADI) =================
import {
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

async function loadRankingForStudent() {
  const top3Box = document.getElementById("top3Ranking");
  const myBox   = document.getElementById("myRanking");

  if (!currentUser) {
    myBox.innerHTML = "User belum login";
    return;
  }

  const q = query(
    collection(db, "leaderboard"),
    orderBy("poinTotal", "desc")
  );

  unsubscribeRanking = onSnapshot(q, (snapshot) => {

    const list = [];

    snapshot.forEach(docSnap => {
      list.push({
        uid: docSnap.id,
        ...docSnap.data()
      });
    });

    // ===== TOP 3 =====
    top3Box.innerHTML = "";
    list.slice(0, 3).forEach((s, i) => {
      const medal = ["ü•á","ü•à","ü•â"][i];
      top3Box.innerHTML += `
        <div class="flex justify-between">
          <span>${medal} ${s.nama} (${s.kelas})</span>
          <b>${s.poinTotal}</b>
        </div>
      `;
    });

    // ===== POSISI PRIBADI =====
    const myIndex = list.findIndex(s => s.uid === currentUser.uid);

    if (myIndex !== -1) {
      myBox.innerHTML = `
        üìç <b>Peringkat kamu:</b><br>
        #${myIndex + 1} dari ${list.length} siswa<br>
        Total poin: <b>${list[myIndex].poinTotal}</b>
      `;
    } else {
      myBox.innerHTML = "Kamu belum masuk ranking";
    }
  });
}


// ================= GLOBAL QUIZ CONTROLLER =================
window.stopActiveQuiz = () => {
  if (window.__ACTIVE_QUIZ__?.stop) {
    window.__ACTIVE_QUIZ__.stop();
  }
  window.__ACTIVE_QUIZ__ = null;
};



</script>

<script type="module" src="assets/discussion.js"></script>


<!-- JS DARK MODE -->
<script>
const html = document.documentElement;
const toggle = document.getElementById("darkToggle");

// cek preferensi awal
if (localStorage.theme === "dark") {
  html.classList.add("dark");
  toggle.textContent = "‚òÄÔ∏è";
}

// toggle klik
toggle.addEventListener("click", () => {
  html.classList.toggle("dark");

  if (html.classList.contains("dark")) {
    localStorage.theme = "dark";
    toggle.textContent = "‚òÄÔ∏è";
  } else {
    localStorage.theme = "light";
    toggle.textContent = "üåô";
  }
});
</script>



</body>
</html>
