<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Siswa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {}
  }
}
</script>

<style>
  .arabic-question {
    font-family: 'Amiri', 'Scheherazade New', serif;
    font-size: 1.4rem; /* bisa dinaikkan */
    line-height: 1.9;
    text-align: center;
    direction: rtl;
  }
</style>



</head>

<body class="bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100 flex flex-col min-h-screen">

<!-- ================= HEADER ================= -->
<header class="bg-gradient-to-r from-blue-700 to-blue-800 text-white shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">

      <!-- Logo / Judul -->
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 19.5A2.5 2.5 0 0 0 6.5 22H20M4 19.5V5.75A2.75 2.75 0 0 1 6.75 3h10.5A2.75 2.75 0 0 1 20 5.75V22M4 19.5c0-1.38 1.12-2.5 2.5-2.5H20"/></svg>
        <span class="text-2xl font-bold">Tarbiyyat al-Lughah</span>
      </div>

      <!-- Menu Kanan -->
      <div class="flex items-center gap-4 text-sm">
        <span class="hidden sm:inline text-blue-100 font-bold">
          Dashboard Siswa
        </span>

        <a href="index.html"
           class="bg-blue-600 hover:bg-blue-700
                  px-4 py-2 rounded-lg transition font-medium">
          Kembali ke Beranda
        </a>
        <button
        id="darkToggle"
        class="ml-3 px-3 py-2 rounded-lg bg-white/20 text-white hover:bg-white/30 transition"
        title="Toggle Dark Mode"
        >
        ğŸŒ™
      </button>
      </div>

    </div>
  </header>


<main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">

<!-- ================= LOGIN SISWA ================= -->
<section id="login-section" class="w-full max-w-6xl px-4 py-12">
      <article class="bg-white dark:bg-slate-700
                      border border-slate-200
                      rounded-2xl shadow-lg overflow-hidden">

    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-6 text-center">
      <h3 class="text-2xl font-bold flex items-center justify-center gap-2">ğŸ” Login Siswa</h3>
      <p class="text-sm text-emerald-100 mt-1"></p>
    </div>

    <div class="p-5 sm:p-8 max-w-md mx-auto space-y-4 sm:space-y-5">
      <input id="email"
             type="email"
             placeholder="Email Siswa"
             class="w-full p-3 border border-slate-300 rounded-lg text-slate-500 dark:text-slate-500">

      <input id="password"
             type="password"
             placeholder="Password"
             class="w-full p-3 border border-slate-300 rounded-lg text-slate-500 dark:text-slate-500">

      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-6 rounded-lg font-semibold">
        ğŸ”“ Masuk
      </button>

      <p id="error"
         class="text-sm text-center text-red-500 hidden">
        Login gagal
      </p>
    </div>

  </article>
</section>

<!-- ================= DASHBOARD SISWA ================= -->
<section id="dashboard-section" class="hidden">

  <div class="grid grid-cols-1 md:grid-cols-10 gap-6">

    <!-- ===== IDENTITAS ===== -->
    <aside class="md:col-span-3 space-y-4">

      <div class="bg-slate-200 rounded-xl shadow p-5 dark:bg-slate-700">
        <h2 class="font-bold text-lg mb-3">ğŸ‘¤ Identitas Siswa</h2>

        <div class="space-y-2 text-sm">
          <p><b>Nama:</b> <span id="nama">-</span></p>
          <p><b>NISN:</b> <span id="nisn">-</span></p>
          <p><b>Kelas:</b> <span id="kelas">-</span></p>
          <p><b>Gender:</b> <span id="gender">-</span></p>
          <p>
            <b>Status:</b>
            <span class="inline-flex items-center gap-2 text-green-600 font-semibold">
              <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
              Online
            </span>
          </p>
        </div>
      </div>

      <button id="btnLogout"
              class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-semibold">
        ğŸšª Logout
      </button>


      <!-- ================= RANKING SISWA (SIDEBAR) ================= -->
<div class="mt-4 bg-slate-200 shadow dark:bg-slate-700 rounded-xl p-5">
  <h3 class="font-bold mb-3 flex items-center gap-2">
    ğŸ† Ranking Siswa
  </h3>

  <!-- TOP 3 -->
  <div id="top3Ranking" class="space-y-1 mb-3 max-h-28 overflow-y-auto">
    <span class="text-xs text-slate-300">Memuat ranking...</span>
  </div>

  <hr class="my-3 border-slate-600">

  <!-- POSISI PRIBADI -->
  <div id="myRanking" class=" text-slate-700 dark:text-slate-300">
    Memuat peringkat kamu...
  </div>
</div>


    </aside>


    <!-- ===== KONTEN ===== -->
    <section class="md:col-span-7">
      <div class="bg-slate-200 rounded-xl shadow p-6 dark:bg-slate-700">
        <h2 class="font-bold text-lg mb-3">ğŸ® Area Game & Kuis</h2>

        <!-- ================= KUIS TA'ARUF ================= -->
<section class="mt-6">
  <div class="bg-slate-100 dark:bg-slate-600 rounded-xl shadow p-6">
    <h2 class="font-bold text-lg mb-3">ğŸ“ Kuis</h2>

    <div class="mt-4">
  <p class="text-sm font-semibold mb-2 text-slate-600 dark:text-slate-300">
    Pilih Tema:
  </p>

  <div class="flex flex-wrap gap-3">

    <button
      id="btnThemeTaaruf"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
        â–¶ Tema Taâ€™aruf
    </button>

    <button
      id="btnThemeSekolah"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
         â–¶ Tema Sekolah
      </button>

      <button
      id="btnThemeKeluarga"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
      â–¶ Tema Keluarga
      </button>

      <button
      id="btnThemeHewan"
      class="inline-flex items-center gap-2
         bg-blue-600 hover:bg-blue-700
         text-white px-4 py-2 rounded-lg font-semibold">
      â–¶ Tema Binatang
    </button>


  </div>
</div>



    <p id="quizBestScore" class="text-sm font-semibold text-blue-400 mt-1">
      Skor terbaik: -
    </p>

    <p id="quizAttempts" class="text-xs font-semibold text-slate-500 dark:text-slate-300">
      Sudah mengerjakan: -
    </p>


    <div id="quizBox" class="mt-6 hidden">
      <p id="quizQuestion" class="font-semibold mb-4"></p>

      <div id="quizOptions" class="space-y-2"></div>

      <p id="quizFeedback" class="mt-4 font-semibold"></p>

      <button
        id="nextQuestion"
        class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg hidden"
      >
        Soal Berikutnya
      </button>
    </div>
  </div>
</section>

<!-- ===============================
     SESI BELAJAR SISWA
=============================== -->
<section class="mt-6">
  <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
    ğŸ“˜ Sesi Belajar
  </h3>

  <div id="sessionList" class="space-y-3">
    <p class="text-sm text-slate-400">Memuat sesi belajar...</p>
  </div>

</section>


</div>
</section>


  </div>

      <!-- ================= KIRIM TUGAS ================= -->
<section class="mt-6">
  <div class="bg-slate-200 rounded-xl shadow p-6 dark:bg-slate-600">
    <h2 class="font-bold text-lg mb-4">ğŸ“¤ Kirim Tugas</h2>

    <div class="space-y-4">
      <textarea id="catatanTugas"
        class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100
         border-slate-300 dark:border-slate-600
         focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Catatan tugas (opsional)"></textarea>

      <input 
        type="file"
        id="fileTugas"
        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
        class="w-full border rounded-lg px-4 py-2
         bg-white dark:bg-slate-700
         text-slate-800 dark:text-slate-100"

        placeholder="Tempelkan link Google Drive tugas di sini"
        required />

      <button id="btnKirimTugas"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
        ğŸš€ Kirim Tugas
      </button>

      <p id="uploadStatus"
        class="text-sm text-center hidden"></p>
    </div>
  </div>
</section>


</section>
</main>

 <!-- ===== FOOTER (PASTI NEMPEL) ===== -->
  <footer class="bg-gradient-to-r from-blue-800 to-blue-700 text-white">
    <div class="max-w-7xl mx-auto px-6 py-6 text-center text-sm">
      <p class="opacity-90">
        Â© 2025 <strong>Tarbiyyat al-Lughah</strong> â€”
        Media Pembelajaran Membaca Bahasa Arab MTs
      </p>
      <p class="opacity-75 mt-1">
        Dikembangkan oleh Muh. Aprizal â€” Mahasiswa PBA IAIN Bone
      </p>
    </div>
  </footer>

<!-- DATA SOAL -->
<script src="assets/data/vocabs.js"></script>

<!-- MAIN LOGIC -->
<script type="module">
/* ================= FIREBASE IMPORT ================= */
import { initializeApp, getApps } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getDatabase,
  ref as dbRef,
  set,
  onValue,
  onDisconnect,
  serverTimestamp
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

import {
  addDoc,
  collection,
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";






/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
  authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
  projectId: "tarbiyyat-lughah-presence",
  databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
  storageBucket: "tarbiyyat-lughah-presence.firebasestorage.app",
};


const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);
const storage = getStorage(app);



/* ================= DOM ================= */
const loginSection = document.getElementById("login-section");
const dashSection  = document.getElementById("dashboard-section");

const emailInput = document.getElementById("email");
const passInput  = document.getElementById("password");
const btnLogin   = document.getElementById("btnLogin");
const btnLogout  = document.getElementById("btnLogout");
const errorBox   = document.getElementById("error");

const elNama   = document.getElementById("nama");
const elNisn   = document.getElementById("nisn");
const elKelas  = document.getElementById("kelas");
const elGender = document.getElementById("gender");

let currentUser = null;
let presenceInitialized = false;

let unsubscribeUserSnapshot = null;
let unsubscribeRanking = null;
let statusRefGlobal = null;


/* ================= UI ================= */
function showLogin() {
  loginSection.classList.remove("hidden");
  dashSection.classList.add("hidden");
}

function showDashboard() {
  loginSection.classList.add("hidden");
  dashSection.classList.remove("hidden");
}

function setText(el, val) {
  el.textContent = val || "-";
}

/* ================= LOGIN ================= */
btnLogin.addEventListener("click", async () => {
  errorBox.classList.add("hidden");
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passInput.value.trim()
    );
  } catch {
    errorBox.textContent = "Email atau password salah";
    errorBox.classList.remove("hidden");
  }
});

/* ================= AUTH (FINAL) ================= */
onAuthStateChanged(auth, async (user) => {

  // ================= BELUM LOGIN =================
  if (!user) {
    unsubscribeUserSnapshot?.();
    unsubscribeUserSnapshot = null;

    showLogin();
    return;
  }

  // ================= LOGIN =================
  currentUser = user;

  // ğŸ”¥ PASANG PRESENCE SEKALI SAJA
setupStudentPresence(user.uid);

  // â›” pastikan tidak dobel listener
  unsubscribeUserSnapshot?.();
  unsubscribeUserSnapshot = null;

  const userRef = doc(db, "users", user.uid);

  unsubscribeUserSnapshot = onSnapshot(userRef, async (snap) => {

    // âŒ user dihapus
    if (!snap.exists()) {
      await signOut(auth);
      showLogin();
      return;
    }

    const data = snap.data();

    // âŒ bukan student
    if (data.role !== "student") {
      await signOut(auth);
      showLogin();
      return;
    }

    // ================= RENDER IDENTITAS =================
    renderIdentitas(data);

    // ================= STATUS KUIS (REALTIME) =================
    const elBestScore = document.getElementById("quizBestScore");
    const elAttempts  = document.getElementById("quizAttempts");

    if (elBestScore) {
      elBestScore.textContent =
        `Skor terbaik: ${data.skorTerbaik ?? 0}`;
    }

    if (elAttempts) {
      elAttempts.textContent =
        `Sudah mengerjakan: ${data.jumlahMain ?? 0} kali`;
    }

    // ================= TAMPILKAN DASHBOARD =================
    showDashboard();
    // AKTIFKAN REALTIME
    listenLearningSessionsRealtime();

    // âš ï¸ aman dipanggil berulang karena hanya read
    loadRankingForStudent();
  });

  // ================= CONTEXT GLOBAL (WAJIB UNTUK KUIS) =================
  window.__APP_CONTEXT__ = {
    db,
    auth,
    getCurrentUser: () => auth.currentUser
  };

  // ================= LOAD KUIS SETELAH AUTH SIAP =================
  const quizModule = await import("./assets/js/quiz-taaruf.js");

  if (quizModule?.initQuiz) {
    quizModule.initQuiz();
  }
});

// ===============================
// PRESENCE SISWA (ANTI FALSE OFFLINE)
// ===============================
function setupStudentPresence(uid) {
  if (presenceInitialized) return; // â›” hanya sekali
  presenceInitialized = true;

  const rtdb = getDatabase();
  const statusRef = dbRef(rtdb, `status/${uid}`);
  const connectedRef = dbRef(rtdb, ".info/connected");

  statusRefGlobal = statusRef;

  onValue(connectedRef, (snap) => {
    if (snap.val() === false) return;

    // ğŸ”´ auto-offline saat tab ditutup / koneksi mati
    onDisconnect(statusRef).set({
      state: "offline",
      lastChanged: serverTimestamp()
    });

    // ğŸŸ¢ online
    set(statusRef, {
      state: "online",
      lastChanged: serverTimestamp()
    });
  });
}




/* ================= RENDER ================= */
function renderIdentitas(data) {
  setText(elNama, data.nama);
  setText(elNisn, data.nisn);
  setText(elKelas, data.kelas);
  setText(elGender, data.gender);
}


/* ================= LOGOUT SISWA ================= */
btnLogout.addEventListener("click", async () => {
  try {
    // 1ï¸âƒ£ STOP LISTENER FIRESTORE
    unsubscribeUserSnapshot?.();
    unsubscribeRanking?.();

    unsubscribeUserSnapshot = null;
    unsubscribeRanking = null;

    // 2ï¸âƒ£ HENTIKAN QUIZ (kalau ada)
    window.stopActiveQuiz?.();

    // ğŸ”´ 3ï¸âƒ£ PAKSA OFFLINE (REALTIME DATABASE)
    const user = auth.currentUser;
    if (user) {
      const rtdb = getDatabase();
      const statusRef = dbRef(rtdb, `status/${user.uid}`);

      await set(statusRef, {
        state: "offline",
        lastChanged: serverTimestamp()
      });
    }

    // ğŸ”‘ RESET STATE PRESENCE (INI TAMBAHAN)
    presenceInitialized = false;
    statusRefGlobal = null;

    // 4ï¸âƒ£ SIGN OUT AUTH
    await signOut(auth);

    showLogin();

  } catch (err) {
    console.error("Logout error:", err);
  }
});


// FUNGSI ACAK KOSAKATA untuk sesi belajar siswa 
function getRandomVocabsByTema(tema, limit = 5) {
  if (!window.VOCABS || !Array.isArray(window.VOCABS)) return [];

  const filtered = window.VOCABS.filter(v => v.tema === tema);
  if (filtered.length === 0) return [];

  const shuffled = [...filtered];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  return shuffled.slice(0, limit);
}


// REALTIME SESI BELAJAR SISWA
const sessionList = document.getElementById("sessionList");

function listenLearningSessionsRealtime() {
  sessionList.innerHTML =
    `<p class="text-sm text-slate-400">Memuat sesi belajar...</p>`;

  const q = query(
    collection(db, "learningSessions"),
    where("isActive", "==", true),
    orderBy("order", "asc")
  );

  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
      sessionList.innerHTML =
        `<p class="text-sm text-slate-400">Belum ada sesi belajar.</p>`;
      return;
    }

    sessionList.innerHTML = "";

    snapshot.forEach(docSnap => {
      const s = docSnap.data();

      const wrapper = document.createElement("div");
      wrapper.className =
        "bg-slate-200 dark:bg-slate-700 rounded-xl overflow-hidden";

      // HEADER
      const header = document.createElement("button");
      header.type = "button";
      header.className =
        "w-full flex justify-between items-center px-4 py-3 text-left font-semibold hover:bg-slate-300 dark:hover:bg-slate-600";

      header.innerHTML = `
        <span>ğŸ“˜ Pertemuan ${s.order} â€“ ${s.title}</span>
        <span class="arrow transition-transform">â–¶</span>
      `;

      // DETAIL
      const detail = document.createElement("div");
      detail.className =
        "hidden px-4 py-3 text-sm space-y-4 border-t border-slate-300 dark:border-slate-600 session-detail";

      // ğŸ”¹ Kosakata wajib (otomatis sesuai tema)
      const vocabs = getRandomVocabsByTema(s.theme, 5);


      const vocabHTML = vocabs.map(v => `
        <div class="flex justify-between bg-slate-800/50 rounded px-3 py-2">
          <span class="font-arab text-lg">${v.ar}</span>
          <span class="text-slate-300">${v.id}</span>
        </div>
      `).join("");

      detail.innerHTML = `
        <div>
          <h5 class="font-semibold mb-2">ğŸ“— Kosakata Wajib Hari Ini</h5>
          <div class="space-y-2">${vocabHTML}</div>
        </div>

        ${s.dailyTaskText ? `
          <div class="bg-slate-800/50 rounded-lg p-3">
            <h5 class="font-semibold mb-1">ğŸ“ Tugas Harian</h5>
            <p class="text-sm leading-relaxed">${s.dailyTaskText}</p>
          </div>
        ` : ""}
      `;

      // TOGGLE (accordion)
      header.addEventListener("click", () => {
        const isOpen = !detail.classList.contains("hidden");

        sessionList.querySelectorAll(".session-detail").forEach(d => {
          d.classList.add("hidden");
          d.previousSibling
            ?.querySelector(".arrow")
            ?.style.setProperty("transform", "rotate(0deg)");
        });

        if (!isOpen) {
          detail.classList.remove("hidden");
          header.querySelector(".arrow").style.transform = "rotate(90deg)";
        }
      });

      wrapper.appendChild(header);
      wrapper.appendChild(detail);
      sessionList.appendChild(wrapper);
    });
  }, (err) => {
    console.error(err);
    sessionList.innerHTML =
      `<p class="text-sm text-red-500">Gagal memuat sesi belajar</p>`;
  });
}










// ================================
// JS TEMPAT KIRIM TUGAS (FINAL)
// ================================
btnKirimTugas.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  const fileInput = document.getElementById("fileTugas");
  const catatan = catatanTugas.value.trim();

  if (!fileInput.files.length) {
    alert("Silakan pilih file tugas");
    return;
  }

  const file = fileInput.files[0];

  try {
    uploadStatus.classList.remove("hidden");
    uploadStatus.textContent = "â³ Mengunggah tugas...";

    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists()) {
      throw new Error("Data siswa tidak ditemukan");
    }

    const siswa = userSnap.data();

    // ğŸ“ STRUKTUR FILE STORAGE
    const filePath = `tugas/${user.uid}/${Date.now()}_${file.name}`;

    // ğŸ”¥ STORAGE REF (BENAR)
    const storageRefFile = storageRef(storage, filePath);

    // â¬†ï¸ UPLOAD FILE
    await uploadBytes(storageRefFile, file);

    // ğŸ”— AMBIL URL
    const downloadURL = await getDownloadURL(storageRefFile);

    // ğŸ§¾ SIMPAN KE FIRESTORE
    await addDoc(collection(db, "submissions"), {
      uid: user.uid,
      nama: siswa.nama,
      nisn: siswa.nisn,
      kelas: siswa.kelas,
      catatan: catatan || "-",

      fileUrl: downloadURL,
      filePath: filePath,        // â¬…ï¸ PENTING UNTUK DELETE
      fileName: file.name,
      fileType: file.type,

      createdAt: serverTimestamp(),
      createdAtClient: Date.now()
    });

    // âœ… SUCCESS UI
    uploadStatus.textContent = "âœ… Tugas berhasil dikirim";
    uploadStatus.className = "text-green-500 text-sm text-center";

    fileInput.value = "";
    catatanTugas.value = "";

  } catch (err) {
    console.error("UPLOAD ERROR:", err);
    uploadStatus.textContent = "âŒ Gagal mengirim tugas";
    uploadStatus.className = "text-red-500 text-sm text-center";
  }
};






// ================= RANKING SISWA (TOP 3 + POSISI PRIBADI) =================
import {
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

async function loadRankingForStudent() {
  const top3Box = document.getElementById("top3Ranking");
  const myBox   = document.getElementById("myRanking");

  if (!currentUser) {
    myBox.innerHTML = "User belum login";
    return;
  }

  const q = query(
    collection(db, "leaderboard"),
    orderBy("poinTotal", "desc")
  );

  unsubscribeRanking = onSnapshot(q, (snapshot) => {

    const list = [];

    snapshot.forEach(docSnap => {
      list.push({
        uid: docSnap.id,
        ...docSnap.data()
      });
    });

    // ===== TOP 3 =====
    top3Box.innerHTML = "";
    list.slice(0, 3).forEach((s, i) => {
      const medal = ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i];
      top3Box.innerHTML += `
        <div class="flex justify-between">
          <span>${medal} ${s.nama} (${s.kelas})</span>
          <b>${s.poinTotal}</b>
        </div>
      `;
    });

    // ===== POSISI PRIBADI =====
    const myIndex = list.findIndex(s => s.uid === currentUser.uid);

    if (myIndex !== -1) {
      myBox.innerHTML = `
        ğŸ“ <b>Peringkat kamu:</b><br>
        #${myIndex + 1} dari ${list.length} siswa<br>
        Total poin: <b>${list[myIndex].poinTotal}</b>
      `;
    } else {
      myBox.innerHTML = "Kamu belum masuk ranking";
    }
  });
}


// ================= GLOBAL QUIZ CONTROLLER =================
window.stopActiveQuiz = () => {
  if (window.__ACTIVE_QUIZ__?.stop) {
    window.__ACTIVE_QUIZ__.stop();
  }
  window.__ACTIVE_QUIZ__ = null;
};



</script>

<!-- JS DARK MODE -->
<script>
const html = document.documentElement;
const toggle = document.getElementById("darkToggle");

// cek preferensi awal
if (localStorage.theme === "dark") {
  html.classList.add("dark");
  toggle.textContent = "â˜€ï¸";
}

// toggle klik
toggle.addEventListener("click", () => {
  html.classList.toggle("dark");

  if (html.classList.contains("dark")) {
    localStorage.theme = "dark";
    toggle.textContent = "â˜€ï¸";
  } else {
    localStorage.theme = "light";
    toggle.textContent = "ğŸŒ™";
  }
});
</script>



</body>
</html>
