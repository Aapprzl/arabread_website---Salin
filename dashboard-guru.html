<!DOCTYPE html>
<html lang="id" dir="ltr">

<script src="assets/theme.js"></script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Dashboard Guru</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a' },
            secondary: { 100:'#dcfce7',500:'#22c55e',600:'#16a34a' }
          },
          fontFamily: { arabic: ['Amiri','Scheherazade New','serif'] }
        }
      }
    }
  </script>



</head>

<body class="min-h-screen flex flex-col bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100">


  <!-- ===== HEADER DASHBOARD GURU ===== -->
  <header class="bg-gradient-to-r from-emerald-600 to-emerald-800
 text-white shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">

      <!-- Logo / Judul -->
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 19.5A2.5 2.5 0 0 0 6.5 22H20M4 19.5V5.75A2.75 2.75 0 0 1 6.75 3h10.5A2.75 2.75 0 0 1 20 5.75V22M4 19.5c0-1.38 1.12-2.5 2.5-2.5H20"/></svg>
        <span class="text-2xl font-bold">Tarbiyyat al-Lughah</span>
      </div>

      <!-- Menu Kanan -->
      <div class="flex items-center gap-4 text-sm">
        <span class="hidden sm:inline text-blue-100 font-bold">
          Dashboard Guru
        </span>

        <a href="index.html"
           class="bg-emerald-600 hover:bg-emerald-800
                  px-4 py-2 rounded-lg transition font-medium">
          Kembali ke Beranda
        </a>
        <button
        id="darkToggle"
        class="ml-3 px-3 py-2 rounded-lg bg-white/20 text-white hover:bg-white/30 transition"
        title="Toggle Dark Mode"
        >
        üåô
      </button>
      </div>

    </div>
  </header>

  <!-- ===== MAIN (PENYANGGA FOOTER) ===== -->
  <main class="flex-grow flex items-center justify-center">

    <!-- ===============================
         LOGIN GURU
    ================================ -->
    <section id="login-section" class="w-full max-w-6xl px-4 py-12">
      <article class="bg-white dark:bg-slate-700
                      border border-slate-200
                      rounded-2xl shadow-lg overflow-hidden">

        <div class="bg-gradient-to-r from-emerald-600 to-emerald-800 text-white py-6 text-center">
          <h3 class="text-2xl font-bold flex items-center justify-center gap-2">
            üîê Login Dashboard Guru
          </h3>
          <p class="text-sm text-emerald-100 mt-1"></p>
        </div>

        <div class="p-5 sm:p-8 max-w-md mx-auto space-y-4 sm:space-y-5">

          <input id="emailGuru" type="email"
                 placeholder="Email Guru"
                 class="w-full p-3 border border-slate-300 rounded-lg text-slate-500 dark:text-slate-500">

          <input id="passwordGuru" type="password"
                 placeholder="Password"
                 class="w-full p-3 border border-slate-300 rounded-lg text-slate-500 dark:text-slate-500">

          <button id="btnLoginGuru"
                  class="w-full bg-emerald-600 hover:bg-emerald-700
                         text-white py-3 rounded-lg font-semibold">
            üîë Masuk
          </button>

          <p id="loginError"
             class="text-sm text-center text-red-500 hidden">
            Email atau password salah
          </p>
        </div>

      </article>
    </section>

    <!-- ===============================
         DASHBOARD TUGAS (HIDDEN DEFAULT)
    ================================ -->
    <section id="dashboard-section"
  class="w-full max-w-6xl mx-auto px-3 sm:px-4 py-6 sm:py-12 hidden">


      <article class="bg-white dark:bg-slate-700
                      border border-slate-200
                      rounded-2xl shadow-lg overflow-hidden">

        <div class="bg-gradient-to-r from-emerald-600 to-emerald-800
            text-white py-4 sm:py-6
            flex flex-col sm:flex-row
            gap-3 sm:gap-0
            sm:items-center sm:justify-between px-4 sm:px-6">

          <div>
            <h3 class="text-2xl font-bold flex items-center gap-2">
              üìä Dashboard GURU
            </h3>
            <p class="text-sm text-emerald-100">
              Tempat guru mengelola data siswa
            </p>
          </div>

          <button id="btnLogout"
                  class="bg-red-500 hover:bg-red-600
                         text-white px-4 py-2 rounded-lg text-sm font-semibold">
            Logout
          </button>
        </div>

        <!-- DASHBOARD TUGAS -->

        <div class="p-3 sm:p-6 overflow-x-auto">

          <table class="min-w-[700px] w-full border-collapse text-sm">

            <thead>
              <tr class="bg-slate-300 dark:bg-slate-600 text-left text-slate-500">
                <th class="p-3 border text-slate-700 dark:text-slate-100">No</th>
                <th class="p-3 border text-slate-700 dark:text-slate-100">Nama</th>
                <th class="p-3 border text-slate-700 dark:text-slate-100">Kelas</th>
                <th class="p-3 border text-slate-700 dark:text-slate-100">Catatan</th>
                <th class="p-3 border text-slate-700 dark:text-slate-100">File</th>
                <th class="p-3 border text-slate-700 dark:text-slate-100">Waktu</th>
                <th class="p-3 border text-center text-slate-700 dark:text-slate-100">Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelSubmissions">
              <tr>
                <td colspan="6" class="p-4 text-center text-slate-700 dark:text-slate-200">
                  Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>


<!-- ===============================
     MANAJEMEN SISWA
=============================== -->
<div class="mt-10">

  <h3 class="text-xl font-bold flex items-center gap-2 ml-6">
    üë• Manajemen Siswa
  </h3>

  <!-- üîë PADDING WRAPPER (SAMA DENGAN TABEL ATAS) -->
  <div class="p-3 sm:p-6 overflow-x-auto">

    <table class="min-w-[700px] w-full border-collapse text-sm">

      <thead>
        <tr class="bg-slate-300 dark:bg-slate-600 text-left">
          <th class="p-3 border text-slate-700 dark:text-slate-100">No</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Nama</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">NISN</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Kelas</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Gender</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Status</th>
          <th class="p-3 border text-center text-slate-700 dark:text-slate-100">Aksi</th>
        </tr>
      </thead>

      <tbody id="tabelSiswa">
        <tr>
          <td colspan="7"
              class="p-4 border text-center text-slate-700 dark:text-slate-200">
            Memuat data siswa...
          </td>
        </tr>
      </tbody>

    </table>

  </div>
</div>


<!-- ================= NILAI SISWA ================= -->
<div class="mt-10">
  <h2 class="text-xl font-bold ml-6">üìä Nilai Kuis Siswa</h2>
  
  <div class="p-3 sm:p-6 overflow-x-auto">
  <div class="overflow-x-auto rounded-lg shadow">
    <table class="min-w-full bg-white dark:bg-slate-800 text-sm">
      <thead class="bg-slate-300 dark:bg-slate-500">
        <tr>
          <th class="px-3 py-2 text-left">No</th>
          <th class="px-3 py-2 text-left">Nama</th>
          <th class="px-3 py-2 text-left">Kelas</th>
          <th class="px-3 py-2 text-left">Kuis</th>
          <th class="px-3 py-2 text-center">Skor</th>
          <th class="px-3 py-2 text-left">Waktu</th>
          <th class="px-3 py-2 text-left">Aksi</th>

        </tr>
      </thead>
      <tbody id="nilaiTableBody">
        <tr>
          <td colspan="6" class="p-4 border text-center text-slate-700 dark:text-slate-200">
            Memuat data nilai...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  </div>
</div>



<!-- ================= TOTAL POIN SISWA ================= -->
<div class="mt-10">

  <div class="ml-6">
  <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
    üèÜ Total Poin Siswa
  </h3>

  <button
    id="resetPoinBtn"
    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold mb-2 ml-2">
    üîÑ Reset Poin Hari Ini
  </button>

  <button
    id="resetPoinTotalBtn"
    class="ml-2 bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
    ‚ö†Ô∏è Reset Total Sepanjang Waktu
  </button>
  </div>

  <!-- üîë PADDING WRAPPER (SAMA DENGAN MANAJEMEN SISWA) -->
  <div class="p-3 sm:p-6 overflow-x-auto">

    <table class="min-w-[700px] w-full border-collapse text-sm">

      <thead>
        <tr class="bg-slate-300 dark:bg-slate-600 text-left">
          <th class="p-3 border text-slate-700 dark:text-slate-100">No</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Nama</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Kelas</th>
          <th class="p-3 border text-center text-slate-700 dark:text-slate-100">
            Poin Aktif
          </th>
          <th class="p-3 border text-center text-slate-700 dark:text-slate-100">
            Total Sepanjang Waktu
          </th>
        </tr>
      </thead>

      <tbody id="poinTableBody">
        <tr>
          <td colspan="5"
              class="p-4 border text-center text-slate-700 dark:text-slate-200">
            Memuat data poin...
          </td>
        </tr>
      </tbody>

    </table>

  </div>
</div>


<!-- ================= RANKING SISWA ================= -->
<div class="mt-10">

  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 ml-6">
    üèÜ Ranking Siswa
  </h3>

  <!-- üîë PADDING WRAPPER (SAMA DENGAN MANAJEMEN SISWA) -->
  <div class="p-3 sm:p-6 overflow-x-auto">

    <table class="min-w-[700px] w-full border-collapse text-sm">

      <thead>
        <tr class="bg-slate-300 dark:bg-slate-600 text-left">
          <th class="p-3 border text-center text-slate-700 dark:text-slate-100">
            Rank
          </th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Nama</th>
          <th class="p-3 border text-slate-700 dark:text-slate-100">Kelas</th>
          <th class="p-3 border text-center text-slate-700 dark:text-slate-100">
            Total Poin
          </th>
        </tr>
      </thead>

      <tbody id="rankingTableBody">
        <tr>
          <td colspan="4"
              class="p-4 border text-center text-slate-700 dark:text-slate-200">
            Memuat ranking...
          </td>
        </tr>
      </tbody>

    </table>

  </div>
</div>




<!-- ============================= -->
<!-- CARD: DAFTAR SISWA BARU -->
<!-- ============================= -->
<div class="mt-6 bg-slate-100 dark:bg-slate-700  rounded-xl p-5">
  <h3 class="text-slate-700 dark:text-slate-100 font-semibold mb-4">‚ûï Daftarkan Siswa</h3>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

    <input id="inputNama" type="text"
      placeholder="Nama Siswa"
      class="px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-800 text-slate-700 dark:text-slate-100 border border-slate-500">

    <input id="inputNisn" type="text"
      placeholder="NISN"
      class="px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-800 text-slate-700 dark:text-slate-100 border border-slate-500">

    <input id="inputKelas" type="text"
      placeholder="Kelas (contoh: 7A)"
      class="px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-800 text-slate-700 dark:text-slate-100 border border-slate-500">

    <select id="inputGender"
      class="px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-800 text-slate-700 dark:text-slate-100 border border-slate-500">
       <option value="">Pilih Gender</option>
      <option value="Laki-laki">Laki-laki</option>
      <option value="Perempuan">Perempuan</option>
    </select>

  </div>

  <button id="btnSimpanSiswa"
    class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
    üíæ Simpan ke Database
  </button>

  <p id="infoSimpanSiswa" class="mt-3 text-sm"></p>
<!-- UNTUK MENCETAK -->
  <div id="akunResult"
     class="hidden mt-4 p-4 rounded-lg bg-slate-800 text-white text-sm space-y-2">

  <p class="font-semibold text-emerald-400">‚úÖ Akun berhasil dibuat</p>

  <p><b>Nama:</b> <span id="resNama"></span></p>
  <p><b>Email:</b> <span id="resEmail"></span></p>
  <p><b>Password:</b> <span id="resPassword"></span></p>

  <button id="btnCetakPdf"
    class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
    üìÑ Cetak PDF
  </button>
</div>

</div>


      </article>
    </section>

  </main>

  <!-- ===== FOOTER (PASTI NEMPEL) ===== -->
  <footer class="bg-gradient-to-r from-emerald-800 to-emerald-700
 text-white">
    <div class="max-w-7xl mx-auto px-6 py-6 text-center text-sm">
      <p class="opacity-90">
        ¬© 2025 <strong>Tarbiyyat al-Lughah</strong> ‚Äî
        Media Pembelajaran Membaca Bahasa Arab MTs
      </p>
      <p class="opacity-75 mt-1">
        Dikembangkan oleh Muh. Aprizal ‚Äî Mahasiswa PBA IAIN Bone
      </p>
    </div>
  </footer>


<!-- UNTUK CETAK -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


<!-- MAIN LOGIKA -->
<script type="module">
/* ======================================================
   1. FIREBASE IMPORT
====================================================== */
import { initializeApp, getApps } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  getDocs,
  getDoc,
  setDoc,
  deleteDoc,
  updateDoc,
  doc,
  query,
  where,
  orderBy,
  serverTimestamp,
  onSnapshot,
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getDatabase,
  ref,
  onValue,
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  import { getFunctions, httpsCallable } 
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";





/* ======================================================
   2. FIREBASE INIT
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
  authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
  projectId: "tarbiyyat-lughah-presence",
  databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
};

const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);

/* ======================================================
   3. DOM ELEMENTS
====================================================== */
const loginSection     = document.getElementById("login-section");
const dashboardSection = document.getElementById("dashboard-section");

const emailInput    = document.getElementById("emailGuru");
const passwordInput = document.getElementById("passwordGuru");
const loginError    = document.getElementById("loginError");

const btnLogin  = document.getElementById("btnLoginGuru");
const btnLogout = document.getElementById("btnLogout");

const tabelSubmissions = document.getElementById("tabelSubmissions");
const tabelSiswa       = document.getElementById("tabelSiswa");

/* ======================================================
   4. GLOBAL STATE
====================================================== */
let dashboardLoaded = false;
// let unsubscribeLeaderboard = null;


let dataSiswa   = [];   // cache data siswa
// let leaderboardMap = {};
let unsubUsers = null;


// -----LOAD DATA SISWA REALTIME
function listenDataSiswaRealtime() {
  if (unsubUsers) unsubUsers();

  const q = query(
    collection(db, "users"),
    where("role", "==", "student")
  );

  unsubUsers = onSnapshot(q, (snap) => {
    dataSiswa = snap.docs.map(d => ({
      uid: d.id,
      ...d.data()
    }));

    console.log("üî• DATA SISWA REALTIME:", dataSiswa);

    renderTabelSiswa(dataSiswa);
    renderPoinTable(dataSiswa);
    renderRankingFromUsers(dataSiswa); // ‚¨ÖÔ∏è INI KUNCI
  });
}


/* ======================================================
   5. UI HELPER
====================================================== */
function showLogin() {
  loginSection.classList.remove("hidden");
  dashboardSection.classList.add("hidden");
}

function showDashboard() {
  loginSection.classList.add("hidden");
  dashboardSection.classList.remove("hidden");
}

// ================= STATUS SISWA REALTIME =================
function listenStudentStatus(uid, el) {
  const statusRef = ref(rtdb, `status/${uid}`);

  onValue(statusRef, (snap) => {
    if (!snap.exists()) {
      el.innerHTML = `<span class="text-slate-400 text-xs">‚óè Offline</span>`;
      return;
    }

    const data = snap.val();
    const last = data.lastChanged || 0;
    const now = Date.now();

    // ‚è±Ô∏è jika lebih dari 20 detik ‚Üí anggap offline
    if (data.state === "online" && (now - last < 20000)) {
      el.innerHTML = `<span class="text-green-500 text-xs">‚óè Online</span>`;
    } else {
      el.innerHTML = `<span class="text-slate-400 text-xs">‚óè Offline</span>`;
    }
  });
}



/* ======================================================
   6. LOGIN & AUTH GUARD
====================================================== */
btnLogin.addEventListener("click", async () => {
  loginError.classList.add("hidden");
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passwordInput.value.trim()
    );
  } catch {
    loginError.textContent = "Email atau password salah";
    loginError.classList.remove("hidden");
  }
});

btnLogout.addEventListener("click", async () => {
  await signOut(auth);
  dashboardLoaded = false;
  showLogin();
});

onAuthStateChanged(auth, async (user) => {
  if (!user || user.isAnonymous) {
    showLogin();
    dashboardLoaded = false;
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    await setDoc(userRef, {
      email: user.email,
      role: "guru",
      createdAt: serverTimestamp()
    });
    location.reload();
    return;
  }

  if (snap.data().role !== "guru") {
    showLogin();
    dashboardLoaded = false;
    return;
  }

  showDashboard();
  // loadLeaderboard();
  listenDataSiswaRealtime();




  if (!dashboardLoaded) {
    loadDashboard();        // TUGAS
    loadNilaiSiswa();       // NILAI KUIS
    // loadSiswa();            // DATA SISWA
  
    dashboardLoaded = true;
  }
});


/* ======================================================
   7. DASHBOARD TUGAS
====================================================== */
function loadDashboard() {
  tabelSubmissions.innerHTML = `
    <tr><td colspan="7" class="p-4 text-center">Memuat...</td></tr>
  `;

  const q = query(
    collection(db, "submissions"),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    if (snap.empty) {
      tabelSubmissions.innerHTML = `
        <tr><td colspan="7" class="p-4 text-center">Belum ada tugas</td></tr>
      `;
      return;
    }

    tabelSubmissions.innerHTML = "";
    let no = 1;

    snap.forEach((d) => {
      const data = d.data();
      let waktu = "-";

      if (data.createdAt && typeof data.createdAt.toDate === "function") {
        waktu = data.createdAt.toDate().toLocaleString("id-ID");
      } else if (data.createdAtClient) {
        waktu = new Date(data.createdAtClient).toLocaleString("id-ID");
      }

      tabelSubmissions.innerHTML += `
        <tr>
          <td class="p-3 border font-semibold">${no++}</td>
          <td class="p-3 border font-semibold">${data.nama}</td>
          <td class="p-3 border font-bold">${data.kelas}</td>
          <td class="p-3 border font-semibold">${data.catatan || "-"}</td>
          <td class="p-3 border text-center font-semibold">
            ${
              data.driveLink
                ? `<a href="${data.driveLink}" target="_blank"
                     class="bg-blue-500 text-white px-3 py-1 rounded text-xs font-semibold">üìé Buka</a>`
                : "-"
            }
          </td>
          <td class="p-3 border font-semibold">${waktu}</td>
          <td class="p-3 border text-center font-semibold">
            <button onclick="hapusTugas('${d.id}')"
              class="bg-red-500 text-white px-3 py-1 rounded text-xs font-semibold">
              üóë Hapus
            </button>
          </td>
        </tr>
      `;
    });
  });
}


window.hapusTugas = async (id) => {
  if (!confirm("Hapus tugas ini?")) return;
  await deleteDoc(doc(db, "submissions", id));
  // ‚ùå TIDAK perlu loadDashboard()
};





/* ======================================================
   9. MANAJEMEN SISWA
====================================================== */
async function loadSiswa() {
  const snap = await getDocs(collection(db, "users"));
  dataSiswa = [];

  snap.forEach((docu) => {
    const d = docu.data();
    if (d.role !== "student") return;
    dataSiswa.push({ uid: docu.id, ...d });
  });

  renderTabelSiswa();
}

function renderTabelSiswa() {
  tabelSiswa.innerHTML = "";
  let no = 1;

  if (!Array.isArray(dataSiswa)) return;

  dataSiswa.forEach((d) => {
    const uid = d.uid;
    const nama = d.nama || "-";
    const nisn = d.nisn || "-";
    const kelas = d.kelas || "-";
    const gender = d.gender || "-";

    const statusId = `status-${uid}`;

    tabelSiswa.innerHTML += `
      <tr>
        <td class="p-3 border font-semibold">${no++}</td>
        <td class="p-3 border font-semibold">${nama}</td>
        <td class="p-3 border font-semibold">${nisn}</td>
        <td class="p-3 border font-bold">${kelas}</td>
        <td class="p-3 border font-semibold">${gender}</td>

        <td class="p-3 border font-semibold" id="${statusId}">
          <span class="text-slate-400 text-xs">‚óè Offline</span>
        </td>

        <td class="p-3 border text-center font-semibold">
          <button onclick="hapusSiswa('${uid}')"
            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold">
            üóë Hapus
          </button>
        </td>
      </tr>
    `;

    // ‚úÖ PASANG LISTENER STATUS DI SINI
    const statusEl = document.getElementById(statusId);
    if (statusEl && uid) {
      listenStudentStatus(uid, statusEl);
    }
  });
}


window.hapusSiswa = async (uid) => {
  if (!confirm("Hapus siswa ini?")) return;

  try {
    // 1Ô∏è‚É£ HAPUS DATA SISWA
    await deleteDoc(doc(db, "users", uid));

    // 2Ô∏è‚É£ HAPUS LEADERBOARD (INI YANG HILANG)
    await deleteDoc(doc(db, "leaderboard", uid));

    // (opsional tapi bagus)
    console.log("Siswa & leaderboard terhapus:", uid);

    // 3Ô∏è‚É£ RELOAD DATA
    loadSiswa();

  } catch (err) {
    console.error("Gagal menghapus siswa:", err);
    alert("Terjadi kesalahan saat menghapus siswa");
  }
};



/* ======================================================
   10. DAFTARKAN SISWA BARU (CLOUD FUNCTION)
====================================================== */

document.getElementById("btnSimpanSiswa").addEventListener("click", async () => {

  const nama   = inputNama.value.trim();
  const nisn   = inputNisn.value.trim();
  const kelas  = inputKelas.value.trim();
  const gender = inputGender.value;

  if (!nama || !nisn || !kelas || !gender) {
    alert("Data belum lengkap");
    return;
  }

  const payload = { nama, nisn, kelas, gender };
  console.log("DATA DIKIRIM:", payload);

  try {
    // 1Ô∏è‚É£ KIRIM KE CLOUD FUNCTION
    const res = await fetch(
      "https://asia-southeast1-tarbiyyat-lughah-presence.cloudfunctions.net/createStudentAccount",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    // 2Ô∏è‚É£ AMBIL RESPONSE JSON
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Gagal membuat siswa");
    }

    // 3Ô∏è‚É£ TAMPILKAN HASIL AKUN
    document.getElementById("akunResult").classList.remove("hidden");
    document.getElementById("resNama").textContent     = nama;
    document.getElementById("resEmail").textContent    = data.email;
    document.getElementById("resPassword").textContent = data.password;

    // 4Ô∏è‚É£ SIAPKAN DATA PDF
    const dataPdf = {
      nama,
      nisn,
      kelas,
      email: data.email,
      password: data.password
    };

    // 5Ô∏è‚É£ CETAK PDF SAAT TOMBOL DIKLIK
    document.getElementById("btnCetakPdf").onclick = () => {
      generateAkunPdf(dataPdf);
    };

    // 6Ô∏è‚É£ RESET FORM
    inputNama.value = "";
    inputNisn.value = "";
    inputKelas.value = "";
    inputGender.value = "";

  } catch (err) {
    console.error(err);
    alert("‚ùå " + err.message);
  }
});


// ================= NILAI SISWA REALTIME =================
function loadNilaiSiswa() {
  const tbody = document.getElementById("nilaiTableBody");

  const q = query(
    collection(db, "quizResults"),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snapshot) => {
    tbody.innerHTML = "";

    if (snapshot.empty) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-4 py-6 text-center text-slate-500">
            Belum ada data nilai
          </td>
        </tr>
      `;
      return;
    }

    let no = 1;
    snapshot.forEach((doc) => {
      const d = doc.data();
      const waktu = d.createdAt?.toDate
        ? d.createdAt.toDate().toLocaleString("id-ID")
        : "-";

      tbody.innerHTML += `
        <tr class="border-t border-slate-200 dark:border-slate-500">
          <td class="px-3 py-2 font-semibold">${no++}</td>
          <td class="px-3 py-2 font-semibold">${d.nama}</td>
          <td class="px-3 py-2 font-semibold">${d.kelas}</td>
          <td class="px-3 py-2 font-semibold">${d.quizTitle}</td>
          <td class="px-3 py-2 text-center font-bold">
            ${d.score} / ${d.totalSoal}
          </td>
          <td class="px-3 py-2 font-semibold">${waktu}</td>
          <td class="text-center">
            <button
            onclick="hapusNilai('${doc.id}')"
            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
            üóë Hapus
            </button>
          </td>
        </tr>
      `;
    });
  });
}

// RENDER TOTAL POIN
function renderPoinTable() {
  const tbody = document.getElementById("poinTableBody");
  if (!tbody) return;

  tbody.innerHTML = "";
  let no = 1;

  dataSiswa.forEach(s => {
    tbody.innerHTML += `
      <tr>
        <td class="p-3 border font-bold">${no++}</td>
        <td class="p-3 border font-semibold">${s.nama}</td>
        <td class="p-3 border font-bold">${s.kelas}</td>
        <td class="p-3 border text-center font-bold">-</td>
        <td class="p-3 border text-center font-bold">
          ${s.poinTotal ?? 0}
        </td>
      </tr>
    `;
  });
}

// ===============================
// RENDER RANKING SISWA
// ===============================
function renderRankingFromUsers(users) {
  const tbody = document.getElementById("rankingTableBody");
  if (!tbody) return;

  tbody.innerHTML = "";

  if (!Array.isArray(users) || users.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4 text-slate-500">
          Belum ada data ranking
        </td>
      </tr>`;
    return;
  }

  const sorted = [...users].sort(
    (a, b) => (Number(b.poinTotal) || 0) - (Number(a.poinTotal) || 0)
  );

  sorted.forEach((u, i) => {
    tbody.innerHTML += `
      <tr>
        <td class="p-3 border text-center font-bold">${i + 1}</td>
        <td class="p-3 border font-semibold">${u.nama ?? "-"}</td>
        <td class="p-3 border font-bold">${u.kelas ?? "-"}</td>
        <td class="p-3 border text-center font-bold">
          ${u.poinTotal ?? 0}
        </td>
      </tr>
    `;
  });
}


console.log("DATA SISWA:", dataSiswa);



// RESET POIN
const resetBtn = document.getElementById("resetPoinBtn");

resetBtn.addEventListener("click", async () => {
  const yakin = confirm(
    "Yakin reset poin hari ini?\n\n" +
    "‚úî Poin aktif akan di-reset\n" +
    "‚úñ Total sepanjang waktu tetap"
  );

  if (!yakin) return;

  try {
    const snapshot = await getDocs(collection(db, "users"));

    for (const docSnap of snapshot.docs) {
      const data = docSnap.data();

      // hanya reset siswa
      if (data.role === "student") {
        await updateDoc(doc(db, "users", docSnap.id), {
          poin: 0
        });
      }
    }

    alert("‚úÖ Poin hari ini berhasil di-reset!");
  } catch (err) {
    console.error(err);
    alert("‚ùå Gagal reset poin");
  }
});

// ================= RESET TOTAL POIN SEPANJANG WAKTU =================
const resetTotalBtn = document.getElementById("resetPoinTotalBtn");

resetTotalBtn.addEventListener("click", async () => {
  if (!confirm("Reset SEMUA poin siswa?")) return;

  try {
    const snapshot = await getDocs(
      query(collection(db, "users"), where("role", "==", "student"))
    );

    for (const u of snapshot.docs) {
      await updateDoc(doc(db, "users", u.id), {
        poin: 0,
        poinTotal: 0
      });
    }

    alert("‚úÖ Semua poin siswa berhasil di-reset total!");
  } catch (err) {
    console.error(err);
    alert("‚ùå Gagal reset total poin");
  }
});




// FITUR HAPUS HASIL 
window.hapusNilai = async function (docId) {
  const yakin = confirm(
    "Yakin hapus data nilai ini?\n\n" +
    "‚ùó Data yang dihapus tidak bisa dikembalikan."
  );

  if (!yakin) return;

  try {
    await deleteDoc(doc(db, "quizResults", docId));
    alert("‚úÖ Data nilai berhasil dihapus");
  } catch (err) {
    console.error(err);
    alert("‚ùå Gagal menghapus data");
  }
};



// UNTUK MENCETAK
function generateAkunPdf(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("AKUN SISWA", 105, 20, { align: "center" });

  doc.setFontSize(11);
  doc.text("Tarbiyyat al-Lughah", 105, 28, { align: "center" });

  doc.line(20, 32, 190, 32);

  let y = 45;
  const line = (label, value) => {
    doc.text(`${label}`, 30, y);
    doc.text(`: ${value}`, 70, y);
    y += 8;
  };

  line("Nama", data.nama);
  line("NISN", data.nisn);
  line("Kelas", data.kelas);

  y += 6;

  line("Email", data.email);
  line("Password Awal", data.password);

  y += 10;

  doc.setFontSize(10);
  doc.text(
    "CATATAN:\n- Password ini hanya untuk login pertama\n- Siswa WAJIB mengganti password\n- Jangan dibagikan ke orang lain",
    30,
    y
  );

  doc.setFontSize(9);
  doc.text(
    `Dicetak pada: ${new Date().toLocaleString("id-ID")}`,
    30,
    280
  );

  const fileName = `akun-siswa-${data.nama}-${data.kelas}.pdf`
    .replace(/\s+/g, "_");

  doc.save(fileName);
}



</script>

<!-- JS DARK MODE -->
<script>
const html = document.documentElement;
const toggle = document.getElementById("darkToggle");

// cek preferensi awal
if (localStorage.theme === "dark") {
  html.classList.add("dark");
  toggle.textContent = "‚òÄÔ∏è";
}

// toggle klik
toggle.addEventListener("click", () => {
  html.classList.toggle("dark");

  if (html.classList.contains("dark")) {
    localStorage.theme = "dark";
    toggle.textContent = "‚òÄÔ∏è";
  } else {
    localStorage.theme = "light";
    toggle.textContent = "üåô";
  }
});
</script>

  <!-- Aktifkan mode global (1 angka untuk seluruh situs) -->
<script>
  window.PRESENCE_OPTIONS = { mode: "global" };
</script>

<!-- Panggil script presence -->
<script type="module" src="./assets/presence.js"></script>



</body>
</html>
