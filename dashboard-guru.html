<!DOCTYPE html>
<html lang="id" dir="ltr">

<script src="assets/theme.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Dashboard Guru</title>
  <link href="assets/css/styles.css" rel="stylesheet">



  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="min-h-screen flex flex-col bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans antialiased selection:bg-teal-500 selection:text-white">


  <!-- ===== HEADER DASHBOARD GURU ===== -->
  <header
    class="sticky top-0 z-50 w-full bg-emerald-700/95 dark:bg-slate-900/95 backdrop-blur-md text-white shadow-lg border-b border-white/10 transition-all">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-3.5 flex items-center justify-between">

      <div class="flex items-center gap-2 md:gap-4">
        <div class="p-2 bg-white/10 rounded-xl shadow-inner">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 md:w-7 md:h-7 text-emerald-100" fill="none"
            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <div class="flex flex-col">
          <span class="text-lg md:text-xl font-black tracking-tighter leading-none italic uppercase">Tarbiyyat</span>
          <span
            class="text-[9px] md:text-[10px] font-bold tracking-[0.2em] text-emerald-200 uppercase leading-none mt-1 text-center sm:text-left">al-Lughah</span>
        </div>
      </div>

      <div class="flex items-center gap-3 md:gap-6">

        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center gap-3 md:gap-6">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-white/10 rounded-lg border border-white/10">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-300"></span>
              </span>
              <span class="text-[10px] font-black uppercase tracking-widest text-emerald-50">Sistem Informasi Guru</span>
            </div>

            <a href="index.html"
              class="text-[11px] md:text-sm font-bold bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl border border-white/20 transition-all active:scale-95">
              Beranda
            </a>

            <button id="darkToggle" class="flex items-center justify-center w-9 h-9 md:w-10 md:h-10 rounded-xl 
                   bg-white text-emerald-700 dark:bg-slate-800 dark:text-emerald-400
                   transition-all active:scale-90 text-base shadow-sm hover:shadow-md" title="Ganti Tema">
              ðŸŒ™
            </button>
        </div>

        <!-- Mobile Menu Button -->
        <div class="flex md:hidden items-center gap-2">
            <a id="mobile-back-btn" href="index.html" class="flex items-center justify-center w-9 h-9 rounded-xl 
                   bg-white/10 text-white border border-white/20
                   transition-all active:scale-90 text-sm shadow-sm" title="Kembali">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
            </a>
            <button id="darkToggleMobile" class="flex items-center justify-center w-9 h-9 rounded-xl 
                   bg-white/10 text-white border border-white/20
                   transition-all active:scale-90 text-sm shadow-sm">
              ðŸŒ™
            </button>
            <button id="mobile-menu-btn" class="hidden p-2 bg-white/10 rounded-xl border border-white/20 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>

      </div>

    </div>

    <!-- Mobile Dropdown -->
    <div id="mobile-menu" class="hidden md:hidden border-t border-white/10 bg-emerald-800 dark:bg-slate-900">
        <div class="p-4 space-y-2">
            <button onclick="navToSection('materiSectionHeader', 'themeContent', 'toggleMateri')" class="block w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm">
                ðŸ“š Manajemen Materi (Upload)
            </button>
            <button onclick="navToSection('registerStudentHeader', 'registerStudentContent', 'toggleRegisterStudent')" class="block w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm">
                ðŸŽ“ Daftarkan Siswa
            </button>
            <div class="h-px bg-white/10 my-2"></div>
            <button id="btnLogoutMobile" class="block w-full text-left px-4 py-3 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-red-100 font-bold text-sm border border-red-500/30">
                ðŸšª Keluar / Logout
            </button>
        </div>
    </div>
  </header>

  <script>
      // Mobile Menu Toggle
      const btnMob = document.getElementById('mobile-menu-btn');
      const menuMob = document.getElementById('mobile-menu');
      if(btnMob && menuMob){
          btnMob.addEventListener('click', () => {
              menuMob.classList.toggle('hidden');
          });
          // Auto close when clicking any button inside
          menuMob.querySelectorAll("button").forEach(btn => {
             btn.addEventListener("click", () => {
                 menuMob.classList.add("hidden");
             });
          });
      }
      // Logout Mobile Proxy
      document.getElementById('btnLogoutMobile')?.addEventListener('click', () => {
          document.getElementById('btnLogout').click();
      });
      // Dark Toggle Mobile Proxy
      document.getElementById('darkToggleMobile')?.addEventListener('click', () => {
          document.getElementById('darkToggle').click();
      });

      // NAVIGATION HELPERS
      window.smoothScrollTo = function(id) {
          const el = document.getElementById(id);
          if(!el) return;
          const headerOffset = 100;
          const elementPosition = el.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
          window.scrollTo({
              top: offsetPosition,
              behavior: "smooth"
          });
      };

      window.navToSection = function(headerId, contentId, toggleFn) {
          const content = document.getElementById(contentId);
          // Toggle if hidden
          if(content && content.classList.contains('hidden')) {
              if(typeof window[toggleFn] === 'function') {
                  window[toggleFn]();
              }
          }
          // Scroll to Header
          setTimeout(() => {
              window.smoothScrollTo(headerId);
          }, 100);
      };
  </script>

  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Tunggu feather if exists
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
      
      const passGuru = document.getElementById("passwordGuru");
      const toggleGuru = document.getElementById("togglePasswordGuru");
      
      if (toggleGuru && passGuru) {
        toggleGuru.addEventListener("click", () => {
          const type = passGuru.getAttribute("type") === "password" ? "text" : "password";
          passGuru.setAttribute("type", type);
          
          const icon = toggleGuru.querySelector('i');
          if (type === "password") {
            icon.setAttribute('data-feather', 'eye');
          } else {
            icon.setAttribute('data-feather', 'eye-off');
          }
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        });
      }
    });
  </script>

  <script>
    function toggleSessionList() {
      const content = document.getElementById("sessionListContent");
      const chevron = document.getElementById("sessionChevron");

      if (!content || !chevron) return;

      content.classList.toggle("hidden");

      if (content.classList.contains("hidden")) {
        chevron.classList.add("-rotate-90");
      } else {
        chevron.classList.remove("-rotate-90");
      }
    }
  </script>
  <!-- ===== MAIN (PENYANGGA FOOTER) ===== -->
  <main class="flex-grow flex items-center justify-center">

    <!-- ===============================
         LOGIN GURU
    ================================ -->
    <section id="login-section" class="w-full max-w-2xl mx-auto px-0 sm:px-4 py-8 md:py-24">
      <article
        class="bg-white dark:bg-slate-800 border-x-0 sm:border border-slate-200 dark:border-slate-700 rounded-none sm:rounded-[2rem] shadow-2xl overflow-hidden transition-all">

        <div
          class="bg-gradient-to-br from-emerald-600 to-emerald-800 text-white py-14 px-6 text-center relative overflow-hidden">
          <div class="absolute -top-10 -left-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
          <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-emerald-400/10 rounded-full blur-3xl"></div>

          <div class="relative z-10">
            <div
              class="inline-flex items-center justify-center w-14 h-14 bg-white/20 rounded-2xl backdrop-blur-md mb-4 shadow-xl">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
            <h3 class="text-2xl md:text-3xl font-black tracking-tight italic uppercase">Login Dashboard Guru</h3>
            <p class="text-emerald-100 text-[10px] md:text-xs mt-2 font-bold uppercase tracking-[0.4em] opacity-80">
              Sistem Manajemen Pembelajaran</p>
          </div>
        </div>

        <div class="p-8 md:p-12 space-y-8">

          <div class="grid grid-cols-1 gap-6">
            <div class="space-y-2">
              <label class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">ID
                / Email Resmi Guru</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-emerald-600/50">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </span>
                <input id="emailGuru" type="email" placeholder="contoh: guru@tarbiyyat.com"
                  class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none transition-all appearance-none">
              </div>
            </div>

            <div class="space-y-2">
              <label
                class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-1">Kata
                Sandi Dashboard</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-emerald-600/50">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </span>
                <input id="passwordGuru" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  class="w-full pl-12 pr-12 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl 
                          text-slate-800 dark:text-white text-base focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none transition-all appearance-none">
                <button type="button" id="togglePasswordGuru" class="absolute inset-y-0 right-4 flex items-center text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
                  <i data-feather="eye" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="pt-2">
            <button id="btnLoginGuru"
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 md:py-5 rounded-2xl font-black uppercase tracking-widest 
                       shadow-xl shadow-emerald-500/30 transition-all active:scale-[0.97] flex items-center justify-center gap-3 text-sm md:text-base">
              <span>Otorisasi Masuk</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </button>
          </div>

          <div id="loginError" class="hidden">
            <div
              class="flex items-center gap-3 p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50">
              <div class="bg-red-500 text-white rounded-full p-1.5 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <p class="text-xs font-bold text-red-700 dark:text-red-400 italic">Otoritas ditolak. Email atau password
                salah.</p>
            </div>
          </div>

        </div>

        <div
          class="px-8 py-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 text-center">
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-relaxed">
            Sistem Keamanan Terpadu <br class="sm:hidden"> Tarbiyyat al-Lughah &copy; 2026
          </p>
        </div>

      </article>
    </section>

    <!-- ===============================
         DASHBOARD TUGAS (HIDDEN DEFAULT)
    ================================ -->
    <section id="dashboard-section" class="w-full max-w-7xl mx-auto px-0 sm:px-6 py-4 sm:py-10 pb-32 hidden">

      <article
        class="bg-white dark:bg-slate-800 border-x-0 sm:border border-slate-200 dark:border-slate-700 rounded-none sm:rounded-[2.5rem] shadow-2xl overflow-hidden transition-all">

        <div
          class="bg-gradient-to-r from-emerald-600 via-emerald-700 to-emerald-800 text-white px-6 py-8 md:px-10 md:py-12 flex flex-col md:flex-row md:items-center md:justify-between gap-6 relative overflow-hidden">

          <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-20 -mt-20 blur-3xl"></div>

          <div class="relative z-10 flex flex-col md:flex-row items-center gap-5">
            <div class="p-4 bg-white/20 rounded-2xl backdrop-blur-md shadow-lg border border-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
            <div class="text-center md:text-left">
              <h3 class="text-2xl md:text-3xl font-black tracking-tight italic uppercase">Panel Utama Guru</h3>
              <div class="flex flex-col sm:flex-row items-center gap-2 mt-1">
                <span
                  class="text-xs font-bold text-emerald-100 uppercase tracking-widest bg-emerald-900/30 px-3 py-1 rounded-full border border-emerald-500/30">Manajemen
                  Data Siswa</span>
                <span class="hidden sm:inline text-emerald-300">â€¢</span>
                <p class="text-xs text-emerald-100/80 font-medium">Pantau perkembangan maharah qira'ah secara real-time
                </p>
              </div>
            </div>
          </div>

          <div class="relative z-10 flex justify-center md:justify-end">
            <button id="btnLogout"
              class="group flex items-center gap-2 bg-white/10 hover:bg-red-500 text-white px-6 py-3 rounded-xl text-sm font-black uppercase tracking-widest border border-white/20 transition-all active:scale-95 shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Keluar
            </button>
          </div>
        </div>

        <!-- DASHBOARD TUGAS -->
        <div class="mt-12 mb-12 px-1 max-w-5xl mx-auto">

          <div
            class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div onclick="toggleSubmissions()"
              class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">

              <div class="flex items-center gap-3">
                <div class="p-2 bg-pink-100 dark:bg-pink-900/30 rounded-lg text-pink-600 dark:text-pink-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                      d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                    Daftar Pengumpulan Tugas
                  </h3>
                  <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                    Memantau file tugas yang dikirim oleh siswa.
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <span id="submissionCount"
                  class="text-xs bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-400 px-2 py-0.5 rounded-full font-bold">0</span>
                <span
                  class="text-xs text-slate-400 hidden md:inline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                  Klik untuk buka/tutup
                </span>
                <svg id="submissionChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </div>
            </div>

            <div id="submissionContent" class="hidden">

              <div class="overflow-x-auto w-full">
                <table class="w-full text-sm text-left">

                  <thead
                    class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                      <th class="px-6 py-4 whitespace-nowrap w-[20px]">No</th>
                      <th class="px-6 py-4 whitespace-nowrap min-w-[150px]">Nama Siswa</th>
                      <th class="px-6 py-4 whitespace-nowrap">Kelas</th>
                      <th class="px-6 py-4 whitespace-nowrap min-w-[200px]">Catatan Siswa</th>
                      <th class="px-6 py-4 whitespace-nowrap text-center">File Tugas</th>
                      <th class="px-6 py-4 whitespace-nowrap">Waktu Kirim</th>
                      <th class="px-6 py-4 text-center whitespace-nowrap">Aksi</th>
                    </tr>
                  </thead>

                  <tbody id="tabelSubmissions"
                    class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">

                    <tr>
                      <td colspan="7" class="px-6 py-10 text-center text-slate-400 dark:text-slate-500 italic">
                        <div class="flex flex-col items-center justify-center gap-2">
                          <svg class="w-6 h-6 animate-spin text-pink-500 opacity-50" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                          </svg>
                          <span>Sedang memuat data tugas...</span>
                        </div>
                      </td>
                    </tr>

                  </tbody>
                </table>
              </div>

              <div
                class="px-6 py-4 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <span class="text-xs text-slate-400">Menampilkan data terbaru</span>
              </div>

            </div>
          </div>
        </div>

          <script>
            function toggleSubmissions() {
              const content = document.getElementById("submissionContent");
              const chevron = document.getElementById("submissionChevron");

              if (!content || !chevron) return;

              content.classList.toggle("hidden");

              // Rotate chevron
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
              }
            }
          </script>


          <!-- ===============================
     MANAJEMEN SISWA
=============================== -->
          <div class="mb-12 px-1 max-w-5xl mx-auto">

            <div
              class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

              <div onclick="toggleStudents()"
                class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">

                <div class="flex items-center gap-3">
                  <div class="p-2 bg-cyan-100 dark:bg-cyan-900/30 rounded-lg text-cyan-600 dark:text-cyan-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                      <circle cx="9" cy="7" r="4" />
                      <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                      Manajemen Siswa
                    </h3>
                    <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                      Daftar seluruh siswa yang terdaftar dalam sistem.
                    </p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="studentCount"
                    class="text-xs bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-400 px-2 py-0.5 rounded-full font-bold">0</span>
                  <span
                    class="text-xs text-slate-400 hidden md:inline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                    Klik untuk buka/tutup
                  </span>
                  <svg id="studentChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="2.5" stroke="currentColor"
                    class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </div>

              </div>

              <div id="studentContent" class="hidden">

                <div class="overflow-x-auto w-full">
                  <table class="w-full text-sm text-left">

                    <thead
                      class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                      <tr>
                        <th class="px-6 py-4 whitespace-nowrap w-[20px]">No</th>
                        <th class="px-6 py-4 whitespace-nowrap min-w-[200px]">Nama Lengkap</th>
                        <th class="px-6 py-4 whitespace-nowrap">NISN</th>
                        <th class="px-6 py-4 whitespace-nowrap">Kelas</th>
                        <th class="px-6 py-4 whitespace-nowrap text-center">Gender</th>
                        <th class="px-6 py-4 whitespace-nowrap text-center">Status</th>
                        <th class="px-6 py-4 whitespace-nowrap text-center">Aksi</th>
                      </tr>
                    </thead>

                    <tbody id="tabelSiswa"
                      class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">

                      <tr>
                        <td colspan="7" class="px-6 py-10 text-center text-slate-400 dark:text-slate-500 italic">
                          <div class="flex flex-col items-center justify-center gap-2">
                            <svg class="w-6 h-6 animate-spin text-cyan-500 opacity-50"
                              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                              </circle>
                              <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                              </path>
                            </svg>
                            <span>Memuat data siswa...</span>
                          </div>
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>

                <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-700">
                  <p class="text-xs text-slate-400 text-center sm:text-left">
                    Menampilkan seluruh data siswa aktif.
                  </p>
                </div>

              </div>

            </div>
          </div>
          <script>
            function toggleStudents() {
              const content = document.getElementById("studentContent");
              const chevron = document.getElementById("studentChevron");

              if (!content || !chevron) return;

              content.classList.toggle("hidden");

              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
              }
            }
          </script>
        </div>



        <!-- ===============================
             JOKER CARD: MANAJEMEN FLASHCARDS
        =============================== -->
        <div class="mb-12 px-1 max-w-5xl mx-auto">
          <div class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            
            <div onclick="toggleFlashcards()" class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">
               <div class="flex items-center gap-3">
                 <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                   <i data-feather="layers" class="w-6 h-6"></i>
                 </div>
                 <div>
                   <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                     Manajemen Flashcards
                   </h3>
                   <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                     Kelola kosakata untuk game interaktif.
                   </p>
                 </div>
               </div>
               
               <div class="flex items-center gap-2">
                 <span id="flashcardCount" class="text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded-full font-bold">0</span>
                 <svg id="flashcardChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                      stroke-width="2.5" stroke="currentColor" 
                      class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                 </svg>
               </div>
            </div>

            <div id="flashcardContent" class="hidden">
              
              <!-- Toolbar & Input Form -->
              <div class="p-4 md:p-6 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700 space-y-4">
                
                <!-- Utilities Row -->
                <div class="flex flex-wrap gap-3 justify-between items-center">
                  <div class="flex gap-2">
                     <button onclick="migrateVocabs()" id="btnMigrate" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-amber-500/20 transition-all">
                       <i data-feather="upload-cloud" class="w-4 h-4"></i> Migrasi Data Lama
                     </button>
                  </div>
                  <div class="relative w-full md:w-auto">
                    <input type="text" id="searchFlashcard" placeholder="Cari kata..." 
                           class="pl-9 pr-4 py-2 rounded-xl text-xs bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none w-full md:w-48 shadow-sm">
                    <i data-feather="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                  </div>
                </div>

                <!-- Input Form Row -->
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30 shadow-sm">
                   <h4 class="text-xs font-bold uppercase text-indigo-500 mb-3 tracking-wider flex items-center gap-2">
                     <i data-feather="plus-circle" class="w-3.5 h-3.5"></i> Tambah Kosakata Baru
                   </h4>
                   <div class="grid grid-cols-1 md:grid-cols-[1fr_1fr_0.8fr_auto] gap-3 items-end">
                      
                      <!-- Input Arab -->
                      <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Arab</label>
                        <input type="text" id="inNewAr" dir="rtl" placeholder="Contoh: ÙƒÙØªÙŽØ§Ø¨ÙŒ" 
                            class="w-full px-3 py-2.5 text-right rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none font-arab text-lg shadow-sm transition-all">
                      </div>

                      <!-- Input Indo -->
                      <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Indonesia</label>
                        <input type="text" id="inNewId" placeholder="Contoh: Buku" 
                            class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none text-sm shadow-sm transition-all">
                      </div>

                      <!-- Input Tema -->
                      <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Tema</label>
                        <input type="text" id="inNewTema" placeholder="umum" 
                            class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none text-sm shadow-sm transition-all">
                      </div>

                      <!-- Button -->
                      <button onclick="addFlashcardInline()" class="w-full md:w-auto h-[42px] px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                          <i data-feather="save" class="w-4 h-4"></i>
                          <span class="md:hidden">Simpan</span>
                      </button>
                   </div>
                </div>

              </div>

              <!-- Table -->
              <!-- Dynamic List Container (Accordions) -->
              <div id="flashcardListContainer" class="p-4 space-y-3 min-h-[200px]">
                 <p class="text-center text-slate-400 italic py-10">Memuat data flashcards...</p>
              </div>

            </div>
          </div>
        </div>

        <script>
            function toggleFlashcards() {
              const content = document.getElementById("flashcardContent");
              const chevron = document.getElementById("flashcardChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
                loadFlashcards(); // Load data when opened
              }
            }
        </script>

        <!-- ===============================
             JOKER CARD: MANAJEMEN GAME HARAKAT
        =============================== -->
        <div class="mb-12 px-1 max-w-5xl mx-auto">
          <div class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            
            <div onclick="toggleHarakat()" class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">
               <div class="flex items-center gap-3">
                 <div class="p-2 bg-pink-100 dark:bg-pink-900/30 rounded-lg text-pink-600 dark:text-pink-400">
                   <i data-feather="crosshair" class="w-6 h-6"></i>
                 </div>
                 <div>
                   <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                     Manajemen Game Harakat
                   </h3>
                   <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                     Kelola soal untuk mini-game tebak harakat.
                   </p>
                 </div>
               </div>
               
               <div class="flex items-center gap-2">
                 <span id="harakatCount" class="text-xs bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-400 px-2 py-0.5 rounded-full font-bold">0</span>
                 <svg id="harakatChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                      stroke-width="2.5" stroke="currentColor" 
                      class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                 </svg>
               </div>
            </div>

            <div id="harakatContent" class="hidden">
              
              <!-- Toolbar & Input Form -->
              <div class="p-4 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700">
                
                <h4 class="text-xs font-bold uppercase text-pink-500 mb-3 tracking-wider flex items-center gap-2">
                   <i data-feather="plus-circle" class="w-3.5 h-3.5"></i> Tambah Soal Harakat
                </h4>

                <div class="grid grid-cols-1 md:grid-cols-[1fr_1fr_1fr_auto] gap-3 items-end">
                   <!-- Gundul -->
                   <div>
                      <label class="block text-[10px] font-bold text-slate-400 mb-1">Arab Gundul (Plain)</label>
                      <input type="text" id="inNewHarakatPlain" dir="rtl" placeholder="Contoh: ÙƒØªØ¨" 
                         class="w-full px-3 py-2.5 text-right rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-pink-500 outline-none font-arab text-lg shadow-sm transition-all">
                   </div>
                   
                   <!-- Harakat -->
                   <div>
                       <label class="block text-[10px] font-bold text-slate-400 mb-1">Arab Berharakat</label>
                       <input type="text" id="inNewHarakatAns" dir="rtl" placeholder="Contoh: ÙƒÙŽØªÙŽØ¨ÙŽ" 
                          class="w-full px-3 py-2.5 text-right rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-pink-500 outline-none font-arab text-lg shadow-sm transition-all">
                   </div>

                   <!-- Hint -->
                   <div>
                       <label class="block text-[10px] font-bold text-slate-400 mb-1">Arti / Hint</label>
                       <input type="text" id="inNewHarakatHint" placeholder="Contoh: Menulis" 
                          class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-pink-500 outline-none text-sm shadow-sm transition-all">
                   </div>

                   <!-- Save Button -->
                   <button onclick="addHarakatInline()" class="w-full md:w-auto h-[42px] px-6 bg-pink-600 hover:bg-pink-700 text-white rounded-xl font-bold shadow-lg shadow-pink-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                       <i data-feather="save" class="w-4 h-4"></i>
                       <span class="md:hidden">Simpan</span>
                   </button>
                </div>
                
                <!-- Migration Button (Legacy) -->
                <div class="mt-4 pt-4 border-t border-slate-200/50 dark:border-slate-700/50 flex justify-end">
                   <button onclick="migrateHarakatData()" id="btnMigrateHarakat" class="hidden flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow transition-all">
                      <i data-feather="upload-cloud" class="w-3 h-3"></i> Migrasi Data Statis
                   </button>
                </div>

              </div>

              <!-- List Container -->
              <div id="harakatListContainer" class="p-4 space-y-3 min-h-[200px]">
                 <p class="text-center text-slate-400 italic py-10">Memuat data harakat...</p>
              </div>

            </div>
          </div>
        </div>

        <script>
            function toggleHarakat() {
              const content = document.getElementById("harakatContent");
              const chevron = document.getElementById("harakatChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
                loadHarakatQuestions(); // Load data when opened
              }
            }
        </script>

        <!-- ===============================
             JOKER CARD: MANAJEMEN GAME SUSUN KALIMAT
        =============================== -->
        <div class="mb-12 px-1 max-w-5xl mx-auto">
          <div class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            
            <div onclick="toggleSentenceGame()" class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">
               <div class="flex items-center gap-3">
                 <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                   <i data-feather="grid" class="w-6 h-6"></i>
                 </div>
                 <div>
                   <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                     Manajemen Game Susun Kalimat
                   </h3>
                   <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                     Kelola soal untuk mini-game menyusun kalimat Arab.
                   </p>
                 </div>
               </div>
               
               <div class="flex items-center gap-2">
                 <span id="sentenceCount" class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded-full font-bold">0</span>
                 <svg id="sentenceChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                      stroke-width="2.5" stroke="currentColor" 
                      class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                 </svg>
               </div>
            </div>

            <div id="sentenceContent" class="hidden">
              <div class="p-4 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700">
                 <h4 class="text-xs font-bold uppercase text-blue-500 mb-3 tracking-wider flex items-center gap-2">
                   <i data-feather="plus-circle" class="w-3.5 h-3.5"></i> Tambah Soal Susun Kalimat
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-[80px_1fr_1fr_auto] gap-3 items-start">
                    <!-- Level -->
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Level</label>
                         <input type="number" id="sNewLevel" placeholder="1" 
                           class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 outline-none font-bold shadow-sm transition-all">
                    </div>
                    
                    <!-- Title & Desc -->
                    <div class="space-y-2">
                       <div>
                         <label class="block text-[10px] font-bold text-slate-400 mb-1">Judul / Pola</label>
                         <input type="text" id="sNewTitle" placeholder="Contoh: Jumlah Ismiah" 
                            class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 outline-none text-sm shadow-sm transition-all">
                       </div>
                       <div>
                         <input type="text" id="sNewDesc" placeholder="Deskripsi Singkat (Opsional)" 
                            class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 outline-none text-xs shadow-sm transition-all">
                       </div>
                    </div>

                    <!-- Correct Words -->
                    <div>
                         <label class="block text-[10px] font-bold text-slate-400 mb-1">Susunan Kata (Arab)</label>
                         <input type="text" id="sNewCorrect" dir="rtl" placeholder="Contoh: Ø£ÙƒÙ„, Ø£Ø­Ù…Ø¯, Ø§Ù„Ø±Ø²" 
                            class="w-full px-3 py-2.5 text-right rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 outline-none font-arab text-lg shadow-sm transition-all">
                         <p class="text-[10px] text-slate-400 mt-1 italic">* Pisahkan setiap kata dengan koma (,)</p>
                    </div>

                    <!-- Button -->
                    <div class="h-full flex items-end pb-1">
                       <button onclick="addSentenceQuestion()" class="w-full md:w-auto h-[42px] px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                           <i data-feather="save" class="w-4 h-4"></i>
                           <span class="md:hidden">Simpan</span>
                       </button>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200/50 dark:border-slate-700/50 flex justify-end">
                   <button onclick="migrateSentenceData()" id="btnMigrateSentence" class="hidden flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow transition-all">
                      <i data-feather="upload-cloud" class="w-3 h-3"></i> Migrasi Data Statis
                   </button>
                </div>
              </div>

              <!-- List Container -->
              <div id="sentenceListContainer" class="p-4 space-y-3 min-h-[200px]">
                 <p class="text-center text-slate-400 italic py-10">Memuat data soal...</p>
              </div>
            </div>
          </div>
        </div>

        <script>
            function toggleSentenceGame() {
              const content = document.getElementById("sentenceContent");
              const chevron = document.getElementById("sentenceChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
                loadSentenceQuestions(); // Function name in the upcoming script
              }
            }
        </script>

        <!-- ===============================
             MANAJEMEN GAME TEBAK JENIS KATA (GRAMMAR)
        =============================== -->
        <div class="mb-12 px-1 max-w-5xl mx-auto">
          <div class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            
            <div onclick="toggleGrammarGame()" class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">
               <div class="flex items-center gap-3">
                 <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                   <i data-feather="type" class="w-6 h-6"></i>
                 </div>
                 <div>
                   <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                     Manajemen Game Tebak Jenis Kata
                   </h3>
                   <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                     Kelola kosakata untuk game klasifikasi Isim, Fi'il, dan Harf.
                   </p>
                 </div>
               </div>
               
               <div class="flex items-center gap-2">
                 <span id="grammarCount" class="text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded-full font-bold">0</span>
                 <svg id="grammarGameChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                      stroke-width="2.5" stroke="currentColor" 
                      class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                 </svg>
               </div>
            </div>

            <div id="grammarGameContent" class="hidden">
              <div class="p-4 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700">
                 <h4 class="text-xs font-bold uppercase text-indigo-500 mb-3 tracking-wider flex items-center gap-2">
                   <i data-feather="plus-circle" class="w-3.5 h-3.5"></i> Tambah Kosakata
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-[1fr_200px_auto] gap-3 items-end">
                    <!-- Arabic Word -->
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Kata (Arab)</label>
                         <input type="text" id="gNewWord" dir="rtl" placeholder="Contoh: ÙƒÙØªÙŽØ§Ø¨" 
                           class="w-full px-3 py-2.5 text-right rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none font-arab text-lg shadow-sm transition-all">
                    </div>
                    
                    <!-- Type Select -->
                    <div>
                         <label class="block text-[10px] font-bold text-slate-400 mb-1">Jenis Kata</label>
                         <div class="relative">
                             <select id="gNewType" class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold shadow-sm appearance-none transition-all">
                                <option value="isim">Isim (Kata Benda)</option>
                                <option value="fiil">Fi'il (Kata Kerja)</option>
                                <option value="harf">Harf (Huruf)</option>
                             </select>
                             <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <i data-feather="chevron-down" class="w-4 h-4"></i>
                             </div>
                         </div>
                    </div>

                    <!-- Button -->
                    <button onclick="addGrammarQuestion()" class="w-full md:w-auto h-[42px] px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <i data-feather="save" class="w-4 h-4"></i>
                        <span class="md:hidden">Simpan</span>
                    </button>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200/50 dark:border-slate-700/50 flex justify-end">
                   <button onclick="migrateGrammarData()" id="btnMigrateGrammar" class="hidden flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow transition-all">
                      <i data-feather="upload-cloud" class="w-3 h-3"></i> Migrasi Data Statis
                   </button>
                </div>
              </div>

              <!-- List Container -->
              <div id="grammarGameListContainer" class="p-4 space-y-3 min-h-[200px]">
                 <p class="text-center text-slate-400 italic py-10">Memuat data grammar...</p>
              </div>
            </div>
          </div>
        </div>

        <script>
            function toggleGrammarGame() {
              const content = document.getElementById("grammarGameContent");
              const chevron = document.getElementById("grammarGameChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
                loadGrammarQuestions(); 
              }
            }
        </script>

        <!-- TEMPAT DISKUSI -->

        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 mb-12 overflow-hidden max-w-5xl mx-auto">

          <div onclick="toggleDiscussion()"
            class="cursor-pointer px-5 py-4 bg-slate-50 dark:bg-slate-900/50 border-b border-transparent hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div
                class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse ring-2 ring-green-200 dark:ring-green-900">
              </div>
              <div>
                <h3 class="font-bold text-slate-700 dark:text-slate-200 select-none text-base">Ruang Diskusi</h3>
                <p class="text-[10px] text-slate-400 font-normal md:hidden">Klik untuk buka/tutup</p>
              </div>
              <span
                class="text-xs text-slate-400 font-normal ml-2 hidden md:inline bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded-full">Klik
                untuk buka</span>
            </div>

            <div class="flex items-center gap-3">
              <button id="btnClearDiscussion" onclick="event.stopPropagation();" class="hidden group flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-full
               bg-red-50 text-red-600 hover:bg-red-100 border border-red-100
               dark:bg-red-900/20 dark:text-red-400 dark:border-red-900/30 transition-all z-10 shadow-sm">
                <i data-feather="trash-2" class="w-3.5 h-3.5 group-hover:rotate-12 transition-transform"></i>
                <span class="hidden sm:inline">Bersihkan</span>
              </button>

              <svg id="chevronIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2.5" stroke="currentColor"
                class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
            </div>
          </div>

          <div id="discussionContent"
            class="hidden flex flex-col transition-all duration-300 ease-in-out border-t border-slate-200 dark:border-slate-700">

            <div id="discussionFeed" class="h-[60vh] md:h-[500px] overflow-y-auto p-4 space-y-3 relative
             bg-[#eef1f5] dark:bg-[#0b141a] 
             scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600">
              <div class="flex h-full items-center justify-center opacity-60">
                <p
                  class="text-slate-400 text-sm italic bg-slate-200/50 dark:bg-slate-800/50 px-3 py-1 rounded-full shadow-sm">
                  Memuat diskusi...
                </p>
              </div>
            </div>

            <div class="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
              <div class="flex items-end gap-2 relative">

                <textarea id="discussionInput" rows="1" placeholder="Ketik pesan sebagai Guru..." class="flex-1 max-h-32 min-h-[45px] py-3 px-4 rounded-2xl resize-none
                 bg-slate-100 dark:bg-slate-700 
                 text-slate-800 dark:text-white placeholder-slate-400
                 border-0 focus:ring-2 focus:ring-blue-500/50 outline-none shadow-inner"
                  style="field-sizing: content;"></textarea>

                <button id="btnPostDiscussion" type="button" class="flex-shrink-0 w-[45px] h-[45px] flex items-center justify-center rounded-full
                 bg-blue-600 hover:bg-blue-700 text-white shadow-md
                 transform active:scale-95 transition-all">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                    class="w-5 h-5 ml-0.5">
                    <path
                      d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                  </svg>
                </button>

              </div>
              <div class="text-[10px] text-slate-400 mt-1 ml-2 dark:text-slate-500">
                Tekan enter untuk mengirim
              </div>
            </div>

          </div>
        </div>


        <!-- ===============================
             ðŸ“¬ KOTAK SURAT GURU (PENGUMUMAN)
        =============================== -->
        <div class="mb-8 px-1 max-w-5xl mx-auto">
          <div class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">

            <!-- Header -->
            <div onclick="toggleKotakSurat()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-slate-900/50 dark:to-slate-800/50 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-amber-600 dark:text-amber-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Kotak Surat Guru</h3>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Kirim pengumuman ke semua siswa.</p>
                </div>
              </div>
              <svg id="announcementChevronMain" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
               </svg>
            </div>

            <div id="announcementMainContent" class="hidden">

            <!-- Form Input -->
            <div class="p-6 md:p-8 border-b border-slate-100 dark:border-slate-700">
              <div class="space-y-5">
                <div>
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Judul Pengumuman
                  </label>
                  <input id="announcementTitle" type="text" placeholder="Contoh: Pengingat Tugas Minggu Ini"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                     bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                     focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Isi Pesan
                  </label>
                  <textarea id="announcementBody" rows="4" placeholder="Tulis isi pengumuman di sini..."
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                     bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                     focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all resize-none"></textarea>
                </div>

                <div class="flex justify-end">
                  <button id="btnSendAnnouncement"
                    class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-amber-500/30 transform active:scale-[0.98] transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13"/>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Kirim Pengumuman
                  </button>
                </div>
              </div>
            </div>

            <!-- Riwayat Pengumuman -->
            <div onclick="toggleAnnouncementHistory()"
              class="cursor-pointer px-6 py-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors">
              <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2 select-none">
                <i data-feather="clipboard" class="w-4 h-4 text-amber-600"></i> Riwayat Pengumuman Terkirim
              </h4>
              <div class="flex items-center gap-2">
                <span id="announcementCount" class="text-xs bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-2 py-0.5 rounded-full font-bold">0</span>
                <svg id="announcementChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </div>
            </div>

            <div id="announcementHistoryContent" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                  <thead class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-semibold text-slate-500 dark:text-slate-400">
                    <tr>
                      <th class="px-6 py-4 w-[50px]">#</th>
                      <th class="px-6 py-4">Judul</th>
                      <th class="px-6 py-4 w-[150px]">Tanggal</th>
                      <th class="px-6 py-4 text-center w-[100px]">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="announcementTableBody" class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">
                    <tr>
                      <td colspan="4" class="px-6 py-8 text-center text-slate-400 dark:text-slate-500 italic">
                        Belum ada pengumuman yang dikirim.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>

            </div> <!-- Close MainContent -->
          </div>
        </div>

        <script>
          function toggleAnnouncementHistory() {
            const content = document.getElementById('announcementHistoryContent');
            const chevron = document.getElementById('announcementChevron');
            content.classList.toggle('hidden');
            if (content.classList.contains("hidden")) {
              chevron.classList.add("-rotate-90");
            } else {
              chevron.classList.remove("-rotate-90");
            }
          }
        </script>



        <!-- ===============================
             ðŸ“š MANAJEMEN TEMA MATERI (DYNAMIC)
        =============================== -->
        <div class="mb-8 px-1 max-w-5xl mx-auto">
          <div class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">

            <!-- Header -->
            <!-- Header -->
            <div id="materiSectionHeader" onclick="toggleMateri()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-900/50 dark:to-slate-800/50 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Manajemen Materi (Tema)</h3>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Tambah tema pembelajaran baru ke website.</p>
                </div>
              </div>
              <svg id="themeChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
               </svg>
            </div>

            <div id="themeContent" class="hidden">

            <!-- Form Input -->
            <div class="p-6 md:p-8 border-b border-slate-100 dark:border-slate-700 space-y-6">
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">ID Tema (unik)</label>
                    <input id="themeId" type="text" placeholder="misal: profesi" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                 <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Warna Kartu</label>
                    <select id="themeColor" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-blue-500">
                       <option value="blue">Biru (Default)</option>
                       <option value="emerald">Hijau (Emerald)</option>
                       <option value="lime">Lime</option>
                       <option value="rose">Merah (Rose)</option>
                       <option value="amber">Kuning (Amber)</option>
                       <option value="slate">Abu-abu</option>
                    </select>
                 </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Judul (Indonesia)</label>
                    <input id="themeTitle" type="text" placeholder="misal: Profesi" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                 <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Judul (Arab)</label>
                    <input id="themeArTitle" type="text" placeholder="misal: Ø§Ù„Ù’Ù…ÙÙ‡Ù’Ù†ÙŽØ©Ù" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-blue-500 font-arab text-right" dir="rtl">
                 </div>
              </div>

              <div>
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Deskripsi Singkat</label>
                  <input id="themeDesc" type="text" placeholder="Deskripsi singkat untuk kartu di beranda." class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <!-- JSON DATA INPUTS -->
              <div class="space-y-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                  <h4 class="font-bold text-slate-700 dark:text-white">Data Konten (Format JSON)</h4>
                  
                  <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Data Kosakata (Builder)</label>
                    <input type="hidden" id="themeVocabJson">
                    
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 p-4">
                       <div class="grid grid-cols-12 gap-2 mb-2">
                          <div class="col-span-4">
                             <input id="vocabArInput" class="w-full px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 font-arab text-right text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Mufrod (Arab)" dir="rtl">
                          </div>
                          <div class="col-span-4">
                             <input id="vocabJamakInput" class="w-full px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 font-arab text-right text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Jamak (Opsional)" dir="rtl">
                          </div>
                          <div class="col-span-4">
                             <input id="vocabIdnInput" class="w-full px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Arti (Indonesia)">
                          </div>
                       </div>
                       <button type="button" id="btnAddVocabItem" class="w-full py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-bold uppercase tracking-wider mb-2">+ Tambah Kosa Kata</button>
                       
                       <div class="border-t border-indigo-200 dark:border-indigo-800 pt-2">
                          <label class="block text-[10px] font-bold uppercase text-indigo-400 mb-1">Preview List Kosakata</label>
                          <div id="vocabPreviewList" class="space-y-1 max-h-40 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-indigo-200">
                             <p class="text-center text-xs text-slate-400 italic py-2">Belum ada kosakata.</p>
                          </div>
                       </div>
                    </div>
                  </div>

                  <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Data Bacaan (JSON Array)</label>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Data Bacaan (Builder)</label>
                    
                    <!-- Hidden Input untuk menyimpan JSON agar tombol Simpan Tema tetap jalan -->
                    <input type="hidden" id="themeReadJson">

                    <!-- Form Builder Area -->
                    <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
                      
                      <!-- Input Form -->
                      <div class="grid grid-cols-1 gap-4 mb-4">
                         <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Teks Arab (Bacaan)</label>
                            <textarea id="readArInput" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-right font-arab text-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="..."></textarea>
                         </div>
                         <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Terjemahan Indonesia</label>
                            <textarea id="readIdnInput" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="..."></textarea>
                         </div>
                         <div>
                            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">File Audio (MP3)</label>
                            <div class="flex items-center gap-2">
                              <input type="file" id="readAudioInput" accept="audio/mp3,audio/mpeg" class="block w-full text-xs text-slate-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-xs file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                              "/>
                              <div id="readAudioStatus" class="hidden text-xs text-blue-500 font-bold animate-pulse">â³ Uploading...</div>
                            </div>
                         </div>
                         <button type="button" id="btnAddReadItem" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-xs uppercase tracking-widest transition shadow-md">
                            + Tambah Bacaan ke List
                         </button>
                      </div>

                      <!-- Preview List -->
                      <div class="border-t border-slate-200 dark:border-slate-700 pt-3">
                        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Preview List Bacaan</label>
                        <div id="readPreviewList" class="space-y-2 max-h-40 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-slate-300">
                           <p class="text-center text-xs text-slate-400 italic py-2">Belum ada data bacaan.</p>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div>
                    <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Data Kuis (Builder)</label>
                    <input type="hidden" id="themeQuizJson">
                    
                    <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-100 dark:border-amber-800 p-4">
                       <div class="space-y-2 mb-3">
                          <input id="quizQuestionInput" class="w-full px-3 py-2 rounded border border-slate-300 dark:border-slate-600 text-sm font-bold bg-white dark:bg-slate-800 dark:text-white" placeholder="Pertanyaan Kuis">
                          <input id="quizArInput" class="w-full px-3 py-2 rounded border border-slate-300 dark:border-slate-600 font-arab text-right text-lg bg-white dark:bg-slate-800 dark:text-white" placeholder="Teks Arab (Opsional)" dir="rtl">
                          
                          <div class="grid grid-cols-2 gap-2">
                             <input id="optA" class="px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Opsi A">
                             <input id="optB" class="px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Opsi B">
                             <input id="optC" class="px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Opsi C">
                             <input id="optD" class="px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm bg-white dark:bg-slate-800 dark:text-white" placeholder="Opsi D">
                          </div>
                          
                          <select id="correctAnswer" class="w-full px-3 py-2 rounded border border-slate-300 dark:border-slate-600 text-sm font-bold bg-white dark:bg-slate-800 dark:text-white">
                             <option value="" disabled selected>Pilih Kunci Jawaban...</option>
                             <option value="A">Jawaban A</option>
                             <option value="B">Jawaban B</option>
                             <option value="C">Jawaban C</option>
                             <option value="D">Jawaban D</option>
                          </select>
                       </div>
                       
                       <button type="button" id="btnAddQuizItem" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded font-bold text-xs uppercase tracking-wider mb-2 shadow-sm">+ Tambah Soal Kuis</button>
                       
                       <div class="border-t border-amber-200 dark:border-amber-800 pt-2">
                          <label class="block text-[10px] font-bold uppercase text-amber-500 mb-1">Preview Soal Kuis</label>
                          <div id="quizPreviewList" class="space-y-2 max-h-60 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-amber-200">
                             <p class="text-center text-xs text-slate-400 italic py-2">Belum ada soal.</p>
                          </div>
                       </div>
                    </div>
                  </div>
              </div>


              <div class="flex justify-between pt-4">
                  <button id="btnResetForm" class="text-slate-500 hover:text-slate-700 font-bold text-sm px-4">
                    Reset Form
                  </button>
                  <button id="btnSaveTheme" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all active:scale-95 flex items-center gap-2">
                    <span>ðŸ’¾ Simpan Tema & Materi</span>
                  </button>
              </div>

            </div>
            
            <!-- LIST MATERI -->
            <div class="px-6 py-8 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700">
               <h4 class="font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                 Daftar Materi Tersedia
               </h4>
               
               <div id="themeListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <!-- Cards will be injected here -->
                  <div class="col-span-full text-center py-10 opacity-50">â³ Memuat daftar materi...</div>
               </div>
            </div>

          </div>
        </div>
        
            </div> <!-- Close themeContent -->

        <!-- ===============================
             ðŸ§© MANAJEMEN GRAMMAR (DYNAMIC)
        =============================== -->
        <div class="mb-8 px-1 max-w-5xl mx-auto">
          <div class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">

            <!-- Header -->
            <div id="grammarSectionHeader" onclick="toggleGrammar()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-teal-50 to-emerald-50 dark:from-slate-900/50 dark:to-slate-800/50 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-teal-100 dark:bg-teal-900/30 rounded-lg text-teal-600 dark:text-teal-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Manajemen Grammar (Misi)</h3>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Kelola misi dan materi grammar.</p>
                </div>
              </div>
              <svg id="grammarChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
               </svg>
            </div>

            <div id="grammarContent" class="hidden">
                 
                 <!-- MAIN FORM -->
                 <div class="p-6 md:p-8 border-b border-slate-100 dark:border-slate-700 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">ID Misi (e.g. t1)</label>
                            <input id="gramId" type="text" placeholder="t1" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Urutan (Angka)</label>
                            <input id="gramOrder" type="number" placeholder="1" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Judul Misi</label>
                            <input id="gramTitle" type="text" placeholder="Misi 1: Jenis Kata" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Sub-Judul</label>
                            <input id="gramSubtitle" type="text" placeholder="Isim, Fi'il, & Harf" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                    </div>
                    
                    <div>
                         <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Icon (Emoji)</label>
                         <input id="gramIcon" type="text" placeholder="ðŸ§±" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-teal-500">
                    </div>

                    <!-- JSON BUILDER FOR LESSONS -->
                    <div class="space-y-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                        <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-2">Lessons / Materi (JSON Builder)</label>
                        <textarea id="gramLessonsJson" rows="6" class="w-full font-mono text-xs px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-900 text-green-400 outline-none focus:ring-2 focus:ring-teal-500" placeholder='[{"id":"t1-01", "judul_id":"...", ...}]'></textarea>
                        <p class="text-[10px] text-slate-400">Paste JSON here or use the Import Default button below to seed data.</p>
                    </div>

                    <div class="flex justify-between pt-4">
                        <button id="btnResetGrammar" class="text-slate-500 hover:text-slate-700 font-bold text-sm px-4">Reset</button>
                        <button id="btnSaveGrammar" class="bg-teal-600 hover:bg-teal-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 transition-all active:scale-95 flex items-center gap-2">
                           <span>ðŸ’¾ Simpan Misi Grammar</span>
                        </button>
                    </div>
                 </div>

                 <!-- LIST -->
                 <div class="px-6 py-8 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700">
                    <h4 class="font-bold text-slate-700 dark:text-white mb-6">Daftar Misi Tersedia</h4>
                    <div id="grammarListContainer" class="space-y-2">
                        <p class="text-center text-slate-400 italic">Memuat data...</p>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-slate-200 dark:border-slate-700 text-center">
                        <button id="btnImportGrammarDefaults" class="px-6 py-3 bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-slate-300 dark:hover:bg-slate-700 transition">
                            âš¡ Import Default Data (Bank Materi)
                        </button>
                        <p id="importStatus" class="text-xs text-slate-400 mt-2"></p>
                    </div>
                 </div>

            </div>
          </div>
        </div>
          </div>
        </div>
        
        </script>

        <!-- ===============================
             ðŸ“š SESI BELAJAR (HARIAN)
        =============================== -->
        <div class="mb-8 px-1 max-w-5xl mx-auto">
          <div class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">

            <!-- Header -->
            <div onclick="toggleSesi()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-slate-900/50 dark:to-slate-800/50 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg text-emerald-600 dark:text-emerald-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Sesi Belajar (Harian)</h3>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Kelola materi harian dan tugas siswa.</p>
                </div>
              </div>
              <svg id="sessionChevronMain" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
               </svg>
            </div>

            <div id="dailySessionContent" class="hidden">

            <!-- Form Input Section -->
            <div class="p-6 md:p-8 border-b border-slate-100 dark:border-slate-700">
              <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-8">

                <div class="md:col-span-2">
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Ke-
                  </label>
                  <input id="sessionOrder" type="number" placeholder="1" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                   bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                   focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all">
                </div>

                <div class="md:col-span-7">
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Judul Pertemuan
                  </label>
                  <input id="sessionTitle" type="text" placeholder="Contoh: Pertemuan 2 â€“ Taâ€™aruf" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                   bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                   focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all">
                </div>

                <div class="md:col-span-3">
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Status
                  </label>
                  <div class="relative">
                    <select id="sessionActive"
                      class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                      bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                      focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all appearance-none cursor-pointer">
                      <option value="true">ðŸŸ¢ Aktif</option>
                      <option value="false">ðŸ”´ Nonaktif</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div class="md:col-span-12">
                  <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-2">
                    Tema Kosakata
                  </label>
                  <div class="relative">
                    <select id="sessionTheme"
                      class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                      bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100
                      focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all appearance-none cursor-pointer">
                      <option value="">â³ Memuat tema...</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                  <p class="text-[10px] text-slate-400 mt-1.5 flex items-center gap-1 opacity-80">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Sistem akan memilih 5 kosakata secara acak dari tema ini.
                  </p>
                </div>

              </div>

              <div class="mb-8 p-5 bg-emerald-50/50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                <label class="flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-200 mb-3">
                  <i data-feather="edit-2" class="w-4 h-4 text-emerald-600"></i> Instruksi Tugas Harian
                </label>
                <textarea id="dailyTaskText" rows="3" class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 
                 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100
                 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none"
                  placeholder="Contoh: Hafalkan 5 kosakata di atas dan buat 3 kalimat perkenalan diri..."></textarea>
                <p class="text-[10px] text-slate-400 mt-1.5 text-right italic opacity-80">
                  * Siswa akan melihat instruksi ini di dashboard mereka.
                </p>
              </div>

              <div class="flex flex-col gap-4">
                <button id="btnSaveSession" class="w-full bg-emerald-600 hover:bg-emerald-700 active:scale-[0.99]
                 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-emerald-500/30 
                 transition-all flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                  </svg>
                  Simpan Sesi Harian
                </button>

                <div id="sessionMsg"
                  class="hidden animate-fade-in text-center p-3 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-sm font-medium border border-green-200 dark:border-green-800">
                  âœ… Sesi harian berhasil disimpan!
                </div>
              </div>
            </div>

            <!-- Riwayat Sesi Harian (Collapse) -->
            <div onclick="toggleSessionList()"
              class="cursor-pointer px-6 py-4 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors">
              <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2 select-none">
                <span>ðŸ“‹</span> Riwayat Sesi Harian Terdaftar
              </h4>
              <div class="flex items-center gap-2">
                <span id="sessionCount" class="text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-2 py-0.5 rounded-full font-bold">0</span>
                <svg id="sessionChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </div>
            </div>

            <div id="sessionListContent" class="hidden">
              <div class="overflow-x-auto w-full">
                <table class="w-full text-sm text-left">
                  <thead class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-semibold text-slate-500 dark:text-slate-400">
                    <tr>
                      <th class="px-6 py-4 whitespace-nowrap w-[10px]">#</th>
                      <th class="px-6 py-4 whitespace-nowrap">Judul Materi</th>
                      <th class="px-6 py-4 whitespace-nowrap">Tema/Topik</th>
                      <th class="px-6 py-4 text-center whitespace-nowrap">Status</th>
                      <th class="px-6 py-4 text-center whitespace-nowrap">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="sessionTableBody"
                    class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">
                    <tr>
                      <td colspan="5" class="px-6 py-8 text-center text-slate-400 dark:text-slate-500 italic">
                        <div class="flex flex-col items-center justify-center gap-2">
                          <svg class="w-8 h-8 animate-spin text-emerald-500 opacity-50" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <span>Sedang memuat data sesi...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>



            </div> <!-- Close dailySessionContent -->
          </div>
        </div>


        <!-- ================= UPLOAD E-BOOK ================= -->
        <div class="mb-8 px-1 max-w-5xl mx-auto">

          <div
            class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div onclick="toggleQuizScores()"
              class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">

              <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                  </svg>
                </div>
                <div>
                  <h2 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                    Riwayat Game Siswa
                  </h2>
                  <p class="text-xs text-slate-400 dark:text-slate-500 select-none">
                    Daftar seluruh siswa yang terdaftar dalam sistem.
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <span id="quizCount"
                  class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 px-2 py-0.5 rounded-full font-bold">0</span>
                <span
                  class="text-xs text-slate-400 hidden md:inline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                  Klik untuk buka/tutup
                </span>
                <svg id="quizChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </div>

            </div>

            <div id="quizContent" class="hidden">

              <div class="overflow-x-auto w-full">
                <table class="w-full text-sm text-left">

                  <thead class="bg-slate-50 dark:bg-slate-900/50 text-xs uppercase font-bold text-slate-500">
                    <tr>
                      <th class="px-6 py-4 text-center">No</th>
                      <th class="px-6 py-4 text-left">Nama Siswa</th>
                      <th class="px-6 py-4 text-left">Kelas</th>
                      <th class="px-6 py-4 text-left">Total Game</th>
                      <th class="px-6 py-4 text-left">Total Skor</th>
                      <th class="px-6 py-4 text-left">Waktu Terakhir</th>
                      <th class="px-6 py-4 text-left">Aksi</th>
                    </tr>
                  </thead>

                  <tbody id="nilaiTableBody"
                    class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">

                    <tr>
                      <td colspan="7" class="px-6 py-10 text-center text-slate-400 dark:text-slate-500 italic">
                        <div class="flex flex-col items-center justify-center gap-2">
                          <svg class="w-6 h-6 animate-spin text-purple-500 opacity-50"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                          </svg>
                          <span>Sedang memuat data nilai...</span>
                        </div>
                      </td>
                    </tr>

                  </tbody>
                </table>
              </div>

              <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 dark:text-slate-500 text-center sm:text-left">
                  Menampilkan data terbaru hasil pengerjaan kuis.
                </p>
              </div>
            </div>

          </div>
        </div>

        <script>
          function toggleQuizScores() {
            const content = document.getElementById("quizContent");
            const chevron = document.getElementById("quizChevron");
            if (!content || !chevron) return;
            content.classList.toggle("hidden");
            if (content.classList.contains("hidden")) {
              chevron.classList.add("-rotate-90");
            } else {
              chevron.classList.remove("-rotate-90");
            }
          }
        </script>



        <!-- ================= TOTAL POIN SISWA ================= -->
        <div class="mb-12 px-1 max-w-5xl mx-auto">

          <div
            class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div onclick="toggleTotalPoints()"
              class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white dark:bg-slate-800">

              <div class="flex items-center gap-3">
                <div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                    <path d="M4 22h16" />
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                    Total Poin Siswa
                  </h3>
                  <p class="text-xs text-slate-400 dark:text-slate-500 select-none">Akumulasi poin aktif dan poin total.
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <!-- Reset Buttons Here -->
                <div class="flex flex-col sm:flex-row gap-2" onclick="event.stopPropagation()">
                  
                  <!-- Tombol SYNC POIN (Baru) -->
                  <button id="syncPoinBtn" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold
                      bg-indigo-50 text-indigo-600 border border-indigo-100
                      hover:bg-indigo-600 hover:text-white hover:border-indigo-600
                      dark:bg-indigo-900/20 dark:text-indigo-400 dark:border-indigo-900/50 dark:hover:bg-indigo-600 dark:hover:text-white
                      transition-all" title="Sinkronkan data poin dari Leaderboard ke Database User">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                      <path d="M3 3v5h5"/>
                      <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                      <path d="M16 21h5v-5"/>
                    </svg>
                    Sync Poin
                  </button>
                  <button id="resetPoinTotalBtn" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold
                     bg-red-50 text-red-600 border border-red-100
                     hover:bg-red-600 hover:text-white hover:border-red-600
                     dark:bg-red-900/20 dark:text-red-400 dark:border-red-900/50 dark:hover:bg-red-600 dark:hover:text-white
                     transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path
                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                      <line x1="12" y1="9" x2="12" y2="13" />
                      <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    Reset Total
                  </button>
                </div>

                <div class="flex items-center gap-2 ml-2">
                  <span id="pointsCount"
                    class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 px-2 py-0.5 rounded-full font-bold">0</span>
                  <svg id="totalPointsChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="2.5" stroke="currentColor"
                    class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </div>
              </div>

            </div>

            <div id="totalPointsContent" class="hidden">

              <div class="overflow-x-auto w-full">
                <table class="w-full text-sm text-left">

                  <thead
                    class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                      <th class="px-6 py-4 whitespace-nowrap w-[20px]">No</th>
                      <th class="px-6 py-4 whitespace-nowrap min-w-[200px]">Nama Siswa</th>
                      <th class="px-6 py-4 whitespace-nowrap">Kelas</th>

                      <th class="px-6 py-4 text-center whitespace-nowrap bg-purple-50/50 dark:bg-purple-900/10">
                        <span class="flex items-center justify-center gap-1 text-purple-600 dark:text-purple-400">
                          ðŸ† Total Semua
                        </span>
                      </th>
                    </tr>
                  </thead>

                  <tbody id="poinTableBody"
                    class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">

                    <tr>
                      <td colspan="5" class="px-6 py-10 text-center text-slate-400 dark:text-slate-500 italic">
                        <div class="flex flex-col items-center justify-center gap-2">
                          <svg class="w-6 h-6 animate-spin text-yellow-500 opacity-50"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                          </svg>
                          <span>Sedang memuat data poin...</span>
                        </div>
                      </td>
                    </tr>

                  </tbody>
                </table>
              </div>

              <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 text-center">
                  * Data poin diupdate secara realtime.
                </p>
              </div>

            </div>
          </div>
        </div>
        <script>
          function toggleTotalPoints() {
            const content = document.getElementById("totalPointsContent");
            const chevron = document.getElementById("totalPointsChevron");
            if (!content || !chevron) return;
            content.classList.toggle("hidden");
            if (content.classList.contains("hidden")) {
              chevron.classList.add("-rotate-90");
            } else {
              chevron.classList.remove("-rotate-90");
            }
          }
        </script>

        <script>
             // TOGGLE MATERI
             function toggleMateri() {
               const c = document.getElementById("themeContent");
               const v = document.getElementById("themeChevron");
               if(!c) return;
               c.classList.toggle("hidden");
               if(v) v.classList.toggle("-rotate-90");
             }
             
             // TOGGLE SESI
             function toggleSesi() {
               const c = document.getElementById("dailySessionContent");
               const v = document.getElementById("sessionChevronMain");
               if(!c) return;
               c.classList.toggle("hidden");
               if(v) v.classList.toggle("-rotate-90");
             }
             
             // TOGGLE KOTAK SURAT
             function toggleKotakSurat() {
                const c = document.getElementById("announcementMainContent");
                const v = document.getElementById("announcementChevronMain");
                if(!c) return;
                c.classList.toggle("hidden");
                if(v) v.classList.toggle("-rotate-90");
             }
        </script>


        <!-- Ranking Siswa Removed as per request (Redundant with Total Poin) -->




        <!-- ============================= -->
        <!-- CARD: DAFTAR SISWA BARU -->
        <!-- ============================= -->
        <div class="space-y-10 mb-12 px-1 max-w-5xl mx-auto">

          <!-- DAFTAR AKUN SISWA -->
          <div
            class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div id="registerStudentHeader" onclick="toggleRegisterStudent()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-slate-800/50">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="8.5" cy="7" r="4" />
                  <line x1="20" y1="8" x2="20" y2="14" />
                  <line x1="23" y1="11" x2="17" y2="11" />
                </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                  Daftarkan Siswa Baru
                </h3>
              </div>
              <svg id="registerStudentChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </div>

            <div id="registerStudentContent" class="hidden p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Nama Lengkap</label>
                  <input id="inputNama" type="text" placeholder="Contoh: Ahmad Fauzan"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">NISN</label>
                  <input id="inputNisn" type="text" placeholder="Nomor Induk Siswa Nasional"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Kelas</label>
                  <input id="inputKelas" type="text" placeholder="Contoh: 7A"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Jenis Kelamin</label>
                  <div class="relative">
                    <select id="inputGender"
                      class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all appearance-none cursor-pointer">
                      <option value="">-- Pilih Gender --</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                        </path>
                      </svg>
                    </div>
                  </div>
                </div>

              </div>

              <div class="mt-6">
                <button id="btnSimpanSiswa"
                  class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all flex items-center justify-center gap-2">
                  <span>ðŸ’¾</span> Simpan ke Database
                </button>
                <p id="infoSimpanSiswa" class="mt-3 text-sm text-slate-500"></p>
              </div>

              <div id="akunResult"
                class="hidden mt-6 p-5 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800/50">
                <div class="flex items-start gap-3">
                  <div
                    class="p-2 bg-emerald-100 dark:bg-emerald-800 rounded-full text-emerald-600 dark:text-emerald-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                      <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                  </div>

                  <div class="flex-1 space-y-1 text-sm text-slate-700 dark:text-slate-200 min-w-0">

                    <h4 class="font-bold text-emerald-700 dark:text-emerald-400 text-lg mb-2">
                      Akun Berhasil Dibuat!
                    </h4>

                    <div class="grid grid-cols-[70px_1fr] sm:grid-cols-[80px_1fr] gap-x-2 gap-y-1">

                      <span class="font-semibold text-slate-500 dark:text-slate-400">Nama:</span>
                      <span id="resNama" class="font-medium truncate"></span>

                      <span class="font-semibold text-slate-500 dark:text-slate-400">Email:</span>
                      <span id="resEmail"
                        class="font-mono bg-white dark:bg-slate-800 px-1 rounded border border-slate-200 dark:border-slate-700 break-all"></span>

                      <span class="font-semibold text-slate-500 dark:text-slate-400">Password:</span>
                      <span id="resPassword"
                        class="font-mono bg-white dark:bg-slate-800 px-1 rounded border border-slate-200 dark:border-slate-700 break-all"></span>
                    </div>

                    <button id="btnCetakPdf"
                      class="mt-4 w-full px-4 py-2 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 text-white text-xs font-bold uppercase tracking-wider rounded-lg flex items-center justify-center gap-2 transition-all shadow-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="shrink-0">
                        <path d="M6 9V2h12v7" />
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                        <path d="M6 14h12v8H6z" />
                      </svg>
                      <span class="text-center">Cetak PDF Bukti Pendaftaran</span>
                    </button>

                  </div>

                </div>
              </div>

            </div>
          </div>


          </div>
          <!-- Script Toggle Register -->
          <script>
            function toggleRegisterStudent() {
              const content = document.getElementById("registerStudentContent");
              const chevron = document.getElementById("registerStudentChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
              }
            }
          </script>


          <!-- MANAGEMENT EBOOK -->
          <div
            class="w-full max-w-5xl mx-auto mb-12 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div onclick="toggleEbooks()"
              class="cursor-pointer px-6 py-5 border-b border-transparent hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between bg-white dark:bg-slate-800">

              <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                    Manajemen E-Book
                  </h3>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <span id="ebookCount"
                  class="text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded-full font-bold">0</span>
                <span
                  class="text-xs text-slate-400 hidden md:inline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                  Klik untuk buka/tutup
                </span>
                <svg id="ebookChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </div>

            </div>

            <div id="ebookContent" class="hidden">

              <div class="overflow-x-auto w-full">
                <table class="w-full text-sm text-left">
                  <thead
                    class="bg-slate-100 dark:bg-slate-900/80 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                      <th class="px-6 py-4 whitespace-nowrap w-[20px]">No</th>
                      <th class="px-6 py-4 whitespace-nowrap">Judul Buku</th>
                      <th class="px-6 py-4 whitespace-nowrap">Kelas / Kategori</th>
                      <th class="px-6 py-4 whitespace-nowrap">File</th>
                      <th class="px-6 py-4 whitespace-nowrap">Waktu Upload</th>
                      <th class="px-6 py-4 text-center whitespace-nowrap">Aksi</th>
                    </tr>
                  </thead>

                  <tbody id="ebookTableBody"
                    class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 [&>tr:nth-child(even)]:bg-slate-50/50 dark:[&>tr:nth-child(even)]:bg-slate-900/20">
                    <tr>
                      <td colspan="6" class="px-6 py-10 text-center text-slate-400 dark:text-slate-500 italic">
                        <div class="flex flex-col items-center justify-center gap-2">
                          <svg class="w-6 h-6 animate-spin text-indigo-500 opacity-50"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                          </svg>
                          <span>Memuat data e-book...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 text-center">
                  * Daftar e-book diupdate secara realtime.
                </p>
              </div>

            </div>
          </div>

          <script>
            function toggleEbooks() {
              const content = document.getElementById("ebookContent");
              const chevron = document.getElementById("ebookChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
              }
            }
          </script>

          <!-- UPLOAD E_BOOK -->
          <div
            class="w-full max-w-5xl mx-auto mb-12 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">

            <div onclick="toggleUploadEbook()" class="cursor-pointer px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-slate-800/50">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg text-emerald-600 dark:text-emerald-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white select-none">
                  Upload E-Book Baru
                </h3>
              </div>
               <svg id="uploadEbookChevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="2.5" stroke="currentColor"
                  class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </div>

            <div id="uploadEbookContent" class="hidden p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Judul (Bahasa Arab)</label>
                  <input id="ebookTitleAr" type="text" placeholder="Contoh: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-right"
                    dir="rtl">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Judul (Bahasa Indonesia)</label>
                  <input id="ebookTitleId" type="text" placeholder="Contoh: Bahasa Arab untuk Pemula"
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Kategori / Kelas</label>
                  <div class="relative">
                    <select id="ebookCategory"
                      class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all appearance-none cursor-pointer">
                      <option value="mts7">MTs Kelas 7</option>
                      <option value="mts8">MTs Kelas 8</option>
                      <option value="mts9">MTs Kelas 9</option>
                      <option value="novel">Novel Arab</option>
                      <option value="kisah">Kisah Islami</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                        </path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">File PDF</label>
                  <input id="ebookFile" type="file" accept="application/pdf"
                    class="w-full px-3 py-2.5 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500
                   file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 transition-all cursor-pointer">
                </div>

              </div>

              <div class="mt-6 mb-8">
                <button id="btnUploadEbook"
                  class="w-full md:w-auto px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl shadow-md transition-all flex items-center justify-center gap-2">
                  <span>â¬†ï¸</span> Upload E-Book
                </button>
                <p id="ebookUploadStatus" class="text-sm mt-3 hidden"></p>
              </div>

            </div>
            </div>
          </div>
          <div class="h-24 md:h-32 w-full"></div> 
          <script>
            function toggleUploadEbook() {
              const content = document.getElementById("uploadEbookContent");
              const chevron = document.getElementById("uploadEbookChevron");
              if (!content || !chevron) return;
              content.classList.toggle("hidden");
              if (content.classList.contains("hidden")) {
                chevron.classList.add("-rotate-90");
              } else {
                chevron.classList.remove("-rotate-90");
              }
            }
          </script>

        </div>

        <!-- UNTUK POP UP EDIT E_BOOKS -->
        <div id="editEbookModal" class="fixed inset-0 z-50 hidden">
          <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>

          <div class="absolute inset-0 flex items-center justify-center p-4">
            <div
              class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 transform transition-all scale-100">

              <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                  <span>âœï¸</span> Edit E-Book
                </h3>
                <button onclick="closeEditEbook()"
                  class="text-slate-400 hover:text-slate-500 dark:hover:text-slate-300">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>

              <div class="p-6 space-y-4">
                <div>
                  <label class="text-xs font-bold text-slate-500 ml-1">Judul Arab</label>
                  <input id="editTitleAr" type="text" placeholder="Judul Arab"
                    class="w-full mt-1 px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-yellow-500 outline-none text-right"
                    dir="rtl">
                </div>

                <div>
                  <label class="text-xs font-bold text-slate-500 ml-1">Judul Indonesia</label>
                  <input id="editTitleId" type="text" placeholder="Judul Indonesia"
                    class="w-full mt-1 px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-yellow-500 outline-none">
                </div>

                <div>
                  <label class="text-xs font-bold text-slate-500 ml-1">Kategori</label>
                  <div class="relative mt-1">
                    <select id="editLevel"
                      class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-yellow-500 outline-none appearance-none">

                      <option value="mts7">MTs Kelas 7</option>
                      <option value="mts8">MTs Kelas 8</option>
                      <option value="mts9">MTs Kelas 9</option>
                      <option value="novel">Novel Arab</option>
                      <option value="kisah">Kisah Islami</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                        </path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="px-6 py-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="closeEditEbook()"
                  class="px-4 py-2 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">
                  Batal
                </button>
                <button onclick="saveEditEbook()"
                  class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg shadow-sm transition-colors flex items-center gap-2">
                  <span>ðŸ’¾</span> Simpan
                </button>
              </div>

            </div>
          </div>
        </div>
        <!-- END POP UP EDIT BOOKS -->


      </article>
    </section>



  </main>

  <!-- ===== FOOTER (PASTI NEMPEL) ===== -->
  <footer
    class="bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 transition-colors mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-10">
      <div class="flex flex-col items-center text-center space-y-4">

        <div class="flex flex-col items-center gap-1 group">
          <span class="text-lg font-black tracking-tighter text-slate-800 dark:text-white uppercase italic">
            Tarbiyyat <span class="text-emerald-600 dark:text-emerald-400">al-Lughah</span>
          </span>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Sistem Manajemen
              Pengajar</span>
          </div>
        </div>

        <div class="flex items-center gap-1.5">
          <div class="h-1 w-1 bg-emerald-500/40 rounded-full"></div>
          <div class="h-1 w-24 bg-gradient-to-r from-transparent via-emerald-500 to-transparent rounded-full"></div>
          <div class="h-1 w-1 bg-emerald-500/40 rounded-full"></div>
        </div>

        <div class="pt-2 space-y-2">
          <p class="text-[11px] md:text-sm text-slate-600 dark:text-slate-400 font-medium leading-relaxed">
            &copy; 2026 <strong>Tarbiyyat al-Lughah</strong> â€” Media Pembelajaran Bahasa Arab MTs
          </p>

          <div class="flex flex-col items-center gap-1">
            <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Project Developer</span>
            <p class="text-xs md:text-sm text-slate-500 dark:text-slate-500 font-semibold italic">
              Muh. Aprizal â€” <span class="text-emerald-600/80 dark:text-emerald-400/80">Mahasiswa PBA IAIN Bone</span>
            </p>
          </div>
        </div>

        <div
          class="mt-4 inline-flex items-center gap-2 px-3 py-1 bg-emerald-50 dark:bg-emerald-900/20 rounded-full border border-emerald-100 dark:border-emerald-800/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-emerald-500" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="text-[9px] font-black text-emerald-700 dark:text-emerald-400 uppercase tracking-tighter">Otoritas
            Panel Admin Aktif</span>
        </div>

      </div>
    </div>
  </footer>


  <!-- UNTUK CETAK -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


  <!-- MAIN LOGIKA -->
  <script type="module">
    /* ======================================================
       1. FIREBASE IMPORT
    ====================================================== */
    import { initializeApp, getApps } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      setDoc,
      deleteDoc,
      updateDoc,
      doc,
      addDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      onSnapshot,
      collectionGroup,
      limit,
      writeBatch
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    import {
      getDatabase,
      ref,
      onValue,
    } from
      "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    import { getFunctions, httpsCallable }
      from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL,
      deleteObject,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";







    /* ======================================================
       2. FIREBASE INIT
    ====================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAo4Hed-LHh2YIdkOE9PEinMGjG9UwAMUQ",
      authDomain: "tarbiyyat-lughah-presence.firebaseapp.com",
      projectId: "tarbiyyat-lughah-presence",
      databaseURL: "https://tarbiyyat-lughah-presence-default-rtdb.asia-southeast1.firebasedatabase.app",
      storageBucket: "tarbiyyat-lughah-presence.firebasestorage.app",
    };



    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.db = db;

    const rtdb = getDatabase(app);


    /* ======================================================
       3. DOM ELEMENTS
    ====================================================== */
    const loginSection = document.getElementById("login-section");
    const dashboardSection = document.getElementById("dashboard-section");

    const emailInput = document.getElementById("emailGuru");
    const passwordInput = document.getElementById("passwordGuru");
    const loginError = document.getElementById("loginError");

    const btnLogin = document.getElementById("btnLoginGuru");
    const btnLogout = document.getElementById("btnLogout");

    const tabelSubmissions = document.getElementById("tabelSubmissions");
    const tabelSiswa = document.getElementById("tabelSiswa");

    /* ======================================================
       4. GLOBAL STATE
    ====================================================== */
    let dashboardLoaded = false;
    // let unsubscribeLeaderboard = null;

    let currentUser = null;


    let dataSiswa = [];   // cache data siswa
    // let leaderboardMap = {};
    let unsubUsers = null;


    // -----LOAD DATA SISWA REALTIME
    function listenDataSiswaRealtime() {
      if (unsubUsers) unsubUsers();

      const q = query(
        collection(db, "users"),
        where("role", "==", "student")
      );

      unsubUsers = onSnapshot(q, (snap) => {
        // Update count badges
        const count = snap.size || 0;
        ["studentCount", "pointsCount", "rankingCount"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = count;
        });

        dataSiswa = snap.docs.map(d => ({
          uid: d.id,
          ...d.data()
        }));

        console.log("ðŸ”¥ DATA SISWA REALTIME:", dataSiswa);

        renderTabelSiswa(dataSiswa);
        renderPoinTable(dataSiswa);
        renderTabelSiswa(dataSiswa);
        renderPoinTable(dataSiswa);
        // renderRankingFromUsers(dataSiswa); // DELETED: Replaced by listenToLeaderboard()

        // ERROR HANDLER
        (error) => {
          console.warn("Firestore listener error:", error);
        }
      });
    }


    /* ======================================================
       5. UI HELPER
    ====================================================== */
    function showLogin() {
      loginSection.classList.remove("hidden");
      dashboardSection.classList.add("hidden");
      
      // Mobile Nav: Hide Hamburger, Show Back
      document.getElementById("mobile-menu-btn")?.classList.add("hidden");
      document.getElementById("mobile-back-btn")?.classList.remove("hidden");
      document.getElementById("mobile-menu")?.classList.add("hidden");
    }

    function showDashboard() {
      loginSection.classList.add("hidden");
      dashboardSection.classList.remove("hidden");

      // Mobile Nav: Show Hamburger, Hide Back
      document.getElementById("mobile-menu-btn")?.classList.remove("hidden");
      document.getElementById("mobile-back-btn")?.classList.add("hidden");
    }

    // ================= STATUS SISWA REALTIME =================
    function listenStudentStatus(uid, el) {
      const statusRef = ref(rtdb, `status/${uid}`);

      onValue(statusRef, (snap) => {
        if (!snap.exists()) {
          el.innerHTML = `<span class="text-slate-400 text-xs">â— Offline</span>`;
          return;
        }

        const data = snap.val();
        const last = data.lastChanged || 0;
        const now = Date.now();

        // â±ï¸ jika lebih dari 20 detik â†’ anggap offline
        if (data.state === "online" && (now - last < 20000)) {
          el.innerHTML = `<span class="text-green-500 text-xs">â— Online</span>`;
        } else {
          el.innerHTML = `<span class="text-slate-400 text-xs">â— Offline</span>`;
        }
      });
    }



    /* ======================================================
       6. LOGIN & AUTH GUARD
    ====================================================== */
    btnLogin.addEventListener("click", async () => {
      loginError.classList.add("hidden");
      try {
        await signInWithEmailAndPassword(
          auth,
          emailInput.value.trim(),
          passwordInput.value.trim()
        );
      } catch {
        loginError.textContent = "Email atau password salah";
        loginError.classList.remove("hidden");
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      dashboardLoaded = false;
      showLogin();
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.isAnonymous) {
        showLogin();
        dashboardLoaded = false;
        return;
      }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        await setDoc(userRef, {
          email: user.email,
          role: "guru",
          createdAt: serverTimestamp()
        });
        location.reload();
        return;
      }

      if (snap.data().role !== "guru") {
        Swal.fire({
          icon: 'error',
          title: 'Akses Ditolak',
          text: 'Anda bukan admin/guru!',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
        showLogin();
        dashboardLoaded = false;
        return;
      }

      const userData = snap.data();

      currentUser = {
        uid: user.uid,
        email: user.email,
        nama: userData.nama || "Guru",
        role: userData.role,        // ðŸ”¥ INI KUNCI
        kelas: userData.kelas || ""
      };

      window.currentUser = currentUser;


      showDashboard();
      // loadLeaderboard();
      listenDataSiswaRealtime();
      loadEbookTable();
      // AKTIFKAN REALTIME
      loadSessionsForGuruRealtime();
      loadSessionsForGuruRealtime();
      renderThemesRealtime(); // Load Themes (Auth-secured)
      populateSessionThemeDropdown(); // ðŸ”¥ Populate dropdown for session






      if (!dashboardLoaded) {
        loadDashboard();        // TUGAS
        loadNilaiSiswa();       // NILAI KUIS
        // loadSiswa();            // DATA SISWA

        dashboardLoaded = true;
      }
    });


    /* ======================================================
       7. DASHBOARD TUGAS
    ====================================================== */
    function loadDashboard() {
      tabelSubmissions.innerHTML = `
    <tr><td colspan="7" class="p-4 text-center">Memuat...</td></tr>
  `;

      // ðŸ”¥ QUERY HARUS DIDEFINISIKAN
      const q = query(
        collection(db, "submissions"),
        orderBy("createdAt", "desc")
      );

      onSnapshot(
        q,
        (snap) => {
          // Filter docs first (Client Filter)
          const validDocs = snap.docs.filter(d => d.data().type !== 'game_history');

          // Update count badge (Correct Count)
          const submissionCountEl = document.getElementById("submissionCount");
          if (submissionCountEl) submissionCountEl.textContent = validDocs.length || 0;

          if (validDocs.length === 0) {
            tabelSubmissions.innerHTML = `
          <tr><td colspan="7" class="p-4 text-center">Belum ada tugas</td></tr>
        `;
            return;
          }

          tabelSubmissions.innerHTML = "";
          let no = 1;

          validDocs.forEach((d) => {
            const data = d.data();

            let waktu = "-";

            if (data.createdAt?.toDate) {
              waktu = data.createdAt.toDate().toLocaleString("id-ID");
            } else if (data.createdAtClient) {
              waktu = new Date(data.createdAtClient).toLocaleString("id-ID");
            }

            tabelSubmissions.innerHTML += `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/40 transition-colors">
            <td class="px-6 py-4 font-semibold text-slate-500">${no++}</td>
            <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${data.nama}</td>
            <td class="px-6 py-4 font-bold text-pink-600 dark:text-pink-400">${data.kelas}</td>
            <td class="px-6 py-4 text-slate-600 dark:text-slate-400 text-xs">${data.catatan || "-"}</td>
            <td class="px-6 py-4 text-center">
              ${data.fileUrl
                ? `<a href="${data.fileUrl}" target="_blank"
                       class="inline-flex items-center gap-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-blue-100 dark:border-blue-800/50 hover:bg-blue-100 transition-all">
                       <i data-feather="paperclip" class="w-3.5 h-3.5"></i> Buka
                     </a>`
                : "-"
              }
            </td>
            <td class="px-6 py-4 text-slate-500 text-xs">${waktu}</td>
            <td class="px-6 py-4 text-center">
              <button
                onclick="hapusTugas('${d.id}', '${data.filePath || ""}')"
                class="inline-flex items-center gap-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 dark:border-red-800/50 hover:bg-red-100 transition-all">
                <i data-feather="trash-2" class="w-3.5 h-3.5"></i> Hapus
              </button>
            </td>
          </tr>
        `;
          });
          if(window.feather) feather.replace();
        },
        (error) => {
          console.warn("Firestore listener error:", error);
        }
      );
    }



    // ðŸŒ WAJIB GLOBAL KARENA DIPANGGIL DARI HTML
    window.hapusTugas = async function (docId, filePath) {
      const result = await Swal.fire({
        title: "Hapus Tugas?",
        text: "Yakin ingin menghapus tugas ini? Data tidak bisa dikembalikan.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#10b981",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });

      if (!result.isConfirmed) return;

      try {
        // 1ï¸âƒ£ HAPUS FILE DI STORAGE
        if (filePath) {
          const fileRef = storageRef(storage, filePath);
          await deleteObject(fileRef);
        }

        // 2ï¸âƒ£ HAPUS DOKUMEN FIRESTORE
        await deleteDoc(doc(db, "submissions", docId));

        Swal.fire({
          icon: 'success',
          title: 'Dihapus!',
          text: 'Tugas berhasil dihapus.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });

      } catch (err) {
        console.error("HAPUS ERROR:", err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menghapus tugas.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }
    };






    /* ======================================================
       9. MANAJEMEN SISWA
    ====================================================== */
    async function loadSiswa() {
      const snap = await getDocs(collection(db, "users"));
      dataSiswa = [];

      snap.forEach((docu) => {
        const d = docu.data();
        if (d.role !== "student") return;
        dataSiswa.push({ uid: docu.id, ...d });
      });

      renderTabelSiswa();
    }

    function renderTabelSiswa() {
      tabelSiswa.innerHTML = "";
      let no = 1;

      if (!Array.isArray(dataSiswa)) return;

      const rows = dataSiswa.map((d, index) => {
        const uid = d.uid;
        const nama = d.nama || "-";
        const nisn = d.nisn || "-";
        const kelas = d.kelas || "-";
        const gender = d.gender || "-";
        const statusId = `status-${uid}`;

        return `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/40 transition-colors">
            <td class="px-6 py-4 font-semibold text-slate-500">${no++}</td>
            <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${nama}</td>
            <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${nisn}</td>
            <td class="px-6 py-4 font-bold text-cyan-600 dark:text-cyan-400">${kelas}</td>
            <td class="px-6 py-4 text-center text-slate-600 dark:text-slate-400">${gender}</td>
            <td class="px-6 py-4 text-center" id="${statusId}">
              <span class="text-slate-400 text-xs">â— Offline</span>
            </td>
            <td class="px-6 py-4 text-center">
              <button onclick="hapusSiswa('${uid}')"
                class="inline-flex items-center gap-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 dark:border-red-800/50 hover:bg-red-100 transition-all">
                <i data-feather="trash-2" class="w-3.5 h-3.5"></i> Hapus
              </button>
            </td>
          </tr>
        `;
      }).join('');

      tabelSiswa.innerHTML = rows;

      // Attach Listeners AFTER rendering all rows
      dataSiswa.forEach(d => {
         const statusId = `status-${d.uid}`;
         const statusEl = document.getElementById(statusId);
         if (statusEl) {
            listenStudentStatus(d.uid, statusEl);
         }
      });
      if(window.feather) feather.replace();
    }


    window.hapusSiswa = async (uid) => {
      const result = await Swal.fire({
        title: "Hapus Siswa?",
        text: "Menghapus siswa akan menghapus seluruh data kuis dan poin mereka. Lanjutkan?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });

      if (!result.isConfirmed) return;

      try {
        // 1ï¸âƒ£ HAPUS DATA SISWA
        await deleteDoc(doc(db, "users", uid));

        // 2ï¸âƒ£ HAPUS LEADERBOARD (INI YANG HILANG)
        await deleteDoc(doc(db, "leaderboard", uid));

        // (opsional tapi bagus)
        console.log("Siswa & leaderboard terhapus:", uid);

        // 3ï¸âƒ£ RELOAD DATA (TIDAK PERLU KARENA ADA ONSNAPSHOT TAPI BIAR AMAN)
        // loadSiswa(); 

        Swal.fire({
          icon: 'success',
          title: 'Terhapus!',
          text: 'Data siswa berhasil dihapus.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          timer: 1500,
          showConfirmButton: false,
          customClass: { popup: 'rounded-[2rem]' }
        });

      } catch (err) {
        console.error("Gagal menghapus siswa:", err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Terjadi kesalahan saat menghapus siswa.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }
    };



    /* ======================================================
       10. DAFTARKAN SISWA BARU (CLOUD FUNCTION)
    ====================================================== */

    document.getElementById("btnSimpanSiswa").addEventListener("click", async () => {

      const nama = inputNama.value.trim();
      const nisn = inputNisn.value.trim();
      const kelas = inputKelas.value.trim();
      const gender = inputGender.value;

      if (!nama || !nisn || !kelas || !gender) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Harap isi seluruh field pendaftaran siswa.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#f59e0b',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
        return;
      }

      const payload = { nama, nisn, kelas, gender };
      console.log("DATA DIKIRIM:", payload);

      try {
        // 1ï¸âƒ£ KIRIM KE CLOUD FUNCTION
        const res = await fetch(
          "https://asia-southeast1-tarbiyyat-lughah-presence.cloudfunctions.net/createStudentAccount",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }
        );

        // 2ï¸âƒ£ AMBIL RESPONSE JSON
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || "Gagal membuat siswa");
        }

        // 3ï¸âƒ£ TAMPILKAN HASIL AKUN
        document.getElementById("akunResult").classList.remove("hidden");
        document.getElementById("resNama").textContent = nama;
        document.getElementById("resEmail").textContent = data.email;
        document.getElementById("resPassword").textContent = data.password;
        
        // TAMPILKAN POPUP SUKSES
        Swal.fire({
            icon: 'success',
            title: 'Siswa Terdaftar!',
            text: `Akun untuk ${nama} berhasil dibuat.`,
            timer: 2000,
            showConfirmButton: false
        });

        // 4ï¸âƒ£ SIAPKAN DATA PDF
        const dataPdf = {
          nama,
          nisn,
          kelas,
          email: data.email,
          password: data.password
        };

        // 5ï¸âƒ£ CETAK PDF SAAT TOMBOL DIKLIK
        document.getElementById("btnCetakPdf").onclick = () => {
          generateAkunPdf(dataPdf);
          
          // Auto-hide setelah download dimulai (delay dikit biar user 'ngeh')
          setTimeout(() => {
              document.getElementById("akunResult").classList.add("hidden");
              Swal.fire({
                  icon: 'success',
                  title: 'Sedang Mengunduh...',
                  text: 'Silahkan cek folder download Anda',
                  toast: true,
                  position: 'bottom-end',
                  showConfirmButton: false,
                  timer: 3000
              });
          }, 800);
        };

        // 6ï¸âƒ£ RESET FORM
        inputNama.value = "";
        inputNisn.value = "";
        inputKelas.value = "";
        inputGender.value = "";

      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal Membuat Siswa',
          text: err.message,
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }
    });


    // ================= NILAI SISWA REALTIME (FROM SUBMISSIONS) =================
    function loadNilaiSiswa() {
      const tbody = document.getElementById("nilaiTableBody");
      
      // Query Submissions (History Items)
      // Query tanpa orderBy untuk menghindari error index
      // Kita akan sort manual di client-side (JavaScript)
      const q = query(
          collection(db, "submissions"), 
          where("type", "==", "game_history"),
          limit(500)
      );

      const unsubscribe = onSnapshot(q, (snapshot) => {
        let allHistory = [];
        
        snapshot.forEach((doc) => {
          allHistory.push({ id: doc.id, ...doc.data() });
        });

        // SORT CLIENT-SIDE: Terbaru ke Terlama
        allHistory.sort((a, b) => {
           // Handle timestamp/createdAt format differences if any
           const timeA = a.createdAt?.toMillis?.() || a.timestamp || 0;
           const timeB = b.createdAt?.toMillis?.() || b.timestamp || 0;
           return timeB - timeA;
        });

        const historyMap = {};
        
        allHistory.forEach(data => {
            const uid = data.uid;
            if(!historyMap[uid]) historyMap[uid] = [];
            historyMap[uid].push(data);
        });

         // Render using Global dataSiswa (from renderTabelSiswa listener)
         // We filter dataSiswa to only those who have history OR we show all?
         // Showing all allows teacher to see who hasn't played.
         
         const students = [...dataSiswa].map(s => {
             const hist = historyMap[s.uid] || [];
             const lastTime = hist.length > 0 ? hist[0].timestamp : 0;
             return { ...s, history: hist, lastTime };
         });
         
         // Sort by Last Active
         students.sort((a,b) => b.lastTime - a.lastTime);

         // Update Badge
         const quizCountEl = document.getElementById("quizCount");
         const totalGames = students.reduce((sum, s) => sum + s.history.length, 0);
         if (quizCountEl) quizCountEl.textContent = totalGames;

         tbody.innerHTML = "";
         
         // Filter: Show only students with at least 1 game? Or show all?
         // Let's show only students with History > 0 to keep table clean, 
         // or show top 50 recently active.
         // Let's show all for now.
         
         if (students.length === 0) {
             tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-slate-500">Belum ada riwayat game</td></tr>`;
             return;
         }

          let no = 1;
          students.forEach((s) => {
              if (s.history.length === 0) return;

              const lastDate = s.lastTime ? new Date(s.lastTime).toLocaleString("id-ID") : "-";
              const totalSumScore = s.history.reduce((sum, h) => sum + (parseInt(h.score) || 0), 0);

              // PARENT ROW
              tbody.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/40 transition-colors border-b border-slate-100 dark:border-slate-800">
                  <td class="px-6 py-4 font-semibold text-slate-500">${no++}</td>
                  <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${s.nama || '-'}</td>
                  <td class="px-6 py-4 font-bold text-emerald-600 dark:text-emerald-400">${s.kelas || '-'}</td>
                  <td class="px-6 py-4 text-center font-bold text-slate-800 dark:text-slate-200">
                     ${s.history.length}
                  </td>
                  <td class="px-6 py-4 text-center font-bold text-slate-700 dark:text-slate-300">
                     ${totalSumScore}
                  </td>
                  <td class="px-6 py-4 text-center text-slate-500 text-xs">${lastDate}</td>
                  <td class="px-6 py-4 text-center flex items-center justify-center gap-2">
                     <button onclick="window.toggleHistoryDetail('${s.uid}')" 
                        id="btn-toggle-${s.uid}"
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform duration-300 transform" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                     </button>
                     <button onclick="window.hapusSemuaRiwayat('${s.uid}', '${s.nama}')" 
                        class="p-2 rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/50 transition" title="Hapus Semua Riwayat">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                     </button>
                  </td>
                </tr>
              `;

              // CHILD ROW (DROPDOWN)
              let detailRows = "";
              s.history.forEach((h, idx) => {
                   const date = h.createdAt?.toDate ? h.createdAt.toDate().toLocaleString("id-ID") : new Date(h.timestamp).toLocaleString("id-ID");
                   const status = h.isCorrect 
                      ? '<span class="text-green-600 font-bold">Benar (+1)</span>' 
                      : '<span class="text-red-500 font-bold">Salah (0)</span>';
                   
                   const scoreVal = parseInt(h.score) || 0;
                   const scoreDisplay = scoreVal > 0 ? `+${scoreVal}` : `${scoreVal}`;
                   
                   detailRows += `
                      <tr class="border-b border-slate-50 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-900/20">
                         <td class="px-4 py-2 text-center text-xs text-slate-400">${idx+1}</td>
                         <td class="px-4 py-2 font-semibold text-slate-700 dark:text-slate-300 text-sm">${h.quizTitle}</td>
                         <td class="px-4 py-2 text-center text-xs font-bold ${h.isCorrect ? 'text-green-600' : 'text-red-500'}">
                            ${scoreDisplay}
                         </td>
                         <td class="px-4 py-2 text-center text-xs text-slate-500">${date}</td>
                         <td class="px-4 py-2 text-center">
                            <button onclick="hapusHistoryItem('${h.id}')" class="text-red-400 hover:text-red-600">
                               <i data-feather="trash-2" class="w-3 h-3"></i>
                            </button>
                         </td>
                      </tr>
                   `;
              });

              tbody.innerHTML += `
                <tr id="detail-${s.uid}" class="hidden bg-slate-50/50 dark:bg-slate-900/20">
                  <td colspan="6" class="p-0">
                     <div class="px-6 py-4">
                        <div class="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm bg-white dark:bg-slate-800">
                          <table class="w-full">
                             <thead class="bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 text-xs font-bold uppercase">
                                <tr>
                                   <th class="px-4 py-2 w-[40px]">No</th>
                                   <th class="px-4 py-2 text-left">Judul Game</th>
                                   <th class="px-4 py-2 text-center">Skor</th>
                                   <th class="px-4 py-2 text-center">Waktu</th>
                                   <th class="px-4 py-2 text-center">Aksi</th>
                                </tr>
                             </thead>
                             <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${detailRows}
                             </tbody>
                          </table>
                        </div>
                     </div>
                  </td>
                </tr>
              `;
          });
          
          if(window.feather) feather.replace();
      });
    }

    // TOGGLE helper
    window.toggleHistoryDetail = (uid) => {
        const row = document.getElementById(`detail-${uid}`);
        const btn = document.getElementById(`btn-toggle-${uid}`);
        if(row) row.classList.toggle('hidden');
        if(btn) {
            const icon = btn.querySelector('svg');
            if(row.classList.contains('hidden')) {
               icon.classList.remove('rotate-180');
               btn.classList.remove('bg-indigo-100', 'text-indigo-600');
            } else {
               icon.classList.add('rotate-180');
               btn.classList.add('bg-indigo-100', 'text-indigo-600');
            }
        }
    };

    // DELETE SINGLE ITEM
    window.hapusHistoryItem = async (docId) => {
        const result = await Swal.fire({
            title: 'Hapus Item?',
            text: "Riwayat ini akan dihapus.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444'
        });
        if(result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "submissions", docId));
                Swal.fire('Terhapus', '', 'success');
            } catch(e) { console.error(e); }
        }
    }

    // DELETE ALL (BATCH from Submissions)
    window.hapusSemuaRiwayat = async (uid, nama) => {
        const result = await Swal.fire({
            title: `Hapus Riwayat ${nama}?`,
            text: "Seluruh catatan game siswa ini akan dihapus permanen dari submissions!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#ef4444",
            confirmButtonText: "Ya, Hapus Semua",
            cancelButtonText: "Batal"
        });

        if (!result.isConfirmed) return;

        try {
            // QUERY ALL HISTORY BY UID
            const q = query(
                collection(db, "submissions"), 
                where("type", "==", "game_history"),
                where("uid", "==", uid),
                limit(500)
            );
            
            const snapshot = await getDocs(q);
            if(snapshot.empty) {
                Swal.fire("Info", "Tidak ada data riwayat untuk dihapus.", "info");
                return;
            }
            
            // BATCH DELETE
            const batch = writeBatch(db);
            snapshot.forEach(d => {
                batch.delete(d.ref);
            });
            
            await batch.commit();

            Swal.fire({
                icon: 'success',
                title: 'Terhapus!',
                text: `${snapshot.size} riwayat game berhasil dihapus.`,
                timer: 1500,
                showConfirmButton: false
            });
        } catch (e) {
            console.error(e);
            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus.', 'error');
        }
    };

    // RENDER TOTAL POIN
    function renderPoinTable() {
      const tbody = document.getElementById("poinTableBody");
      if (!tbody) return;

      tbody.innerHTML = "";
      let no = 1;

      dataSiswa.forEach(s => {
        tbody.innerHTML += `
      <tr class="dark:bg-slate-700 bg-slate-300">
        <td class="p-3 border font-bold">${no++}</td>
        <td class="p-3 border font-semibold">${s.nama}</td>
        <td class="p-3 border font-bold">${s.kelas}</td>
        <td class="p-3 border text-center font-bold">
          ${s.poinTotal ?? 0}
        </td>
      </tr>
    `;
      });
    }

    // ===============================
    // RENDER RANKING SISWA
    // ===============================
    // ===============================
    // RENDER RANKING SISWA (FROM LEADERBOARD COL)
    // ===============================
    function listenToLeaderboard() {
      const tbody = document.getElementById("rankingTableBody");
      const startOfDay = new Date();
      startOfDay.setHours(0,0,0,0);
      const startTimestamp = startOfDay.getTime();

      // 1. Listen to Global Leaderboard (Total Points)
      const qLeaderboard = query(
        collection(db, "leaderboard"),
        orderBy("poinTotal", "desc"),
        limit(50)
      );

      // 2. Listen to Today's Activity (Active Points)
      // Note: In production, consider a separate 'daily_points' collection reset by Cloud Functions
      // For now, we query submissions from today (Client-side aggregation if needed or simple query)
      // We'll just fetch ALL recent submissions and filter client-side to avoid complex indexes for this specific legacy request
      const qDaily = query(
         collection(db, "submissions"),
         where("timestamp", ">=", startTimestamp)
      );

      let globalData = [];
      let dailyData = {};

      // Helper to Render
      const render = () => {
         // Merge
         const merged = globalData.map(student => {
            return {
               ...student,
               poinHariIni: dailyData[student.uid] || 0
            };
         });

         if (merged.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center italic text-slate-400">Belum ada data siswa.</td></tr>`;
            return;
         }

         tbody.innerHTML = merged.map((s, index) => `
            <tr class="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
               <td class="px-6 py-4 font-bold text-slate-500 text-center">${index + 1}</td>
               <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                     <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xs font-bold">
                        ${s.nama ? s.nama.substring(0,2).toUpperCase() : 'SI'}
                     </div>
                     <div>
                       <p class="font-bold text-slate-700 dark:text-slate-200">${s.nama || "Siswa"}</p>
                     </div>
                  </div>
               </td>
               <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${s.kelas || "-"}</td>
               <td class="px-6 py-4 text-center">
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-orange-50 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400">
                    âš¡ +${s.poinHariIni}
                  </span>
               </td>
               <td class="px-6 py-4 text-center font-black text-slate-800 dark:text-white">
                  ${s.poinTotal}
               </td>
            </tr>
         `).join("");
      };

      // Listener 1
      onSnapshot(qLeaderboard, (snapshot) => {
         globalData = [];
         snapshot.forEach(doc => {
            const d = doc.data();
            // Fallback for nama if missing in leaderboard (should be there)
            globalData.push({ id: doc.id, ...d });
         });
         render();
      });

      // Listener 2 (Daily)
      onSnapshot(qDaily, (snapshot) => {
         dailyData = {};
         snapshot.forEach(doc => {
             const d = doc.data();
             if (d.uid && d.score) {
                 dailyData[d.uid] = (dailyData[d.uid] || 0) + (parseInt(d.score) || 0);
             }
         });
         render();
      });
    }

    // Call this immediately to start listening
    // listenToLeaderboard() removed


    console.log("DATA SISWA:", dataSiswa);



    // RESET POIN LOGIC REMOVED
    // const resetBtn = document.getElementById("resetPoinBtn");

    // ================= RESET TOTAL POIN SEPANJANG WAKTU =================
    const resetTotalBtn = document.getElementById("resetPoinTotalBtn");

    resetTotalBtn.addEventListener("click", async () => {
      const result = await Swal.fire({
        title: "Reset TOTAL Poin?",
        text: "Yakin ingin mereset SEMUA poin (termasuk total poin sepanjang waktu) seluruh siswa?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Reset Total",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });

      if (!result.isConfirmed) return;

      try {
        const snapshot = await getDocs(
          query(collection(db, "users"), where("role", "==", "student"))
        );

        for (const u of snapshot.docs) {
          await updateDoc(doc(db, "users", u.id), {
            poin: 0,
            poinTotal: 0
          });
        }

        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Semua poin siswa berhasil di-reset total.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal reset total poin.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }
    });
    
    
    // ================= SINKRONISASI POIN (LEADERBOARD -> USERS) =================
    const syncBtn = document.getElementById("syncPoinBtn");
    
    syncBtn.addEventListener("click", async () => {
      const result = await Swal.fire({
          title: "Sinkronisasi Data Poin?",
          text: "Sistem akan menyalin total poin dari Leaderboard ke Database User. Lakukan ini jika ada siswa yang poinnya 0 padahal sudah bermain.",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#4f46e5", // Indigo
          cancelButtonColor: "#64748b",
          confirmButtonText: "Ya, Sinkronkan",
          cancelButtonText: "Batal",
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
            cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
      });
      
      if (!result.isConfirmed) return;
      
      try {
          // 1. Ambil data Leaderboard (Sumber Kebenaran)
          const lbSnap = await getDocs(collection(db, "leaderboard"));
          let updatedCount = 0;
          
          Swal.fire({
             title: 'Sedang Memproses...',
             text: 'Mohon tunggu sebentar',
             allowOutsideClick: false,
             didOpen: () => {
                 Swal.showLoading();
             }
          });
          
          const promises = [];
          
          lbSnap.forEach(docSnap => {
              const lbData = docSnap.data();
              const uid = docSnap.id;
              const realPoints = lbData.poinTotal || 0;
              
              if(realPoints > 0) {
                  // Update Users Collection
                  const p = updateDoc(doc(db, "users", uid), {
                      poinTotal: realPoints
                      // Kita tidak update 'poin' (harian) karena leaderboard adalah akumulasi
                  }).then(() => {
                      updatedCount++;
                  }).catch(e => {
                      console.warn(`Gagal update user ${uid}:`, e);
                      // Ignore error if user doc doesn't exist (maybe deleted)
                  });
                  promises.push(p);
              }
          });
          
          await Promise.all(promises);
          
          Swal.fire({
              icon: 'success',
              title: 'Sinkronisasi Selesai!',
              text: `Berhasil memperbarui data poin untuk ${updatedCount} siswa.`,
              background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
              color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
              confirmButtonColor: '#10b981',
              customClass: { popup: 'rounded-[2rem]' }
          });
          
      } catch (err) {
          console.error("Sync error:", err);
          Swal.fire({
              icon: 'error',
              title: 'Gagal Sinkronisasi',
              text: 'Terjadi kesalahan teknis.',
              background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
              color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b'
          });
      }
    });




    // FITUR HAPUS HASIL 
    window.hapusNilai = async function (docId) {
      const result = await Swal.fire({
        title: "Hapus Nilai?",
        text: "Yakin ingin menghapus data nilai ini? Data yang dihapus tidak bisa dikembalikan.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });

      if (!result.isConfirmed) return;

      try {
        // Change collection to 'quizArchive' (matching loadNilaiSiswa)
        await deleteDoc(doc(db, "quizArchive", docId));
        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Data nilai berhasil dihapus.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menghapus data.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      }
    };



    // UNTUK MENCETAK KARTU SISWA
    function generateAkunPdf(data) {
      const { jsPDF } = window.jspdf;
      // Orientasi Portrait, Satuan mm, Ukuran A4
      const doc = new jsPDF('p', 'mm', 'a4');

      // --- 1. SETTING HALAMAN & BORDER ---
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Buat border ganda (tebal di luar, tipis di dalam)
      doc.setLineWidth(1);
      doc.rect(5, 5, pageWidth - 10, pageHeight - 10); // Border luar
      doc.setLineWidth(0.3);
      doc.rect(7, 7, pageWidth - 14, pageHeight - 14); // Border dalam

      // --- 2. KOP SURAT (HEADER) ---
      // Placeholder Logo (Lingkaran) - Nanti bisa diganti doc.addImage()
      doc.setFillColor(200, 200, 200); // Warna abu-abu
      doc.circle(25, 25, 12, 'F'); // Lingkaran dummy logo
      doc.setFontSize(8);
      doc.text("Logo", 25, 26, { align: "center" });

      // Teks Kop Surat
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("INSTITUT AGAMA ISLAM BONE", 105, 22, { align: "center" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      doc.text("Media Pembelajaran Bahasa Arab - Tarbiyyat al-Lughah", 105, 29, { align: "center" });

      doc.setFontSize(10);
      doc.text("Alamat: Kampus IAI Bone, Jl. Cempalagi, Watampone", 105, 35, { align: "center" });

      // Garis Pembatas Kop (Double Line)
      doc.setLineWidth(1);
      doc.line(15, 42, 195, 42); // Garis tebal
      doc.setLineWidth(0.5);
      doc.line(15, 44, 195, 44); // Garis tipis

      // --- 3. JUDUL DOKUMEN ---
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("LEMBAR AKUN SISWA", 105, 60, { align: "center" });
      doc.setLineWidth(0.5);
      doc.line(75, 62, 135, 62); // Garis bawah judul pendek

      // --- 4. DATA SISWA (TABEL) ---
      let startY = 80;
      const colLabel = 40;
      const colSep = 80;
      const colVal = 85;
      const lineHeight = 10;

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");

      // Fungsi helper untuk baris data
      const printRow = (label, value, isBold = false) => {
        doc.setFont("helvetica", isBold ? "bold" : "normal");
        doc.text(label, colLabel, startY);
        doc.text(":", colSep, startY);
        doc.text(value ? value.toString() : "-", colVal, startY);
        startY += lineHeight;
      };

      printRow("Nama Lengkap", data.nama, true); // Bold nama
      printRow("NISN", data.nisn);
      printRow("Kelas", data.kelas);

      // --- 5. KOTAK KREDENSIAL (EMAIL & PASS) ---
      // Membuat kotak background agar info login menonjol
      startY += 5;
      doc.setDrawColor(0);
      doc.setFillColor(245, 245, 245); // Abu-abu sangat muda
      doc.roundedRect(30, startY, 150, 40, 3, 3, 'FD'); // FD = Fill & Draw

      startY += 12;
      // Di dalam kotak
      doc.setFont("courier", "bold"); // Pakai font monospaced biar jelas hurufnya
      doc.setTextColor(50, 50, 50);

      doc.text("Email Login", 40, startY);
      doc.text(`:  ${data.email}`, 90, startY);

      startY += 12;
      doc.text("Password Awal", 40, startY);
      doc.text(`:  ${data.password}`, 90, startY);

      // Reset Font
      doc.setFont("helvetica", "normal");
      doc.setTextColor(0, 0, 0);
      startY += 30; // Keluar dari kotak

      // --- 6. CATATAN PENTING ---
      doc.setFontSize(10);
      doc.setFont("helvetica", "italic");
      doc.text("CATATAN PENTING:", 30, startY);
      startY += 6;

      const notes = [
        "1. Password di atas hanya untuk siswa, jadi tidak bisa di pakai untuk login di tempat lain.",
        "2. Simpan dokumen ini dengan baik dan jangan berikan password kepada orang lain.",
        "3. Jika mengalami kendala login, segera hubungi admin/guru bahasa Arab."
      ];

      notes.forEach(note => {
        doc.text(note, 30, startY);
        startY += 5;
      });

      // --- 7. FOOTER & TANDA TANGAN ---
      const dateStr = new Date().toLocaleDateString("id-ID", {
        day: 'numeric', month: 'long', year: 'numeric'
      });

      const signY = 220;

      // Kolom Tanda Tangan (Kanan Bawah)
      doc.setFont("helvetica", "normal");
      doc.text(`Watampone, ${dateStr}`, 140, signY);
      doc.text("Mengetahui,", 140, signY + 6);
      doc.setFont("helvetica", "bold");
      doc.text("Guru Pengampu", 140, signY + 12);

      // Space Tanda Tangan
      doc.text("( ___________________ )", 140, signY + 35);

      // Info Cetak di paling bawah
      doc.setFontSize(8);
      doc.setFont("helvetica", "italic");
      doc.text(`Dicetak otomatis oleh Sistem Pembelajaran Bahasa Arab pada ${new Date().toLocaleString("id-ID")}`, pageWidth / 2, pageHeight - 10, { align: "center" });

      // Simpan File
      const fileName = `akun-siswa-${data.nama}-${data.kelas}.pdf`.replace(/\s+/g, "_");
      doc.save(fileName);
    }



    // ===============================
    // LOGIC UPLOAD PDF BOOKS (FINAL)
    // ===============================
    const storage = getStorage();

    document.getElementById("btnUploadEbook").onclick = async () => {
      const titleAr = ebookTitleAr.value.trim();
      const titleId = ebookTitleId.value.trim();
      const category = ebookCategory.value;
      const file = ebookFile.files[0];
      const statusEl = ebookUploadStatus;

      if (!titleAr || !titleId || !file) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Lengkapi seluruh data e-book sebelum mengunggah.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#f59e0b',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
        return;
      }

      if (!currentUser) {
        Swal.fire({
          icon: 'error',
          title: 'Sesi Berakhir',
          text: 'Silakan login kembali sebagai guru.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
        return;
      }

      try {
        statusEl.textContent = "â³ Mengupload PDF...";
        statusEl.className = "text-blue-500";
        statusEl.classList.remove("hidden");

        // ===============================
        // 1ï¸âƒ£ SET ID & PATH (PENTING)
        // ===============================
        const ebookId = Date.now().toString();

        const pdfPath = `ebooks/${category}/${ebookId}.pdf`;
        const coverPath = `ebooks/covers/${ebookId}.png`;

        // ===============================
        // 2ï¸âƒ£ UPLOAD PDF
        // ===============================
        const pdfRef = storageRef(storage, pdfPath);
        await uploadBytes(pdfRef, file);
        const pdfUrl = await getDownloadURL(pdfRef);

        // ===============================
        // 3ï¸âƒ£ GENERATE COVER (PDF.JS)
        // ===============================
        const pdfData = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const page = await pdf.getPage(1);

        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport }).promise;

        const blob = await new Promise(resolve =>
          canvas.toBlob(resolve, "image/png")
        );

        // ===============================
        // 4ï¸âƒ£ UPLOAD COVER
        // ===============================
        statusEl.textContent = "â³ Mengupload cover...";
        const coverRef = storageRef(storage, coverPath);
        await uploadBytes(coverRef, blob);
        const coverUrl = await getDownloadURL(coverRef);

        // ===============================
        // 5ï¸âƒ£ SIMPAN METADATA (FINAL)
        // ===============================
        await addDoc(collection(db, "ebooks"), {
          title_ar: titleAr,
          title_id: titleId,
          category,
          level: ebookCategory.options[ebookCategory.selectedIndex].text,

          // URL (untuk dibuka)
          fileUrl: pdfUrl,
          coverUrl,

          // ðŸ”¥ PATH (UNTUK HAPUS)
          filePath: pdfPath,
          coverPath: coverPath,

          uploadedBy: currentUser.uid,
          createdAt: serverTimestamp()
        });

        Swal.fire({
          icon: 'success',
          title: 'Diunggah!',
          text: 'E-Book berhasil ditambahkan.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });

        // reset form & status
        statusEl.classList.add("hidden");
        statusEl.textContent = "";
        ebookTitleAr.value = "";
        ebookTitleId.value = "";
        ebookFile.value = "";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "âŒ Gagal upload e-book";
        statusEl.className = "text-red-500";
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal mengunggah e-book.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      }
    };

    const LEVEL_LABEL = {
      mts7: "MTs Kelas 7",
      mts8: "MTs Kelas 8",
      mts9: "MTs Kelas 9",
      novel: "Novel Arab",
      kisah: "Kisah Islami"
    };

    function renderLevel(level) {
      return LEVEL_LABEL[level] || level || "-";
    }



    /* ===============================
       LOAD EBOOK ADMIN
    ================================ */
    let unsubEbooks = null;
    function loadEbookTable() {
      const tbody = document.getElementById("ebookTableBody");
      if (!tbody) return;

      if (unsubEbooks) unsubEbooks();

      tbody.innerHTML = `
    <tr>
      <td colspan="6" class="text-center py-4 dark:text-slate-400 text-slate-600">
        Memuat e-book...
      </td>
    </tr>
  `;

      const q = query(
        collection(db, "ebooks"),
        orderBy("createdAt", "desc")
      );

      unsubEbooks = onSnapshot(q, (snap) => {
        // Update count badge
        const ebookCountEl = document.getElementById("ebookCount");
        if (ebookCountEl) ebookCountEl.textContent = snap.size || 0;

        tbody.innerHTML = "";

        if (snap.empty) {
          tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-4 text-slate-400">
            Belum ada e-book
          </td>
        </tr>
      `;
          return;
        }

        let no = 1;
        snap.forEach(docSnap => {
          const e = docSnap.data();
          const id = docSnap.id;

          tbody.innerHTML += `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/40 transition-colors">
          <td class="px-6 py-4 text-center font-semibold text-slate-500">${no++}</td>

          <td class="px-6 py-4">
            <div class="font-bold text-slate-800 dark:text-slate-200">${e.title_ar}</div>
            <div class="text-xs text-slate-400">${e.title_id}</div>
          </td>

          <td class="px-6 py-4 text-center font-semibold text-slate-600 dark:text-slate-400">
              ${renderLevel(e.level)}
          </td>

          <td class="px-6 py-4 text-center">
            <a href="${e.fileUrl}" target="_blank"
               class="inline-flex items-center gap-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2.5 py-1 rounded-lg text-xs font-bold border border-blue-100 dark:border-blue-800/50 hover:bg-blue-100 transition-all">
              <i data-feather="file-text" class="w-3.5 h-3.5"></i> PDF
            </a>
          </td>

          <td class="px-6 py-4 text-xs text-center text-slate-500">
            ${e.createdAt?.toDate
              ? e.createdAt.toDate().toLocaleString("id-ID")
              : "-"}
          </td>

          <td class="px-6 py-4 text-center flex items-center justify-center gap-2">
            <button
              onclick="openEditEbook('${id}')"
              class="p-2 bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-lg border border-amber-100 dark:border-amber-800/50 hover:bg-amber-100 transition-all" title="Edit E-book">
              <i data-feather="edit-3" class="w-4 h-4"></i>
            </button>

            <button
              onclick="deleteEbook('${id}')"
              class="p-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg border border-red-100 dark:border-red-800/50 hover:bg-red-100 transition-all" title="Hapus E-book">
              <i data-feather="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `;
        });
        if(window.feather) feather.replace();
      }, (err) => {
        console.error(err);
        tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-4 text-red-400">
          Gagal memuat e-book
        </td>
      </tr>
    `;
      });
    }

    loadEbookTable();

    /* ===============================
       HAPUS E-BOOK (FIRESTORE + STORAGE)
    ================================= */
    window.deleteEbook = async function (ebookId) {
      const result = await Swal.fire({
        title: "Hapus E-book?",
        text: "Yakin ingin menghapus e-book ini? File dalam server juga akan terhapus.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });
      if (!result.isConfirmed) return;

      try {
        // 1ï¸âƒ£ Ambil data ebook dulu
        const ebookRef = doc(db, "ebooks", ebookId);
        const snap = await getDoc(ebookRef);

        if (!snap.exists()) {
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: 'Data e-book tidak ditemukan.',
            background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
            color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
            confirmButtonColor: '#ef4444'
          });
          return;
        }

        const ebook = snap.data();

        // 2ï¸âƒ£ Hapus PDF dari Storage
        if (ebook.filePath) {
          const pdfRef = storageRef(storage, ebook.filePath);
          await deleteObject(pdfRef);
        }

        // 3ï¸âƒ£ Hapus cover dari Storage
        if (ebook.coverPath) {
          const coverRef = storageRef(storage, ebook.coverPath);
          await deleteObject(coverRef);
        }

        // 4ï¸âƒ£ Hapus dokumen Firestore
        await deleteDoc(ebookRef);

        Swal.fire({
          icon: 'success',
          title: 'Terhapus!',
          text: 'E-book berhasil dihapus.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menghapus e-book.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      }
    };

    // EDIT BUKU
    let EDIT_ID = null;

    const editEbookModal = document.getElementById("editEbookModal");
    const editTitleAr = document.getElementById("editTitleAr");
    const editTitleId = document.getElementById("editTitleId");
    const editLevel = document.getElementById("editLevel");

    /* ===============================
       OPEN EDIT
    ================================ */
    window.openEditEbook = async (id) => {
      try {
        const snap = await getDoc(doc(db, "ebooks", id));
        if (!snap.exists()) {
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: 'E-book tidak ditemukan.',
            background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
            color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
            confirmButtonColor: '#ef4444'
          });
          return;
        }

        const e = snap.data();

        EDIT_ID = id;
        editTitleAr.value = e.title_ar || "";
        editTitleId.value = e.title_id || "";
        editLevel.value = e.level || "";

        editEbookModal.classList.remove("hidden");

      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal membuka edit e-book.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      }
    };

    /* ===============================
       SAVE EDIT
    ================================ */
    window.saveEditEbook = async () => {
      if (!EDIT_ID) return;

      if (!editTitleAr.value || !editTitleId.value || !editLevel.value) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Harap isi seluruh field edit e-book.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#f59e0b'
        });
        return;
      }

      try {
        await updateDoc(doc(db, "ebooks", EDIT_ID), {
          title_ar: editTitleAr.value.trim(),
          title_id: editTitleId.value.trim(),
          level: editLevel.value
        });

        closeEditEbook();

        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Perubahan e-book berhasil disimpan.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          timer: 1500,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menyimpan perubahan.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      }
    };

    /* ===============================
       CANCEL / CLOSE
    ================================ */
    window.closeEditEbook = () => {
      EDIT_ID = null;
      editEbookModal.classList.add("hidden");
    };


    // LOGIC SIMPAN SESI BELAJAR (VERSI BARU - HARIAN)
    const btnSaveSession = document.getElementById("btnSaveSession");
    const msg = document.getElementById("sessionMsg");

    btnSaveSession.addEventListener("click", async () => {
      const order = Number(document.getElementById("sessionOrder").value);
      const title = document.getElementById("sessionTitle").value.trim();
      const themeSelector = document.getElementById("sessionTheme");
      const themeId = themeSelector.value;
      const themeLabel = themeSelector.options[themeSelector.selectedIndex]?.text || themeId;

      const dailyTaskText = document.getElementById("dailyTaskText").value.trim();
      const isActive = document.getElementById("sessionActive").value === "true";

      // VALIDASI MINIMAL
      if (!order || !title || !themeId) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Pertemuan, judul, dan tema wajib diisi.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#f59e0b'
        });
        return;
      }

      // â³ LOADING STATE
      const originalBtnText = btnSaveSession.innerHTML;
      btnSaveSession.disabled = true;
      btnSaveSession.innerHTML = `<span>â³ Menyimpan...</span>`;

      try {
        // 1ï¸âƒ£ FETCH 5 RANDOM VOCABS FROM THEME
        let randomVocabs = [];
        
        const themeRef = doc(db, "themes", themeId);
        const themeSnap = await getDoc(themeRef);

        if (themeSnap.exists()) {
          const tData = themeSnap.data();
          let allVocabs = [];

          // Handle stringified JSON or Array
          if (Array.isArray(tData.vocabData)) {
            allVocabs = tData.vocabData;
          } else if (typeof tData.vocabData === 'string') {
            try { allVocabs = JSON.parse(tData.vocabData); } catch(e) {}
          }

          if (allVocabs.length > 0) {
            // Shuffle & Pick 5
            const shuffled = allVocabs.sort(() => 0.5 - Math.random());
            randomVocabs = shuffled.slice(0, 5);
          }
        }

        // 2ï¸âƒ£ SAVE SESSION
        await addDoc(collection(db, "learningSessions"), {
          order,
          title,
          theme: themeId, // ID for machine
          themeLabel: themeLabel, // Checkpoint label if needed
          dailyTaskText,
          isActive,
          mandatoryVocabs: randomVocabs, // ðŸ”¥ DATA KOSAKATA DINAMIS
          createdAt: serverTimestamp()
        });

        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: `Sesi berhasil disimpan dengan ${randomVocabs.length} kosakata acak.`,
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          customClass: {
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
          }
        });

        // Reset form
        document.querySelectorAll(
          "#sessionOrder, #sessionTitle, #sessionTheme, #dailyTaskText"
        ).forEach(el => el.value = "");
        document.getElementById("sessionActive").value = "true";

      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menyimpan sesi: ' + err.message,
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      } finally {
        btnSaveSession.disabled = false;
        btnSaveSession.innerHTML = originalBtnText;
      }
    });

    // POPULATE DROPDOWN FUNCTION
    function populateSessionThemeDropdown() {
       const select = document.getElementById("sessionTheme");
       if(!select) return;

       onSnapshot(collection(db, "themes"), (snap) => {
          if(snap.empty) {
             select.innerHTML = `<option value="">-- Belum ada tema --</option>`;
             return;
          }

          let html = `<option value="">-- Pilih Tema --</option>`;
          snap.forEach(docSnap => {
             const data = docSnap.data();
             // Show Title + (ID) for clarity
             html += `<option value="${docSnap.id}">${data.title}</option>`;
          });
          select.innerHTML = html;
       });
    }





    // LOAD DATA SESI BELAJAR (REALTIME)
    const sessionTableBody = document.getElementById("sessionTableBody");

    function loadSessionsForGuruRealtime() {
      sessionTableBody.innerHTML = `
    <tr>
      <td colspan="5" class="px-3 py-4 text-center text-slate-400">
        Memuat data sesi...
      </td>
    </tr>
  `;

      try {
        const q = query(
          collection(db, "learningSessions"),
          orderBy("order", "asc")
        );

        onSnapshot(q, (snap) => {
          // Update count badge
          const sessionCountEl = document.getElementById("sessionCount");
          if (sessionCountEl) sessionCountEl.textContent = snap.size || 0;

          if (snap.empty) {
            sessionTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-3 py-4 text-center text-slate-400">
              Belum ada sesi
            </td>
          </tr>
        `;
            return;
          }

          sessionTableBody.innerHTML = "";

          snap.forEach(docSnap => {
            const s = docSnap.data();
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-900/40 transition-colors";
            tr.innerHTML = `
          <td class="px-6 py-4 font-semibold text-slate-500">${s.order}</td>
          <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${s.title}</td>
          <td class="px-6 py-4 capitalize text-emerald-600 dark:text-emerald-400 font-bold text-xs">${s.theme}</td>

          <td class="px-6 py-4 text-center">
            <button
              class="toggleStatus px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter
                ${s.isActive ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 ring-1 ring-green-200 dark:ring-green-900/50" : "bg-slate-100 text-slate-600 dark:bg-slate-900/30 dark:text-slate-400 ring-1 ring-slate-200 dark:ring-slate-800"}"
              data-id="${docSnap.id}"
              data-active="${s.isActive}">
              ${s.isActive ? "Aktif" : "Nonaktif"}
            </button>
          </td>

          <td class="px-6 py-4 text-center">
            <button
              class="deleteSession inline-flex items-center gap-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 dark:border-red-800/50 hover:bg-red-100 transition-all"
              data-id="${docSnap.id}">
              <i data-feather="trash-2" class="w-3.5 h-3.5"></i> Hapus
            </button>
          </td>
        `;

            sessionTableBody.appendChild(tr);
          });
          if(window.feather) feather.replace();
        });

      } catch (err) {
        console.error(err);
        sessionTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-3 py-4 text-center text-red-500">
          Gagal memuat data sesi
        </td>
      </tr>
    `;
      }
    }


    // TOMBOL ON/OFF SESI BELAJAR
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".toggleStatus");
      if (!btn) return;

      const id = btn.dataset.id;
      const current = btn.dataset.active === "true";
      const newStatus = !current;

      btn.disabled = true;
      btn.textContent = "Menyimpan...";

      try {
        await updateDoc(doc(db, "learningSessions", id), {
          isActive: newStatus
        });
        // TIDAK perlu ubah UI manual
        // onSnapshot() akan update UI otomatis

      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal mengubah status sesi.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      } finally {
        btn.disabled = false;
      }
    });

    // HAPUS SESI
    // TOMBOL HAPUS SESI BELAJAR
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".deleteSession");
      if (!btn) return;

      const id = btn.dataset.id;

      const result = await Swal.fire({
        title: "Hapus Sesi Belajar?",
        text: "Seluruh data sesi ini akan dihapus permanen. Lanjutkan?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal",
        background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
        color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
        customClass: {
          popup: 'rounded-[2rem]',
          confirmButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest',
          cancelButton: 'rounded-xl px-6 py-2.5 font-bold uppercase tracking-widest'
        }
      });

      if (!result.isConfirmed) return;

      try {
        await deleteDoc(doc(db, "learningSessions", id));

        Swal.fire({
          icon: 'success',
          title: 'Terhapus!',
          text: 'Sesi belajar berhasil dihapus.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#10b981',
          timer: 1500,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: 'Gagal menghapus sesi belajar.',
          background: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#1e293b',
          confirmButtonColor: '#ef4444'
        });
      }
    });


    // ===============================
    // ðŸ“¬ KOTAK SURAT GURU - LOGIC
    // ===============================

    const announcementTableBody = document.getElementById("announcementTableBody");
    const announcementCountEl = document.getElementById("announcementCount");

    // SEND ANNOUNCEMENT
    document.getElementById("btnSendAnnouncement")?.addEventListener("click", async () => {
      const title = document.getElementById("announcementTitle").value.trim();
      const body = document.getElementById("announcementBody").value.trim();

      if (!title || !body) {
        Swal.fire({
          icon: "warning",
          title: "Form belum lengkap",
          text: "Judul dan isi pengumuman wajib diisi.",
          confirmButtonColor: "#f59e0b"
        });
        return;
      }

      try {
        await addDoc(collection(db, "announcements"), {
          title,
          body,
          createdAt: serverTimestamp(),
          createdBy: "Guru"
        });

        Swal.fire({
          icon: "success",
          title: "Pengumuman Terkirim!",
          text: "Semua siswa dapat melihat pengumuman ini.",
          confirmButtonColor: "#f59e0b"
        });

        // Reset form
        document.getElementById("announcementTitle").value = "";
        document.getElementById("announcementBody").value = "";

      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Gagal Mengirim",
          text: "Terjadi kesalahan saat mengirim pengumuman."
        });
      }
    });

    // LOAD ANNOUNCEMENTS REALTIME
    function loadAnnouncementsForGuru() {
      const q = query(
        collection(db, "announcements"),
        orderBy("createdAt", "desc")
      );

      onSnapshot(q, (snap) => {
        announcementCountEl.textContent = snap.size;

        if (snap.empty) {
          announcementTableBody.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-8 text-center text-slate-400 dark:text-slate-500 italic">
                Belum ada pengumuman yang dikirim.
              </td>
            </tr>
          `;
          return;
        }

        announcementTableBody.innerHTML = "";
        let idx = 1;

        snap.forEach(docSnap => {
          const a = docSnap.data();
          const date = a.createdAt?.toDate?.() 
            ? a.createdAt.toDate().toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" })
            : "-";

          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors";
          tr.innerHTML = `
            <td class="px-6 py-4 text-slate-500 font-semibold">${idx++}</td>
            <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${a.title}</td>
            <td class="px-6 py-4 text-slate-500 text-xs">${date}</td>
            <td class="px-6 py-4 text-center">
              <button class="deleteAnnouncement inline-flex items-center gap-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 dark:border-red-800/50 hover:bg-red-100 transition-all"
                data-id="${docSnap.id}">
                <i data-feather="trash-2" class="w-3.5 h-3.5"></i> Hapus
              </button>
            </td>
          `;
          announcementTableBody.appendChild(tr);
        });
        if(window.feather) feather.replace();
      });
    }

    // DELETE ANNOUNCEMENT
    document.getElementById("announcementTableBody")?.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("deleteAnnouncement")) return;

      const docId = e.target.dataset.id;

      const result = await Swal.fire({
        title: "Hapus Pengumuman?",
        text: "Pengumuman ini akan dihapus permanen.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#64748b",
        confirmButtonText: "Ya, Hapus",
        cancelButtonText: "Batal"
      });

      if (!result.isConfirmed) return;

      try {
        await deleteDoc(doc(db, "announcements", docId));
        Swal.fire({
          icon: "success",
          title: "Dihapus!",
          text: "Pengumuman berhasil dihapus.",
          timer: 1500,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Gagal Menghapus",
          text: "Terjadi kesalahan."
        });
      }
    });

    // Initialize announcements on load
    loadAnnouncementsForGuru();

    // TOGGLE RIWAYAT SESI
    window.toggleSessionList = function() {
      const content = document.getElementById("sessionListContent");
      const chevron = document.getElementById("sessionChevron");
      if (!content || !chevron) return;

      content.classList.toggle("hidden");
      if (content.classList.contains("hidden")) {
        chevron.classList.add("-rotate-90");
      } else {
        chevron.classList.remove("-rotate-90");
      }
    };


    /* ======================================================
       8. MANAJEMEN MATERI (THEMES) - MERGED LOGIC
       Uses authenticated 'db' and 'auth' instance
    ====================================================== */
    
    // RENDER LIST (Realtime)
    function renderThemesRealtime() {
      const container = document.getElementById("themeListContainer");
      if(!container) return;

      container.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">â³ Memuat daftar materi...</div>`;

      // Use onSnapshot for realtime updates
      onSnapshot(collection(db, "themes"), (snap) => {
         if(snap.empty) {
            container.innerHTML = `<div class="col-span-full text-center py-10 italic text-slate-400">Belum ada materi tersimpan.</div>`;
            return;
         }

         container.innerHTML = "";
         const themes = [];
         snap.forEach(d => themes.push(d.data()));
         
         // Sort by ID (numeric if possible)
         themes.sort((a,b) => (parseInt(a.id)||0) - (parseInt(b.id)||0));

         // Helper for Toggle
         window.toggleCard = (id) => {
             const body = document.getElementById(`card-body-${id}`);
             const chev = document.getElementById(`chevron-${id}`);
             if(body) body.classList.toggle('hidden');
             if(chev) chev.classList.toggle('rotate-180');
         };

         themes.forEach(data => {
            const isHidden = data.isVisible === false;
            // Parse Counts
            let vCount = 0, rCount = 0, qCount = 0;
            try { vCount = data.vocabData ? (typeof data.vocabData === 'string' ? JSON.parse(data.vocabData).length : data.vocabData.length) : 0; } catch(e){}
            try { rCount = data.readData ? (typeof data.readData === 'string' ? JSON.parse(data.readData).length : data.readData.length) : 0; } catch(e){}
            try { qCount = data.quizData ? (typeof data.quizData === 'string' ? JSON.parse(data.quizData).length : data.quizData.length) : 0; } catch(e){}

            const colorMap = {
              emerald: "text-emerald-600 bg-emerald-100",
              lime: "text-lime-600 bg-lime-100",
              rose: "text-rose-600 bg-rose-100",
              amber: "text-amber-600 bg-amber-100",
              slate: "text-slate-600 bg-slate-100",
              blue: "text-blue-600 bg-blue-100"
            };
            const themeColorClass = colorMap[data.color || 'blue'];
            
            container.innerHTML += `
              <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden mb-3 hover:shadow-md transition-all">
                 
                 <!-- HEADER (Clickable) -->
                 <div onclick="window.toggleCard('${data.id}')" class="p-4 cursor-pointer flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                    <div class="flex items-center gap-4">
                       <!-- Color Icon -->
                       <div class="w-10 h-10 rounded-full flex items-center justify-center ${themeColorClass} font-bold text-lg shadow-sm">
                          ${data.arTitle ? data.arTitle.charAt(0) : '#'}
                       </div>
                       
                       <div>
                          <div class="flex items-center gap-2">
                              <h4 class="font-bold text-slate-800 dark:text-slate-200 text-lg leading-tight group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                                 ${data.title}
                              </h4>
                              ${isHidden ? '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-200 text-slate-500 uppercase">Hidden</span>' : ''}
                           </div>
                          <div class="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2">
                              <span class="arabic-text font-bold text-slate-400 dark:text-slate-500">${data.arTitle}</span>
                              <span>â€¢</span>
                              <span class="font-mono bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-[10px] font-bold">
                                 ${vCount} Kosakata
                              </span>
                              <span class="font-mono bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-[10px] font-bold">
                                 ${qCount} Kuis
                              </span>
                          </div>
                       </div>
                    </div>

                    <!-- Chevron -->
                    <div id="chevron-${data.id}" class="text-slate-400 transition-transform duration-300">
                       <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                       </svg>
                    </div>
                 </div>

                 <!-- BODY (Hidden Default) -->
                 <div id="card-body-${data.id}" class="hidden border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 p-4">
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 italic">"${data.desc}"</p>
                    
                    <div class="grid grid-cols-3 gap-3">
                       <button onclick="window.toggleVisibility('${data.id}', ${!isHidden})" class="py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-xs font-bold transition">
                          ${isHidden ? 'ðŸ‘ï¸ Tampilkan' : 'ðŸ™ˆ Sembunyikan'}
                       </button>
                       <button onclick="window.editTheme('${data.id}')" class="py-2 rounded-lg bg-indigo-50 border border-indigo-100 text-indigo-600 hover:bg-indigo-100 text-xs font-bold transition">
                          âœï¸ Edit
                       </button>
                       <button onclick="window.deleteTheme('${data.id}')" class="py-2 rounded-lg bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 text-xs font-bold transition">
                          ðŸ—‘ï¸ Hapus
                       </button>
                    </div>
                    
                    <div class="mt-3 text-[10px] text-end text-slate-400 font-mono">ID: ${data.id}</div>
                 </div>

              </div>
            `;
         });
      }, (err) => {
         console.error("Theme render error:", err);
         container.innerHTML = `<div class="col-span-full text-red-500 text-center">Gagal memuat: ${err.message}</div>`;
      });
    }

    // AUTO-CLEAR ID ON TITLE CHANGE (Unless Editing)
    document.getElementById('themeTitle')?.addEventListener('input', () => {
        const idField = document.getElementById('themeId');
        // If ID field is NOT disabled (meaning not in explicit Edit Mode), clear it to ensure new ID gen
        if(!idField.disabled) {
            idField.value = ""; 
        }
    });

    /* ===============================
       LOGIC VOCAB BUILDER
    ================================ */
    let currentVocabData = [];

    function renderVocabList() {
      const listEl = document.getElementById('vocabPreviewList');
      const hiddenInput = document.getElementById('themeVocabJson');
      if(!listEl) return;

      listEl.innerHTML = "";
      if(hiddenInput) hiddenInput.value = JSON.stringify(currentVocabData);

      if(currentVocabData.length === 0) {
        listEl.innerHTML = `<p class="text-center text-xs text-slate-400 italic py-2">Belum ada kosakata.</p>`;
        return;
      }

      currentVocabData.forEach((item, idx) => {
         const div = document.createElement('div');
         div.className = "flex items-center justify-between p-2 bg-white dark:bg-slate-800 rounded border border-indigo-100 dark:border-indigo-900 text-xs";
         div.innerHTML = `
           <div class="flex-1 min-w-0 pr-2">
             <div class="font-arab font-bold truncate text-right text-indigo-700 dark:text-indigo-400" dir="rtl">${item.ar} ${item.jamak ? '('+item.jamak+')' : ''}</div>
             <div class="text-slate-500 truncate">${item.arti || '-'}</div>
           </div>
           <button type="button" onclick="deleteVocabItem(${idx})" class="p-1.5 text-red-500 hover:bg-red-50 rounded transition">
             <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
           </button>
         `;
         listEl.appendChild(div);
      });
    }

    window.deleteVocabItem = (idx) => {
       if(confirm('Hapus kosakata ini?')) {
          currentVocabData.splice(idx, 1);
          renderVocabList();
       }
    };

    document.getElementById('btnAddVocabItem')?.addEventListener('click', () => {
       const ar = document.getElementById('vocabArInput').value.trim();
       const jamak = document.getElementById('vocabJamakInput').value.trim();
       const arti = document.getElementById('vocabIdnInput').value.trim();

       if(!ar || !arti) return Swal.fire('Data Kurang', 'Mufrod Arab dan Arti wajib diisi!', 'warning');

       currentVocabData.push({ ar, jamak, arti });
       renderVocabList();
       
       // Clear Inputs
       document.getElementById('vocabArInput').value = "";
       document.getElementById('vocabJamakInput').value = "";
       document.getElementById('vocabIdnInput').value = "";
       document.getElementById('vocabArInput').focus();
    });

    /* ===============================
       LOGIC QUIZ BUILDER
    ================================ */
    let currentQuizData = [];

    function renderQuizList() {
      const listEl = document.getElementById('quizPreviewList');
      const hiddenInput = document.getElementById('themeQuizJson');
      if(!listEl) return;

      listEl.innerHTML = "";
      if(hiddenInput) hiddenInput.value = JSON.stringify(currentQuizData);

      if(currentQuizData.length === 0) {
        listEl.innerHTML = `<p class="text-center text-xs text-slate-400 italic py-2">Belum ada soal.</p>`;
        return;
      }

      currentQuizData.forEach((item, idx) => {
         const div = document.createElement('div');
         div.className = "p-2 bg-white dark:bg-slate-800 rounded border border-amber-100 dark:border-amber-900 text-xs mb-1";
         div.innerHTML = `
           <div class="flex justify-between items-start">
             <div class="flex-1">
                <span class="font-bold text-slate-800 dark:text-slate-200">Q: ${item.question}</span>
                ${item.ar ? `<div class="font-arab text-right text-amber-600 dark:text-amber-500 my-1" dir="rtl">${item.ar}</div>` : ''}
                <div class="grid grid-cols-2 gap-x-2 text-[10px] text-slate-500 mt-1">
                   <span class="${item.correct==='A'?'font-bold text-green-600':''}">A. ${item.options[0]}</span>
                   <span class="${item.correct==='B'?'font-bold text-green-600':''}">B. ${item.options[1]}</span>
                   <span class="${item.correct==='C'?'font-bold text-green-600':''}">C. ${item.options[2]}</span>
                   <span class="${item.correct==='D'?'font-bold text-green-600':''}">D. ${item.options[3]}</span>
                </div>
             </div>
             <button type="button" onclick="deleteQuizItem(${idx})" class="text-red-500 hover:text-red-700 ml-2">âŒ</button>
           </div>
         `;
         listEl.appendChild(div);
      });
    }

    window.deleteQuizItem = (idx) => {
       if(confirm('Hapus soal ini?')) {
          currentQuizData.splice(idx, 1);
          renderQuizList();
       }
    };

    document.getElementById('btnAddQuizItem')?.addEventListener('click', () => {
       const q = document.getElementById('quizQuestionInput').value.trim();
       const ar = document.getElementById('quizArInput').value.trim();
       const a = document.getElementById('optA').value.trim();
       const b = document.getElementById('optB').value.trim();
       const c = document.getElementById('optC').value.trim();
       const d = document.getElementById('optD').value.trim();
       const correct = document.getElementById('correctAnswer').value;

       if(!q || !a || !b || !c || !d || !correct) {
          return Swal.fire('Data Kurang', 'Semua form soal dan opsi jawaban wajib diisi!', 'warning');
       }

       currentQuizData.push({
          question: q,
          ar: ar, // Optional
          options: [a, b, c, d],
          correct: correct
       });
       
       renderQuizList();
       
       // Clear Inputs
       document.getElementById('quizQuestionInput').value = "";
       document.getElementById('quizArInput').value = "";
       document.getElementById('optA').value = "";
       document.getElementById('optB').value = "";
       document.getElementById('optC').value = "";
       document.getElementById('optD').value = "";
       document.getElementById('correctAnswer').value = "";
       document.getElementById('quizQuestionInput').focus();
    });

    /* ===============================
       LOGIC READING BUILDER (AUDIO)
    ================================ */
    let currentReadData = [];

    // RENDER LIST
    function renderReadList() {
      const listEl = document.getElementById('readPreviewList');
      const hiddenInput = document.getElementById('themeReadJson');
      if(!listEl) return;

      listEl.innerHTML = "";
      
      // Update hidden JSON
      if(hiddenInput) hiddenInput.value = JSON.stringify(currentReadData);

      if(currentReadData.length === 0) {
        listEl.innerHTML = `<p class="text-center text-xs text-slate-400 italic py-2">Belum ada data bacaan.</p>`;
        return;
      }

      currentReadData.forEach((item, idx) => {
         const hasAudio = item.audio ? 'ðŸ”Š' : 'ðŸ”‡';
         const div = document.createElement('div');
         div.className = "flex items-center justify-between p-2 bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700 text-xs";
         div.innerHTML = `
           <div class="flex-1 min-w-0 pr-2">
             <div class="font-arab font-bold truncate text-right" dir="rtl">${item.ar || '-'}</div>
             <div class="text-slate-500 truncate">${item.idn || '-'}</div>
             <div class="text-[9px] text-blue-500 mt-0.5">${hasAudio} ${item.audio ? 'Audio Tersedia' : 'Tanpa Audio'}</div>
           </div>
           <button type="button" onclick="deleteReadItem(${idx})" class="p-1.5 text-red-500 hover:bg-red-50 rounded transition">
             <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
           </button>
         `;
         listEl.appendChild(div);
      });
    }

    // DELETE ITEM
    window.deleteReadItem = (idx) => {
       if(confirm('Hapus item bacaan ini?')) {
          currentReadData.splice(idx, 1);
          renderReadList();
       }
    };

    // ADD ITEM
    document.getElementById('btnAddReadItem')?.addEventListener('click', async () => {
       const ar = document.getElementById('readArInput').value.trim();
       const idn = document.getElementById('readIdnInput').value.trim();
       const fileInput = document.getElementById('readAudioInput');
       const statusEl = document.getElementById('readAudioStatus');

       if(!ar || !idn) {
          return Swal.fire('Data Kurang', 'Teks Arab dan Terjemahan wajib diisi.', 'warning');
       }
       if(!fileInput.files[0]) {
          return Swal.fire('Audio Wajib', 'Mohon upload file audio MP3 untuk bacaan ini.', 'warning');
       }

       // Upload Process
       const file = fileInput.files[0];
       
       // Validate Theme ID presence (we need a theme folder)
       let themeId = document.getElementById('themeId').value.trim();
       if(!themeId) {
          // If creating new, try to gen ID or use 'temp'
          const title = document.getElementById('themeTitle').value.trim();
          if(title) {
             themeId = title.toLowerCase().replace(/[^a-z0-9]+/g, '-'); 
          } else {
             themeId = 'temp-upload';
          }
       }

       try {
           statusEl.textContent = "â³ Uploading...";
           statusEl.classList.remove('hidden');
           
           const timestamp = Date.now();
           const audioPath = `audio/${themeId}/${timestamp}.mp3`;
           // Using global storageRef, storage, uploadBytes, getDownloadURL logic
           const audioRef = storageRef(storage, audioPath);
           
           await uploadBytes(audioRef, file);
           const audioUrl = await getDownloadURL(audioRef);
           
           // Success
           currentReadData.push({
              title: "Bacaan Audio", 
              ar: ar,
              idn: idn,
              audio: audioUrl,
              audioPath: audioPath 
           });
           
           renderReadList();
           
           // Reset Inputs
           document.getElementById('readArInput').value = "";
           document.getElementById('readIdnInput').value = "";
           fileInput.value = "";
           statusEl.classList.add('hidden');
           
           Swal.fire({
             toast: true,
             position: 'top-end',
             icon: 'success',
             title: 'Berhasil ditambahkan',
             showConfirmButton: false,
             timer: 1500
           });

       } catch(e) {
           console.error(e);
           statusEl.textContent = "âŒ Gagal Upload";
           Swal.fire('Error', 'Gagal mengupload audio.', 'error');
       }
    });

    // SAVE LOGIC
    document.getElementById('btnSaveTheme')?.addEventListener('click', async () => {
       let idVal = document.getElementById('themeId').value.trim();
       
       // AUTO-GENERATE ID (Prevent Accidental Overwrite)
       if(!idVal) {
           const title = document.getElementById('themeTitle').value.trim();
           if(!title) return Swal.fire('Gagal', 'Judul materi wajib diisi!', 'warning');
           
           // Create slug: 'Materi Baru' -> 'materi-baru-1715...'
           const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
           const timestamp = Date.now().toString().slice(-4); 
           idVal = `${slug}-${timestamp}`;
       }
       
       // Only check existence if we are NOT in edit mode (edit mode locks ID field usually, but let's be safe)
       // Actually, since we auto-gen with timestamp, collision is impossible for new ones.
       // User complaint: "input lagi ... malahan tidak tertambah tapi materi sebelumnya yang di ubah"
       // This happens because they probably kept the old ID in the input box.
       // I'll ensure the form is cleared after save.


       let vocabObj = [], readObj = [], quizObj = [];
       try {
          const v = document.getElementById('themeVocabJson').value;
          const r = document.getElementById('themeReadJson').value;
          const q = document.getElementById('themeQuizJson').value;
          
          if(v) vocabObj = JSON.parse(v);
          if(r) readObj = JSON.parse(r);
          if(q) quizObj = JSON.parse(q);
       } catch(e) {
          return Swal.fire('Format JSON Salah', 'Mohon cek kembali format JSON pada Kosakata/Bacaan/Kuis. Pastikan tidak ada koma berlebih atau kutip kurang.', 'error');
       }

       const payload = {
          id: idVal,
          title: document.getElementById('themeTitle').value.trim(),
          arTitle: document.getElementById('themeArTitle').value.trim(),
          desc: document.getElementById('themeDesc').value.trim(),
          color: document.getElementById('themeColor').value,
          vocabData: vocabObj,
          readData: readObj,
          quizData: quizObj,
          updatedAt: new Date().toISOString(),
          isVisible: true 
       };

       const btn = document.getElementById('btnSaveTheme');
       const label = btn.querySelector('span');
       const originalText = label.textContent;
       
       btn.disabled = true;
       label.textContent = "â³ Menyimpan...";

       try {
          await setDoc(doc(db, "themes", idVal), payload, { merge: true });
          
          Swal.fire({
            icon: 'success',
            title: 'Tersimpan!',
            text: 'Materi berhasil disimpan ke database.',
            timer: 1500,
            showConfirmButton: false
          });
          
          // Clear form
          document.getElementById('btnResetForm').click();
          
       } catch(e) {
          console.error(e);
          Swal.fire('Gagal', e.message, 'error');
       } finally {
          btn.disabled = false;
          label.textContent = "ðŸ’¾ Simpan Tema & Materi";
       }
    });

    // EDIT LOGIC
    window.editTheme = async (id) => {
       try {
          // Fetch one-time to get data
          const snap = await getDoc(doc(db, "themes", id));
          if(snap.exists()) {
             const data = snap.data();
             
             document.getElementById('themeId').value = data.id;
             document.getElementById('themeId').disabled = true;
             document.getElementById('themeId').classList.add('bg-slate-200', 'cursor-not-allowed'); // Visual cue
             
             document.getElementById('themeTitle').value = data.title;
             document.getElementById('themeArTitle').value = data.arTitle;
             document.getElementById('themeDesc').value = data.desc;
             document.getElementById('themeColor').value = data.color || 'blue';
             
             // Ensure string format for JSON fields
             const safeStr = (val) => typeof val === 'object' ? JSON.stringify(val, null, 2) : (val || '');
             // document.getElementById('themeVocabJson').value = safeStr(data.vocabData);
             
             // LOAD VOCAB DATA
             try {
                if (data.vocabData) {
                   currentVocabData = typeof data.vocabData === 'string' ? JSON.parse(data.vocabData) : data.vocabData;
                } else {
                   currentVocabData = [];
                }
                renderVocabList();
             } catch(e) { console.error("Error loading vocab data", e); currentVocabData = []; renderVocabList(); }
             document.getElementById('themeVocabJson').value = safeStr(data.vocabData);
             
             // NEW: Load Read Data to Builder
             try {
                if (data.readData) {
                   currentReadData = typeof data.readData === 'string' ? JSON.parse(data.readData) : data.readData;
                } else {
                   currentReadData = [];
                }
                renderReadList();
             } catch(e) { console.error("Error loading read data", e); currentReadData = []; renderReadList(); }

             document.getElementById('themeReadJson').value = safeStr(data.readData);
             document.getElementById('themeReadJson').value = safeStr(data.readData);

             // LOAD QUIZ DATA
             try {
                if (data.quizData) {
                   currentQuizData = typeof data.quizData === 'string' ? JSON.parse(data.quizData) : data.quizData;
                } else {
                   currentQuizData = [];
                }
                renderQuizList();
             } catch(e) { console.error("Error loading quiz data", e); currentQuizData = []; renderQuizList(); }
             document.getElementById('themeQuizJson').value = safeStr(data.quizData);
             
             document.getElementById('themeId').scrollIntoView({behavior: 'smooth'});
             Swal.fire({
               toast: true,
               position: 'top-end',
               icon: 'info',
               title: 'Mode Edit: ' + data.title,
               showConfirmButton: false,
               timer: 3000
             });
          }
       } catch(e) {
          console.error(e);
          Swal.fire('Error', 'Gagal memuat data edit', 'error');
       }
    };

    // DELETE LOGIC
    window.deleteTheme = async (id) => {
       const confirm = await Swal.fire({
          title: 'Hapus Materi?',
          text: "Data tidak bisa dikembalikan!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Ya, Hapus!'
       });

       if (confirm.isConfirmed) {
          try {
             await deleteDoc(doc(db, "themes", id));
             Swal.fire('Terhapus!', 'Materi telah dihapus.', 'success');
          } catch(e) {
             Swal.fire('Gagal', e.message, 'error');
          }
       }
    };

    // VISIBILITY LOGIC
    window.toggleVisibility = async (id, status) => {
       try {
          await updateDoc(doc(db, "themes", id), { isVisible: status });
       } catch(e) {
          console.error(e);
          Swal.fire('Gagal', 'Gagal mengubah status visibilitas', 'error');
       }
    };

    // RESET FORM
    document.getElementById('btnResetForm')?.addEventListener('click', () => {
       document.getElementById('themeId').value = '';
       document.getElementById('themeId').disabled = false;
       document.getElementById('themeId').classList.remove('bg-slate-200', 'cursor-not-allowed');
       document.getElementById('themeTitle').value = '';
       document.getElementById('themeArTitle').value = '';
       document.getElementById('themeDesc').value = '';
       document.getElementById('themeColor').value = 'blue';
       document.getElementById('themeVocabJson').value = '';
       document.getElementById('themeReadJson').value = '';
       document.getElementById('themeQuizJson').value = '';
       currentReadData = [];
       renderReadList();
       currentVocabData = [];
       renderVocabList();
       currentQuizData = [];
       renderQuizList();
    });

    /* =========================================
       GRAMMAR MANAGEMENT LOGIC (DYNAMIC)
       ========================================= */
       
    // 1. Toggle UI
    window.toggleGrammar = function() {
        const content = document.getElementById('grammarContent');
        const chevron = document.getElementById('grammarChevron');
        content.classList.toggle('hidden');
        if (content.classList.contains('hidden')) {
            chevron.classList.add('-rotate-90');
        } else {
            chevron.classList.remove('-rotate-90');
        }
    };

    // 2. Render List
    function renderGrammarList() {
        const container = document.getElementById('grammarListContainer');
        if(!container) return;
        
        onSnapshot(collection(db, "grammar_missions"), (snapshot) => {
            if(snapshot.empty) {
                container.innerHTML = '<p class="text-sm text-slate-500 italic text-center">Belum ada misi grammar.</p>';
                return;
            }
            
            // Sort by urutan
            const missions = [];
            snapshot.forEach(doc => missions.push({id: doc.id, ...doc.data()}));
            missions.sort((a,b) => (a.urutan||0) - (b.urutan||0));

            let html = '';
            missions.forEach(m => {
                const lessonCount = m.lessons ? m.lessons.length : 0;
                html += `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:rgb-slate-50 relative group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-lg">
                            ${m.icon || 'ðŸ“'}
                        </div>
                        <div>
                            <h5 class="font-bold text-slate-800 dark:text-white text-sm">${m.judul_misi || m.id}</h5>
                            <p class="text-[10px] text-slate-500">${m.sub_judul || ''} â€¢ ${lessonCount} Materi</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button onclick="editGrammar('${m.id}')" class="p-2 text-slate-400 hover:text-blue-500">âœï¸</button>
                         <button onclick="deleteGrammar('${m.id}')" class="p-2 text-slate-400 hover:text-red-500">ðŸ—‘ï¸</button>
                    </div>
                </div>`;
            });
            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' + html + '</div>';
        });
    }

    // 3. Save Logic
    document.getElementById('btnSaveGrammar')?.addEventListener('click', async () => {
        const id = document.getElementById('gramId').value.trim();
        if(!id) return Swal.fire('Error', 'ID Misi wajib diisi!', 'error');
        
        const data = {
            id: id,
            urutan: parseInt(document.getElementById('gramOrder').value) || 99,
            judul_misi: document.getElementById('gramTitle').value,
            sub_judul: document.getElementById('gramSubtitle').value,
            icon: document.getElementById('gramIcon').value,
            lessons: [] // TODO: Parse JSON
        };
        
        try {
            const rawJson = document.getElementById('gramLessonsJson').value;
            if(rawJson) data.lessons = JSON.parse(rawJson);
        } catch(e) {
            return Swal.fire('JSON Error', 'Format JSON Lessons tidak valid!', 'error');
        }

        const btn = document.getElementById('btnSaveGrammar');
        btn.textContent = 'â³ Menyimpan...';
        btn.disabled = true;

        try {
            await setDoc(doc(db, "grammar_missions", id), data, { merge: true });
            Swal.fire('Sukses', 'Misi Grammar tersimpan!', 'success');
            document.getElementById('btnResetGrammar').click();
        } catch(e) {
            console.error(e);
            Swal.fire('Error', e.message, 'error');
        } finally {
            btn.innerHTML = '<span>ðŸ’¾ Simpan Misi Grammar</span>';
            btn.disabled = false;
        }
    });
    
    // 4. Edit Logic
    window.editGrammar = async (id) => {
        const snap = await getDoc(doc(db, "grammar_missions", id));
        if(snap.exists()) {
             const d = snap.data();
             document.getElementById('gramId').value = id;
             document.getElementById('gramOrder').value = d.urutan;
             document.getElementById('gramTitle').value = d.judul_misi;
             document.getElementById('gramSubtitle').value = d.sub_judul;
             document.getElementById('gramIcon').value = d.icon;
             document.getElementById('gramLessonsJson').value = JSON.stringify(d.lessons || [], null, 2);
             
             document.getElementById('grammarContent').classList.remove('hidden');
             const chevron = document.getElementById('grammarChevron');
             if(chevron) chevron.classList.remove('-rotate-90');
             document.getElementById('grammarContent').scrollIntoView({behavior: 'smooth'});
        }
    };
    
    // 5. Delete Logic
    window.deleteGrammar = async(id) => {
        const confirm = await Swal.fire({
            title: 'Hapus Misi?',
            text: "Data tidak bisa dikembalikan!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!'
        });
        
        if (confirm.isConfirmed) {
            try {
                await deleteDoc(doc(db, "grammar_missions", id));
                Swal.fire('Terhapus!', 'Misi telah dihapus.', 'success');
            } catch(e) {
                Swal.fire('Gagal', e.message, 'error');
            }
        }
    };
    
    // 6. Reset Logic
    document.getElementById('btnResetGrammar')?.addEventListener('click', () => {
         document.getElementById('gramId').value = '';
         document.getElementById('gramOrder').value = '';
         document.getElementById('gramTitle').value = '';
         document.getElementById('gramSubtitle').value = '';
         document.getElementById('gramIcon').value = '';
         document.getElementById('gramLessonsJson').value = '';
    });
    
    // 7. Init
    renderGrammarList();
    
    // 8. MIGRATION LOGIC (Import Default)
    const DEFAULT_GRAMMAR_DATA = {
      tahap: [
        { id: "t1", judul_id: "Jenis Kata", judul_ar: "Ø§Ù„ÙƒÙ„Ù…Ø©", deskripsi: "Mengenal jenis-jenis kata" },
        { id: "t2", judul_id: "Menyusun", judul_ar: "Ø§Ù„Ø¬Ù…Ù„Ø©", deskripsi: "Memahami bagaimana kata tersusun" },
        { id: "t3", judul_id: "Rasa Bahasa", judul_ar: "Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙÙŠ Ø§Ù„Ø¬Ù…Ù„Ø©", deskripsi: "Memahami makna khusus" }
      ],
      pelajaran: [
        { id: "t1-01", tahap: "t1", urutan: 1, judul_id: "Isim", judul_ar: "Ø§Ù„Ø§ÙØ³Ù’Ù…Ù", referensi: "Nahwu al-Muyassar, Hal. 4", tujuan: ["Siswa mengenal kata benda dalam bahasa Arab", "Siswa dapat membedakan isim dari fi'il dan harf"], penjelasan_muyassar: ["Isim adalah kata yang digunakan untuk menamai sesuatu.", "Nama orang, benda, hewan, tempat, dan sifat termasuk isim.", "Isim tidak menunjukkan waktu."], contoh: [{ ar: "Ù…ÙØ­ÙŽÙ…ÙŽÙ‘Ø¯ÙŒ Ø·ÙŽØ§Ù„ÙØ¨ÙŒ", id: "Muhammad adalah seorang murid.", fokus: "Kata Ù…ÙØ­ÙŽÙ…ÙŽÙ‘Ø¯ÙŒ dan Ø·ÙŽØ§Ù„ÙØ¨ÙŒ adalah isim" }, { ar: "Ø§Ù„Ù’Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©Ù ÙƒÙŽØ¨ÙÙŠØ±ÙŽØ©ÙŒ", id: "Sekolah itu besar.", fokus: "Kata Ø§Ù„Ù’Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©Ù adalah isim" }], batas_pemula: "Cukup pahami isim sebagai 'nama sesuatu'." },
        { id: "t1-02", tahap: "t1", urutan: 2, judul_id: "Fi'il", judul_ar: "Ø§Ù„ÙÙØ¹Ù’Ù„Ù", referensi: "Nahwu al-Muyassar, Hal. 6", tujuan: ["Siswa memahami bahwa fi'il menunjukkan perbuatan", "Siswa mengenal bahwa fi'il berkaitan dengan waktu"], penjelasan_muyassar: ["Fi'il adalah kata yang menunjukkan suatu perbuatan.", "Setiap fi'il berkaitan dengan waktu, baik sudah, sedang, atau akan.", "Kata seperti pergi, makan, dan menulis termasuk fi'il."], contoh: [{ ar: "Ø°ÙŽÙ‡ÙŽØ¨ÙŽ Ø£ÙŽØ­Ù’Ù…ÙŽØ¯Ù", id: "Ahmad telah pergi.", fokus: "Kata Ø°ÙŽÙ‡ÙŽØ¨ÙŽ adalah fi'il (perbuatan)" }, { ar: "ÙŠÙŽÙƒÙ’ØªÙØ¨Ù Ø§Ù„Ø·ÙŽÙ‘Ø§Ù„ÙØ¨Ù", id: "Murid itu sedang menulis.", fokus: "Kata ÙŠÙŽÙƒÙ’ØªÙØ¨Ù adalah fi'il" }], batas_pemula: "Tidak perlu membahas jenis-jenis fi'il secara rinci." },
        { id: "t1-03", tahap: "t1", urutan: 3, judul_id: "Harf", judul_ar: "Ø§Ù„Ø­ÙŽØ±Ù’ÙÙ", referensi: "Nahwu al-Muyassar, Hal. 8", tujuan: ["Siswa mengenal kata penghubung dalam bahasa Arab", "Siswa memahami bahwa harf tidak berdiri sendiri"], penjelasan_muyassar: ["Harf adalah kata yang berfungsi menghubungkan kata lain.", "Harf tidak memiliki makna sendiri jika berdiri sendiri.", "Makna harf muncul ketika bersama isim atau fi'il."], contoh: [{ ar: "ÙÙÙŠ Ø§Ù„Ù’Ø¨ÙŽÙŠÙ’ØªÙ", id: "Di dalam rumah.", fokus: "Kata ÙÙÙŠ adalah harf" }, { ar: "Ø¥ÙÙ„ÙŽÙ‰ Ø§Ù„Ù’Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©Ù", id: "Ke sekolah.", fokus: "Kata Ø¥ÙÙ„ÙŽÙ‰ adalah harf" }], batas_pemula: "Cukup pahami harf sebagai kata penghubung." },
        { id: "t2-01", tahap: "t2", urutan: 1, judul_id: "Kalimat dalam Bahasa Arab", judul_ar: "Ø§Ù„Ø¬ÙÙ…Ù’Ù„ÙŽØ©Ù", referensi: "Nahwu al-Muyassar, Hal. 12", tujuan: ["Siswa memahami pengertian kalimat", "Siswa mengetahui bahwa kalimat tersusun dari kata"], penjelasan_muyassar: ["Kalimat adalah rangkaian kata yang memiliki makna.", "Satu kata saja belum tentu menjadi kalimat.", "Dalam bahasa Arab, kalimat tersusun dari beberapa kata yang saling berkaitan."], contoh: [{ ar: "Ø§Ù„Ø·ÙŽÙ‘Ø§Ù„ÙØ¨Ù Ù…ÙØ¬Ù’ØªÙŽÙ‡ÙØ¯ÙŒ", id: "Murid itu rajin.", fokus: "Ini adalah satu kalimat utuh" }, { ar: "Ø°ÙŽÙ‡ÙŽØ¨ÙŽ Ø£ÙŽØ­Ù’Ù…ÙŽØ¯Ù", id: "Ahmad telah pergi.", fokus: "Kalimat terdiri dari beberapa kata" }], batas_pemula: "Fokus pada makna kalimat, bukan susunan iâ€˜rab." },
        { id: "t2-02", tahap: "t2", urutan: 2, judul_id: "Jumlah Ismiyyah", judul_ar: "Ø§Ù„Ø¬ÙÙ…Ù’Ù„ÙŽØ©Ù Ø§Ù„Ø§ÙØ³Ù’Ù…ÙÙŠÙŽÙ‘Ø©Ù", referensi: "Nahwu al-Muyassar, Hal. 14", tujuan: ["Siswa mengenal kalimat yang diawali isim", "Siswa memahami konsep subjek dan penjelas"], penjelasan_muyassar: ["Jumlah ismiyyah adalah kalimat yang diawali dengan isim.", "Kalimat ini biasanya membicarakan sesuatu dan menjelaskannya.", "Jumlah ismiyyah sering digunakan untuk menyatakan keadaan."], contoh: [{ ar: "Ø§Ù„Ù’Ø¨ÙŽÙŠÙ’ØªÙ ÙƒÙŽØ¨ÙÙŠØ±ÙŒ", id: "Rumah itu besar.", fokus: "Kalimat diawali isim Ø§Ù„Ù’Ø¨ÙŽÙŠÙ’ØªÙ" }, { ar: "Ø§Ù„Ø·ÙŽÙ‘Ø§Ù„ÙØ¨Ù Ù†ÙŽØ´ÙÙŠØ·ÙŒ", id: "Murid itu rajin.", fokus: "Isim di awal kalimat" }], batas_pemula: "Tidak perlu mengenal istilah mubtadaâ€™ dan khabar dulu." },
        { id: "t2-03", tahap: "t2", urutan: 3, judul_id: "Jumlah Fiâ€˜liyyah", judul_ar: "Ø§Ù„Ø¬ÙÙ…Ù’Ù„ÙŽØ©Ù Ø§Ù„Ù’ÙÙØ¹Ù’Ù„ÙÙŠÙŽÙ‘Ø©Ù", referensi: "Nahwu al-Muyassar, Hal. 16", tujuan: ["Siswa mengenal kalimat yang diawali fi'il", "Siswa memahami bahwa perbuatan bisa menjadi awal kalimat"], penjelasan_muyassar: ["Jumlah fiâ€˜liyyah adalah kalimat yang diawali dengan fi'il.", "Kalimat ini menekankan pada perbuatan yang terjadi.", "Pelaku perbuatan biasanya disebut setelah fi'il."], contoh: [{ ar: "Ø°ÙŽÙ‡ÙŽØ¨ÙŽ Ø§Ù„Ø·ÙŽÙ‘Ø§Ù„ÙØ¨Ù", id: "Murid itu pergi.", fokus: "Kalimat diawali fi'il Ø°ÙŽÙ‡ÙŽØ¨ÙŽ" }, { ar: "ÙŠÙŽÙ„Ù’Ø¹ÙŽØ¨Ù Ø§Ù„Ù’ÙˆÙŽÙ„ÙŽØ¯Ù", id: "Anak itu bermain.", fokus: "Fi'il muncul di awal kalimat" }], batas_pemula: "Cukup pahami urutan kata, bukan perubahan akhir kata." },
        { id: "t3-01", tahap: "t3", urutan: 1, judul_id: "Isim Isyarah", judul_ar: "Ø§ÙØ³Ù’Ù…Ù Ø§Ù„Ø¥ÙØ´ÙŽØ§Ø±ÙŽØ©Ù", referensi: "Nahwu al-Muyassar, Hal. 20", tujuan: ["Siswa mengenal kata tunjuk dalam bahasa Arab", "Siswa memahami fungsi menunjuk dalam kalimat"], penjelasan_muyassar: ["Isim isyarah adalah kata yang digunakan untuk menunjuk sesuatu.", "Kata tunjuk digunakan ketika sesuatu sudah diketahui atau terlihat.", "Isim isyarah selalu digunakan bersama kata lain."], contoh: [{ ar: "Ù‡ÙŽØ°ÙŽØ§ Ø¨ÙŽÙŠÙ’ØªÙŒ", id: "Ini adalah rumah.", fokus: "Ù‡ÙŽØ°ÙŽØ§ adalah kata tunjuk" }, { ar: "ØªÙÙ„Ù’ÙƒÙŽ Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©ÙŒ", id: "Itu adalah sekolah.", fokus: "ØªÙÙ„Ù’ÙƒÙŽ menunjuk sesuatu yang jauh" }], batas_pemula: "Cukup mengenal fungsi menunjuk, bukan pembagiannya." },
        { id: "t3-02", tahap: "t3", urutan: 2, judul_id: "Isim Maushul", judul_ar: "Ø§ÙØ³Ù’Ù…Ù Ø§Ù„Ù…ÙŽÙˆÙ’ØµÙÙˆÙ„Ù", referensi: "Nahwu al-Muyassar, Hal. 22", tujuan: ["Siswa mengenal kata penghubung makna", "Siswa memahami fungsi 'yang' dalam bahasa Arab"], penjelasan_muyassar: ["Isim maushul digunakan untuk menghubungkan dua bagian kalimat.", "Dalam bahasa Indonesia, sering diterjemahkan dengan kata 'yang'.", "Kata ini membantu menjelaskan sesuatu secara lebih rinci."], contoh: [{ ar: "Ø§Ù„Ø·ÙŽÙ‘Ø§Ù„ÙØ¨Ù Ø§Ù„ÙŽÙ‘Ø°ÙÙŠ ÙŠÙŽØ¬Ù’ØªÙŽÙ‡ÙØ¯Ù Ù†ÙŽØ§Ø¬ÙØ­ÙŒ", id: "Murid yang bersungguh-sungguh itu berhasil.", fokus: "Ø§Ù„ÙŽÙ‘Ø°ÙÙŠ menghubungkan penjelasan" }], batas_pemula: "Tidak perlu menghafal semua bentuk isim maushul." },
        { id: "t3-03", tahap: "t3", urutan: 3, judul_id: "Nidaâ€™ (Panggilan)", judul_ar: "Ø§Ù„Ù†ÙÙ‘Ø¯ÙŽØ§Ø¡Ù", referensi: "Nahwu al-Muyassar, Hal. 25", tujuan: ["Siswa memahami cara memanggil dalam bahasa Arab", "Siswa mengenal fungsi huruf panggilan"], penjelasan_muyassar: ["Nidaâ€™ digunakan ketika seseorang dipanggil atau diajak bicara.", "Biasanya menggunakan kata panggilan seperti 'wahai'.", "Panggilan memberi penekanan kepada orang yang diajak bicara."], contoh: [{ ar: "ÙŠÙŽØ§ Ø·ÙŽØ§Ù„ÙØ¨Ù", id: "Wahai murid!", fokus: "ÙŠÙŽØ§ adalah kata panggilan" }], batas_pemula: "Cukup mengenal bentuk umum nidaâ€™." },
        { id: "t3-04", tahap: "t3", urutan: 4, judul_id: "Istifham (Pertanyaan)", judul_ar: "Ø§Ù„Ø§ÙØ³Ù’ØªÙÙÙ’Ù‡ÙŽØ§Ù…Ù", referensi: "Nahwu al-Muyassar, Hal. 27", tujuan: ["Siswa mengenal kalimat tanya sederhana", "Siswa memahami fungsi bertanya dalam kalimat"], penjelasan_muyassar: ["Istifham digunakan untuk bertanya.", "Pertanyaan membantu mendapatkan informasi.", "Dalam bahasa Arab, ada kata khusus untuk bertanya."], contoh: [{ ar: "Ù…ÙŽÙ†Ù’ Ù‡ÙŽØ°ÙŽØ§ØŸ", id: "Siapa ini?", fokus: "Ù…ÙŽÙ†Ù’ digunakan untuk bertanya tentang orang" }, { ar: "Ù…ÙŽØ§ Ù‡ÙŽØ°ÙŽØ§ØŸ", id: "Apa ini?", fokus: "Ù…ÙŽØ§ digunakan untuk bertanya tentang benda" }], batas_pemula: "Cukup mengenal fungsi bertanya, bukan jenisnya." }
      ]
    }; // Hardcoded for migration

    document.getElementById('btnImportGrammarDefaults')?.addEventListener('click', async () => {
        const status = document.getElementById('importStatus');
        status.textContent = 'Memulai data upload...';
        
        const confirm = await Swal.fire({
            title: 'Import Default Data?',
            text: "Ini akan menimpa data t1, t2, t3 di database dengan data default.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Import!'
        });
        
        if(!confirm.isConfirmed) {
            status.textContent = 'Dibatalkan.';
            return;
        }

        try {
            const batch = writeBatch(db);
            
             for (const tahap of DEFAULT_GRAMMAR_DATA.tahap) {
                 const lessons = DEFAULT_GRAMMAR_DATA.pelajaran
                    .filter(p => p.tahap === tahap.id)
                    .sort((a,b) => a.urutan - b.urutan);
                 
                 const docRef = doc(db, "grammar_missions", tahap.id);
                 const data = {
                    urutan: parseInt(tahap.id.replace('t', '')),
                    judul_misi: tahap.id === 't1' ? "Misi 1: Jenis Kata" : (tahap.id === 't2' ? "Misi 2: Menyusun" : "Misi 3: Rasa Bahasa"),
                    sub_judul: tahap.id === 't1' ? "Isim, Fi'il, & Harf" : (tahap.id === 't2' ? "Membuat Kalimat" : "Memahami Makna"),
                    icon: tahap.id === 't1' ? "ðŸ§±" : (tahap.id === 't2' ? "ðŸ—ï¸" : "âœ¨"),
                    lessons: lessons
                 };
                batch.set(docRef, data);
             }

            await batch.commit();
            status.textContent = 'âœ… Sukses! Data default berhasil diupload.';
            Swal.fire('Sukses', 'Data default berhasil diimport!', 'success');
            renderGrammarList(); // Refresh List
        } catch(e) {
            console.error(e);
            status.textContent = 'âŒ Error: ' + e.message;
            Swal.fire('Gagal', e.message, 'error');
        }
    });

  </script>




  <!-- =========================================
       FLASHCARD & HARAKAT LOGIC (CONSOLIDATED)
       ========================================= -->
  <script type="module">
      import { db, auth } from "./assets/js/firebase-config.js";
      import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      
      console.log("Teacher Dashboard Module Loading (Shared Firebase)...");

      /* -------------------------------------
         1. FLASHCARDS LOGIC
         ------------------------------------- */
      window.allFlashcards = [];
      let unsubFlash = null;

      window.loadFlashcards = () => {
          const container = document.getElementById('flashcardListContainer');
          const counter = document.getElementById('flashcardCount');
          if(!container) return;

          if(unsubFlash) unsubFlash();

          if(window.allFlashcards.length === 0) {
              container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Memuat data flashcards...</p>';
          }

          const q = query(collection(db, "flashcards"), orderBy("id", "asc"));
          unsubFlash = onSnapshot(q, (snap) => {
              window.allFlashcards = [];
              snap.forEach(d => window.allFlashcards.push({ docId: d.id, ...d.data() }));

              if(counter) counter.innerText = window.allFlashcards.length;
              
              const btnMig = document.getElementById('btnMigrate');
              if(window.allFlashcards.length === 0) btnMig?.classList.remove('hidden');
              else btnMig?.classList.add('hidden');

              const searchVal = document.getElementById('searchFlashcard')?.value || '';
              if (searchVal) {
                  const term = searchVal.toLowerCase();
                  const filtered = window.allFlashcards.filter(c => 
                     (c.id && c.id.toLowerCase().includes(term)) || 
                     (c.ar && c.ar.includes(term)) ||
                     (c.tema && c.tema.toLowerCase().includes(term))
                  );
                  renderFlashcards(filtered);
              } else {
                  renderFlashcards(window.allFlashcards);
              }
          }, (err) => {
              console.error("Flashcard listener error:", err);
              document.getElementById('btnMigrate')?.classList.remove('hidden');
          });
      };

      window.renderFlashcards = (data) => {
          const container = document.getElementById('flashcardListContainer');
          if(!container) return;

          if(data.length === 0) {
              container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Data kosong.</p>';
              return;
          }

          // Group by Theme
          const groups = {};
          data.forEach(item => {
             const t = (item.tema || 'Umum').trim(); 
             if(!groups[t]) groups[t] = [];
             groups[t].push(item);
          });
          
          const sortedThemes = Object.keys(groups).sort();

          let html = '';
          sortedThemes.forEach((theme, idx) => {
             const items = groups[theme];
             const safeId = idx + '-' + theme.replace(/[^a-zA-Z0-9]/g, '');

             html += `
             <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-white dark:bg-slate-800 shadow-sm transition-all hover:shadow-md">
                <div onclick="toggleFcAccordion('${safeId}')" class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors select-none group">
                    <div class="flex items-center gap-3">
                        <span class="p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition-transform">
                            <i data-feather="folder" class="w-4 h-4"></i>
                        </span>
                        <h5 class="font-bold text-slate-700 dark:text-slate-200 uppercase text-xs tracking-wider">
                            ${theme}
                        </h5>
                        <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded text-[10px] font-bold">
                            ${items.length}
                        </span>
                    </div>
                    <svg id="chev-${safeId}" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                
                <div id="body-${safeId}" class="hidden border-t border-slate-100 dark:border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 w-10">No</th>
                                    <th class="px-6 py-3 text-right">Arab</th>
                                    <th class="px-6 py-3">Indonesia</th>
                                    <th class="px-6 py-3 text-center w-20">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${items.map((c, i) => `
                                 <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors">
                                    <td class="px-6 py-3 text-slate-400 font-bold text-xs">${i+1}</td>
                                    <td class="px-6 py-3 text-right font-arab text-lg text-emerald-600 dark:text-emerald-400">${c.ar}</td>
                                    <td class="px-6 py-3 font-medium text-slate-700 dark:text-slate-200">${c.id}</td>
                                    <td class="px-6 py-3 text-center">
                                        <button onclick="deleteFlashcard('${c.docId}')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" title="Hapus">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                 </tr> 
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
             </div>
             `;
          });

          container.innerHTML = html;
          if(typeof feather !== 'undefined') feather.replace();
      };
      
      window.toggleFcAccordion = (id) => {
          const body = document.getElementById('body-' + id);
          const chev = document.getElementById('chev-' + id);
          if(body) body.classList.toggle('hidden');
          if(chev) chev.classList.toggle('-rotate-90'); 
      };

      window.addFlashcardInline = async () => {
          const ar = document.getElementById('inNewAr'), id = document.getElementById('inNewId'), tm = document.getElementById('inNewTema');
          if(!ar.value.trim() || !id.value.trim()) return Swal.fire('Error', 'Harap isi Arab & Indonesia', 'error');
          try {
              await addDoc(collection(db, "flashcards"), { id: id.value.trim(), ar: ar.value.trim(), tema: tm.value.trim() || 'umum', createdAt: new Date().toISOString() });
              ar.value = ''; id.value = ''; tm.value = ''; ar.focus();
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      window.deleteFlashcard = async (docId) => {
          if((await Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true })).isConfirmed) {
              try { await deleteDoc(doc(db, "flashcards", docId)); } catch(e) { Swal.fire('Error', e.message, 'error'); }
          }
      };

      window.resetFlashcards = async () => {
          if(!(await Swal.fire({ title: 'Reset Default?', text: 'Hapus semua & isi 20 kata dasar?', icon: 'warning', showCancelButton: true })).isConfirmed) return;
          try {
              const snap = await getDocs(collection(db, "flashcards"));
              const batch = writeBatch(db);
              snap.forEach(d => batch.delete(d.ref));
              const defaults = [
                  { id: "Buku", ar: "ÙƒÙØªÙŽØ§Ø¨ÙŒ", tema: "umum" }, { id: "Pena", ar: "Ù‚ÙŽÙ„ÙŽÙ…ÙŒ", tema: "umum" }, 
                  { id: "Sekolah", ar: "Ù…ÙŽØ¯Ù’Ø±ÙŽØ³ÙŽØ©ÙŒ", tema: "umum" }, { id: "Guru", ar: "Ù…ÙØ¯ÙŽØ±Ù‘ÙØ³ÙŒ", tema: "umum" },
                  { id: "Murid", ar: "ØªÙÙ„Ù’Ù…ÙÙŠÙ’Ø°ÙŒ", tema: "umum" }, { id: "Kelas", ar: "ÙÙŽØµÙ’Ù„ÙŒ", tema: "umum" },
                  { id: "Tas", ar: "Ø­ÙŽÙ‚ÙÙŠÙ’Ø¨ÙŽØ©ÙŒ", tema: "umum" }, { id: "Papan Tulis", ar: "Ø³ÙŽØ¨Ù‘ÙÙˆÙ’Ø±ÙŽØ©ÙŒ", tema: "umum" },
                  { id: "Meja", ar: "Ù…ÙŽÙƒÙ’ØªÙŽØ¨ÙŒ", tema: "umum" }, { id: "Kursi", ar: "ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘ÙŒ", tema: "umum" },
                  { id: "Pintu", ar: "Ø¨ÙŽØ§Ø¨ÙŒ", tema: "umum" }, { id: "Jendela", ar: "Ù†ÙŽØ§ÙÙØ°ÙŽØ©ÙŒ", tema: "umum" },
                  { id: "Rumah", ar: "Ø¨ÙŽÙŠÙ’ØªÙŒ", tema: "umum" }, { id: "Jalan", ar: "Ø´ÙŽØ§Ø±ÙØ¹ÙŒ", tema: "umum" },
                  { id: "Mobil", ar: "Ø³ÙŽÙŠÙ‘ÙŽØ§Ø±ÙŽØ©ÙŒ", tema: "umum" }, { id: "Masjid", ar: "Ù…ÙŽØ³Ù’Ø¬ÙØ¯ÙŒ", tema: "umum" },
                  { id: "Air", ar: "Ù…ÙŽØ§Ø¡ÙŒ", tema: "umum" }, { id: "Roti", ar: "Ø®ÙØ¨Ù’Ø²ÙŒ", tema: "umum" },
                  { id: "Baju", ar: "Ø«ÙŽÙˆÙ’Ø¨ÙŒ", tema: "umum" }, { id: "Waktu", ar: "ÙˆÙŽÙ‚Ù’ØªÙŒ", tema: "umum" }
              ];
              defaults.forEach(v => batch.set(doc(collection(db, "flashcards")), { ...v, createdAt: new Date().toISOString() }));
              await batch.commit();
              Swal.fire('Berhasil', 'Data direset', 'success');
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      window.migrateVocabs = async () => {
          if(!window.VOCAB_DATA || !window.VOCAB_DATA.length) return Swal.fire('Info', 'Data lokal tidak ditemukan', 'info');
          if(!(await Swal.fire({ title: 'Migrasi Kosakata?', text: `Migrasi ${window.VOCAB_DATA.length} kosakata statis?`, icon: 'info', showCancelButton: true })).isConfirmed) return;
          try {
              const batch = writeBatch(db);
              window.VOCAB_DATA.forEach(v => {
                  batch.set(doc(collection(db, "flashcards")), { 
                      id: v.id, 
                      ar: v.ar, 
                      tema: v.tema || 'statis',
                      createdAt: new Date().toISOString() 
                  });
              });
              await batch.commit();
              Swal.fire('Berhasil', 'Kosakata dimigrasi', 'success');
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      /* -------------------------------------
         2. HARAKAT QUESTIONS LOGIC
         ------------------------------------- */
      let unsubHarakat = null;
      window.loadHarakatQuestions = () => {
          const container = document.getElementById('harakatListContainer');
          const counter = document.getElementById('harakatCount');
          if(!container) return;

          if(unsubHarakat) unsubHarakat();

          if(window.HARAKAT_DATA_CACHE && window.HARAKAT_DATA_CACHE.length === 0) {
             container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Memuat data harakat...</p>';
          }

          const q = query(collection(db, "harakat_questions"), orderBy("createdAt", "desc"));
          unsubHarakat = onSnapshot(q, (snap) => {
              const data = [];
              snap.forEach(d => data.push({ docId: d.id, ...d.data() }));
              if(counter) counter.innerText = data.length;
              
              const btnMigH = document.getElementById('btnMigrateHarakat');
              if(data.length === 0) btnMigH?.classList.remove('hidden');
              else btnMigH?.classList.add('hidden');

              window.HARAKAT_DATA_CACHE = data;
              renderHarakatAccordions(data);
          }, (err) => {
              console.error("Harakat listener error:", err);
              document.getElementById('btnMigrateHarakat')?.classList.remove('hidden');
          });
      };

      window.renderHarakatAccordions = (data) => {
          const container = document.getElementById('harakatListContainer');
          if(!container) return;
          
          if(data.length === 0) {
              container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Belum ada soal harakat.</p>';
              return;
          }

          // Group by First Letter (Abjad)
          const groups = {};
          data.forEach(item => {
             const key = (item.plain || item.word || '?').trim().charAt(0);
             if(!groups[key]) groups[key] = [];
             groups[key].push(item);
          });
          
          const sortedKeys = Object.keys(groups).sort();
          
          let html = '';
          sortedKeys.forEach((key, idx) => {
              const items = groups[key];
              const safeId = 'harakat-' + idx;
              
              html += `
              <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-white dark:bg-slate-800 shadow-sm transition-all hover:shadow-md">
                <div onclick="toggleHarakatAccordion('${safeId}')" class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors select-none group">
                    <div class="flex items-center gap-3">
                        <span class="p-2 bg-pink-50 dark:bg-pink-900/20 rounded-lg text-pink-600 dark:text-pink-400 font-arab font-bold text-lg group-hover:scale-110 transition-transform w-10 text-center">
                            ${key}
                        </span>
                        <h5 class="font-bold text-slate-700 dark:text-slate-200 uppercase text-xs tracking-wider">
                            Kelompok Huruf "${key}"
                        </h5>
                        <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded text-[10px] font-bold">
                            ${items.length}
                        </span>
                    </div>
                    <svg id="chev-${safeId}" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90 group-hover:text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="body-${safeId}" class="hidden border-t border-slate-100 dark:border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 w-10">No</th>
                                    <th class="px-6 py-3 text-right">Plain</th>
                                    <th class="px-6 py-3 text-right">Jawaban</th>
                                    <th class="px-6 py-3">Hint</th>
                                    <th class="px-6 py-3 text-center w-20">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${items.map((h, i) => `
                                 <tr class="hover:bg-pink-50/30 dark:hover:bg-pink-900/10 transition-colors">
                                    <td class="px-6 py-3 text-slate-400 font-bold text-xs">${i+1}</td>
                                    <td class="px-6 py-3 text-right font-arab text-lg text-slate-700 dark:text-slate-300">${h.plain || h.word}</td>
                                    <td class="px-6 py-3 text-right font-arab text-xl text-pink-600 dark:text-pink-400 font-bold">${h.answer}</td>
                                    <td class="px-6 py-3 font-medium text-slate-600 dark:text-slate-400 text-xs">${h.hint || '-'}</td>
                                    <td class="px-6 py-3 text-center">
                                        <button onclick="deleteHarakatQuestion('${h.docId}')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" title="Hapus">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                 </tr> 
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
              `;
          });
          container.innerHTML = html;
          if(typeof feather !== 'undefined') feather.replace();
      };
      
      window.toggleHarakatAccordion = (id) => {
          const body = document.getElementById('body-' + id);
          const chev = document.getElementById('chev-' + id);
          if(body) body.classList.toggle('hidden');
          if(chev) chev.classList.toggle('-rotate-90');
      };

      window.addHarakatInline = async () => {
          const p = document.getElementById('inNewHarakatPlain'), a = document.getElementById('inNewHarakatAns'), h = document.getElementById('inNewHarakatHint');
          if(!p.value.trim() || !a.value.trim()) return Swal.fire('Error', 'Harap isi Arab & Jawaban', 'error');
          try {
              await addDoc(collection(db, "harakat_questions"), { plain: p.value.trim(), answer: a.value.trim(), hint: h.value.trim(), createdAt: new Date().toISOString() });
              p.value = ''; a.value = ''; h.value = ''; p.focus();
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      window.deleteHarakatQuestion = async (docId) => {
          if((await Swal.fire({ title: 'Hapus Soal?', icon: 'warning', showCancelButton: true })).isConfirmed) {
              try { await deleteDoc(doc(db, "harakat_questions", docId)); } catch(e) { Swal.fire('Error', e.message, 'error'); }
          }
      };

      window.migrateHarakatData = async () => {
          if(!window.HARAKAT_GAME_DATA || !window.HARAKAT_GAME_DATA.length) return Swal.fire('Info', 'Data statis tidak ditemukan', 'info');
          if(!(await Swal.fire({ title: 'Migrasi Harakat?', text: `Migrasi ${window.HARAKAT_GAME_DATA.length} soal?`, icon: 'info', showCancelButton: true })).isConfirmed) return;
          try {
              const batch = writeBatch(db);
              window.HARAKAT_GAME_DATA.forEach(q => batch.set(doc(collection(db, "harakat_questions")), { ...q, createdAt: new Date().toISOString() }));
              await batch.commit();
              Swal.fire('Berhasil', 'Data Harakat dimigrasi', 'success');
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      /* -------------------------------------
         3. SENTENCE QUESTIONS LOGIC
         ------------------------------------- */
      let unsubSentence = null;
      window.loadSentenceQuestions = () => {
          const container = document.getElementById('sentenceListContainer');
          const counter = document.getElementById('sentenceCount');
          if(!container) return;

          if(unsubSentence) unsubSentence();
          
          if(window.SENTENCE_DATA_CACHE && window.SENTENCE_DATA_CACHE.length === 0) {
             container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Memuat data soal...</p>';
          }

          const q = query(collection(db, "sentence_questions"), orderBy("createdAt", "desc"));
          unsubSentence = onSnapshot(q, (snap) => {
              const data = [];
              snap.forEach(d => data.push({ docId: d.id, ...d.data() }));
              if(counter) counter.innerText = data.length;
              
              const btnMigS = document.getElementById('btnMigrateSentence');
              if(data.length === 0) btnMigS?.classList.remove('hidden');
              else btnMigS?.classList.add('hidden');

              window.SENTENCE_DATA_CACHE = data;
              renderSentenceAccordions(data);
          }, (err) => {
              console.error("Sentence listener error:", err);
              document.getElementById('btnMigrateSentence')?.classList.remove('hidden');
          });
      };

      window.renderSentenceAccordions = (data) => {
          const container = document.getElementById('sentenceListContainer');
          if(!container) return;
          
          if(data.length === 0) {
              container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Belum ada soal susun kalimat.</p>';
              return;
          }

          // Group by Level
          const groups = {};
          data.forEach(item => {
             const key = item.level || '1';
             if(!groups[key]) groups[key] = [];
             groups[key].push(item);
          });
          
          const sortedLevels = Object.keys(groups).sort((a,b) => parseInt(a) - parseInt(b));
          
          let html = '';
          sortedLevels.forEach((level, idx) => {
              const items = groups[level];
              const safeId = 'sentence-lvl-' + level;
              
              html += `
              <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-white dark:bg-slate-800 shadow-sm transition-all hover:shadow-md">
                <div onclick="toggleSentenceAccordion('${safeId}')" class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors select-none group">
                    <div class="flex items-center gap-3">
                        <span class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600 dark:text-blue-400 font-bold text-sm min-w-[3rem] text-center group-hover:scale-110 transition-transform">
                            Lvl ${level}
                        </span>
                        <h5 class="font-bold text-slate-700 dark:text-slate-200 uppercase text-xs tracking-wider">
                            Level ${level} - ${items.length} Soal
                        </h5>
                    </div>
                    <svg id="chev-${safeId}" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="body-${safeId}" class="hidden border-t border-slate-100 dark:border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 w-10">No</th>
                                    <th class="px-6 py-3">Judul / Pola</th>
                                    <th class="px-6 py-3 text-right">Susunan Kata</th>
                                    <th class="px-6 py-3 text-center w-20">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${items.map((s, i) => `
                                 <tr class="hover:bg-blue-50/30 dark:hover:bg-blue-900/10 transition-colors">
                                    <td class="px-6 py-3 text-slate-400 font-bold text-xs">${i+1}</td>
                                    <td class="px-6 py-3">
                                       <div class="font-bold text-slate-700 dark:text-slate-200 uppercase text-xs tracking-wider">${s.title}</div>
                                       <div class="text-[10px] text-slate-500 italic">${s.description || '-'}</div>
                                    </td>
                                    <td class="px-6 py-3 text-right">
                                       <div class="flex flex-row-reverse gap-1 justify-start flex-wrap">
                                          ${(s.correct || []).map(w => `<span class="bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 px-2 py-1 rounded text-sm font-arab border border-blue-100 dark:border-blue-800">${w}</span>`).join('')}
                                       </div>
                                    </td>
                                    <td class="px-6 py-3 text-center">
                                        <button onclick="deleteSentenceQuestion('${s.docId}')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" title="Hapus">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                 </tr> 
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
              `;
          });
          container.innerHTML = html;
          if(typeof feather !== 'undefined') feather.replace();
      };

      window.toggleSentenceAccordion = (id) => {
          const body = document.getElementById('body-' + id);
          const chev = document.getElementById('chev-' + id);
          if(body) body.classList.toggle('hidden');
          if(chev) chev.classList.toggle('-rotate-90');
      };
      
      window.addSentenceQuestion = async () => {
          const lvl = document.getElementById('sNewLevel'), title = document.getElementById('sNewTitle'), desc = document.getElementById('sNewDesc'), corr = document.getElementById('sNewCorrect');
          if(!title.value.trim() || !corr.value.trim()) return Swal.fire('Error', 'Harap isi Judul & Susunan Kata', 'error');
          
          const words = corr.value.split(',').map(w => w.trim()).filter(w => w !== "");
          if(words.length < 2) return Swal.fire('Error', 'Susunan kata minimal 2 kata dipisah koma', 'error');

          try {
              await addDoc(collection(db, "sentence_questions"), { 
                  level: parseInt(lvl.value) || 1, 
                  title: title.value.trim(), 
                  description: desc.value.trim(), 
                  correct: words,
                  createdAt: new Date().toISOString() 
              });
              lvl.value = ''; title.value = ''; desc.value = ''; corr.value = ''; title.focus();
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      window.deleteSentenceQuestion = async (docId) => {
          if((await Swal.fire({ title: 'Hapus Soal?', icon: 'warning', showCancelButton: true })).isConfirmed) {
              try { await deleteDoc(doc(db, "sentence_questions", docId)); } catch(e) { Swal.fire('Error', e.message, 'error'); }
          }
      };

      window.migrateSentenceData = async () => {
          if(!window.SENTENCE_GAME_DATA || !window.SENTENCE_GAME_DATA.length) return Swal.fire('Info', 'Data statis tidak ditemukan', 'info');
          if(!(await Swal.fire({ title: 'Migrasi Susun Kalimat?', text: `Migrasi ${window.SENTENCE_GAME_DATA.length} soal?`, icon: 'info', showCancelButton: true })).isConfirmed) return;
          try {
              const batch = writeBatch(db);
              window.SENTENCE_GAME_DATA.forEach(q => {
                  const { id, ...rest } = q;
                  batch.set(doc(collection(db, "sentence_questions")), { ...rest, createdAt: new Date().toISOString() });
              });
              await batch.commit();
              Swal.fire('Berhasil', 'Data Susun Kalimat dimigrasi', 'success');
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      /* -------------------------------------
         4. GRAMMAR QUESTIONS LOGIC
         ------------------------------------- */
      let unsubGrammar = null;
      window.loadGrammarQuestions = () => {
          const container = document.getElementById('grammarGameListContainer');
          const counter = document.getElementById('grammarCount');
          if(!container) return;

          if(unsubGrammar) unsubGrammar();

          if(window.GRAMMAR_DATA_CACHE && window.GRAMMAR_DATA_CACHE.length === 0) {
             container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Memuat data grammar...</p>';
          }

          const q = query(collection(db, "grammar_questions"), orderBy("createdAt", "desc"));
          unsubGrammar = onSnapshot(q, (snap) => {
              const data = [];
              snap.forEach(d => data.push({ docId: d.id, ...d.data() }));
              if(counter) counter.innerText = data.length;
              
              const btnMigG = document.getElementById('btnMigrateGrammar');
              if(data.length === 0) btnMigG?.classList.remove('hidden');
              else btnMigG?.classList.add('hidden');

              window.GRAMMAR_DATA_CACHE = data;
              renderGrammarAccordions(data);
          }, (err) => {
              console.error("Grammar listener error:", err);
              document.getElementById('btnMigrateGrammar')?.classList.remove('hidden');
          });
      };

      window.renderGrammarAccordions = (data) => {
          const container = document.getElementById('grammarGameListContainer');
          if(!container) return;
          
          if(data.length === 0) {
              container.innerHTML = '<p class="text-center text-slate-400 italic py-10">Belum ada kosakata grammar.</p>';
              return;
          }

          // Group by Type
          const groups = {};
          data.forEach(item => {
             const key = item.type || 'isim';
             if(!groups[key]) groups[key] = [];
             groups[key].push(item);
          });
          
          const typeLabels = {
              'isim': 'Isim (Kata Benda)',
              'fiil': 'Fi\'il (Kata Kerja)',
              'harf': 'Harf (Huruf)'
          };
          
          const sortedKeys = ['isim', 'fiil', 'harf'].filter(k => groups[k]); // predefined order
          // Add others if any
          Object.keys(groups).forEach(k => {
              if(!sortedKeys.includes(k)) sortedKeys.push(k);
          });
          
          let html = '';
          sortedKeys.forEach((key, idx) => {
              const items = groups[key];
              const safeId = 'grammar-' + key;
              const label = typeLabels[key] || key.toUpperCase();
              
              html += `
              <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-white dark:bg-slate-800 shadow-sm transition-all hover:shadow-md">
                <div onclick="toggleGrammarAccordion('${safeId}')" class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors select-none group">
                    <div class="flex items-center gap-3">
                        <span class="p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-indigo-600 dark:text-indigo-400 font-bold text-sm min-w-[3rem] text-center group-hover:scale-110 transition-transform uppercase">
                            ${key.substring(0,2)}
                        </span>
                        <h5 class="font-bold text-slate-700 dark:text-slate-200 uppercase text-xs tracking-wider">
                            ${label}
                        </h5>
                        <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded text-[10px] font-bold">
                            ${items.length}
                        </span>
                    </div>
                    <svg id="chev-${safeId}" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400 transition-transform duration-300 transform -rotate-90 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="body-${safeId}" class="hidden border-t border-slate-100 dark:border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 w-10">No</th>
                                    <th class="px-6 py-3 text-right">Kata (Arab)</th>
                                    <th class="px-6 py-3 text-center w-20">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${items.map((g, i) => `
                                 <tr class="hover:bg-indigo-50/30 dark:hover:bg-indigo-900/10 transition-colors">
                                    <td class="px-6 py-3 text-slate-400 font-bold text-xs">${i+1}</td>
                                    <td class="px-6 py-3 text-right font-arab text-xl text-slate-700 dark:text-slate-300">${g.word}</td>
                                    <td class="px-6 py-3 text-center">
                                        <button onclick="deleteGrammarQuestion('${g.docId}')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" title="Hapus">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                 </tr> 
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
              `;
          });
          container.innerHTML = html;
          if(typeof feather !== 'undefined') feather.replace();
      };
      
      window.toggleGrammarAccordion = (id) => {
          const body = document.getElementById('body-' + id);
          const chev = document.getElementById('chev-' + id);
          if(body) body.classList.toggle('hidden');
          if(chev) chev.classList.toggle('-rotate-90');
      };

      window.addGrammarQuestion = async () => {
          const word = document.getElementById('gNewWord'), type = document.getElementById('gNewType');
          if(!word.value.trim()) return Swal.fire('Error', 'Harap isi kosa kata', 'error');
          try {
              await addDoc(collection(db, "grammar_questions"), { 
                  word: word.value.trim(), 
                  type: type.value, 
                  createdAt: new Date().toISOString() 
              });
              word.value = ''; word.focus();
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      window.deleteGrammarQuestion = async (docId) => {
          if((await Swal.fire({ title: 'Hapus Soal?', icon: 'warning', showCancelButton: true })).isConfirmed) {
              try { await deleteDoc(doc(db, "grammar_questions", docId)); } catch(e) { Swal.fire('Error', e.message, 'error'); }
          }
      };

      window.migrateGrammarData = async () => {
          if(!window.GAME_DATA || !window.GAME_DATA.length) return Swal.fire('Info', 'Data statis tidak ditemukan', 'info');
          if(!(await Swal.fire({ title: 'Migrasi Grammar?', text: `Migrasi ${window.GAME_DATA.length} soal?`, icon: 'info', showCancelButton: true })).isConfirmed) return;
          try {
              const batch = writeBatch(db);
              window.GAME_DATA.forEach(q => {
                  batch.set(doc(collection(db, "grammar_questions")), { ...q, createdAt: new Date().toISOString() });
              });
              await batch.commit();
              Swal.fire('Berhasil', 'Data Grammar dimigrasi', 'success');
          } catch(e) { Swal.fire('Error', e.message, 'error'); }
      };

      /* -------------------------------------
         5. SEARCH & INIT
         ------------------------------------- */
      document.getElementById('searchFlashcard')?.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = window.allFlashcards.filter(c => (c.id && c.id.toLowerCase().includes(term)) || (c.ar && c.ar.includes(term)) || (c.tema && c.tema.toLowerCase().includes(term)));
          renderFlashcards(filtered);
      });

      // Initialization - Load all game data for counters
      window.loadFlashcards();
      window.loadHarakatQuestions();
      window.loadSentenceQuestions();
      window.loadGrammarQuestions();
  </script>

  </script>

  <!-- JS DARK MODE -->
  <script>
    const html = document.documentElement;
    const toggle = document.getElementById("darkToggle");

    // cek preferensi awal
    if (localStorage.theme === "dark") {
      html.classList.add("dark");
      toggle.textContent = "â˜€ï¸";
    }

    // toggle klik
    toggle.addEventListener("click", () => {
      html.classList.toggle("dark");

      if (html.classList.contains("dark")) {
        localStorage.theme = "dark";
        toggle.textContent = "â˜€ï¸";
      } else {
        localStorage.theme = "light";
        toggle.textContent = "ðŸŒ™";
      }
    });
  </script>

  <!-- Aktifkan mode global (1 angka untuk seluruh situs) -->
  <script>
    window.PRESENCE_OPTIONS = { mode: "global" };
  </script>

  <!-- Panggil script presence -->
  <script type="module" src="./assets/presence.js"></script>


  <script type="module" src="./assets/discussion.js"></script>

</body>

</html>