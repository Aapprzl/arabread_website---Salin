<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Migrate Grammar Data</title>
</head>
<body>
    <h1>Migrate Grammar Data to Firestore</h1>
    <button id="btnMigrate" style="padding: 20px; font-size: 20px;">START MIGRATION</button>
    <div id="status"></div>

    <!-- Load Bank Materi -->
    <script src="assets/data/bank-materi.js"></script>

    <!-- Configure Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { firebaseConfig } from "./assets/js/firebase-config.js"; // Assuming this exists or I need to inline config from dashboard

        // Try to import config, if fails, I'll need to copy paste it from dashboard or use what I know
        // Since I can't easily rely on relative import of config if it's not exported as module in a file...
        // I will copy the config from dashboard-guru.html logic if needed.
        // Actually dashboard-guru.html has the config INLINE.
        // I will Paste the config here to be safe.
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.getElementById('btnMigrate').addEventListener('click', async () => {
            const status = document.getElementById('status');
            status.innerText = "Starting...";

            try {
                const batch = writeBatch(db);
                
                // 1. Migrate Missions (Tahap)
                // We combine 'tahap' metadata with the actual lessons
                
                for (const tahap of BANK_MATERI.tahap) {
                    const lessons = BANK_MATERI.pelajaran
                        .filter(p => p.tahap === tahap.id)
                        .sort((a,b) => a.urutan - b.urutan);
                    
                    // Create Mission Document
                    // ID: t1, t2, t3
                    const docRef = doc(db, "grammar_missions", tahap.id);
                    
                    const data = {
                        urutan: parseInt(tahap.id.replace('t', '')), // 1, 2, 3
                        judul_misi: tahap.judul_id, // "Mengenal Kata"
                        sub_judul: tahap.judul_ar + " (" + tahap.deskripsi + ")", 
                        // Wait, UI shows: "Misi 1: Jenis Kata" (h3) and "Isim, Fi'il, & Harf" (p)
                        // In HTML row 80: "Misi 1: Jenis Kata"
                        // In HTML row 81: "Isim, Fi'il, & Harf"
                        
                        // In bank-materi.js:
                        // t1 title: "Mengenal Kata"
                        // t1 desc: "Mengenal jenis-jenis kata..."
                        // Wait, the HTML hardcoded text DOES NOT MATCH bank-materi.js EXACTLY?
                        // HTML: "Misi 1: Jenis Kata", "Isim, Fi'il, & Harf"
                        // JS: "Mengenal Kata", "Mengenal jenis-jenis kata..."
                        
                        // I MUST PRESERVE VISUALS. So I should use the HTML text ??
                        // User said "tampilan sama 100%".
                        // Use the HTML text for the initial migration if possible, or update bank-materi.js to match?
                        // Or Just hardcode the initial data in the script to match HTML.
                        
                        icon: "üß±", // Default, needed for t1
                    };

                    // Manual Override to match HTML exactly
                    if(tahap.id === 't1') {
                        data.judul_misi = "Misi 1: Jenis Kata";
                        data.sub_judul = "Isim, Fi'il, & Harf";
                        data.icon = "üß±";
                    } else if(tahap.id === 't2') {
                        data.judul_misi = "Misi 2: Menyusun";
                        data.sub_judul = "Membuat Kalimat";
                        data.icon = "üèóÔ∏è";
                    } else if(tahap.id === 't3') {
                        data.judul_misi = "Misi 3: Rasa Bahasa";
                        data.sub_judul = "Memahami Makna";
                        data.icon = "‚ú®";
                    }

                    // Add Lessons JSON
                    data.lessons = lessons;

                    batch.set(docRef, data);
                    status.innerHTML += `<br>Prepared batch for ${tahap.id}`;
                }

                await batch.commit();
                status.innerHTML += "<br><b>SUCCESS! All data uploaded.</b>";

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
            }
        });
    </script>
</body>
</html>
